// generated by Fast Light User Interface Designer (fluid) version 1.0103
#include "OPTISGui.h"

inline void OPTISGui::cb_LEDViewer_i(Fl_Double_Window*, void*) {
//  if (modflag)
//    switch (fl_choice("Save changes before exiting?", "Cancel", "No", "Yes"))
//    {
//      case 0 : /* Cancel */
//          return;
//      case 2 : /* Yes */
//          save_cb(NULL, NULL);
//	  if (modflag) return;	// Didn't save!
//    }
close();
exit(0);
}
void OPTISGui::cb_LEDViewer(Fl_Double_Window* o, void* v) {
  ((OPTISGui*)(o->user_data()))->cb_LEDViewer_i(o,v);
}

inline void OPTISGui::cb_FileNewPatient_i(Fl_Menu_*, void*) {
  char st[20];
time_t t;
Scanfile *oldscan;

oldscan = scnfile;
scnfile = new Scanfile;
patientGeladen = 0;

PatientName->value("");
PatientFirstName->value("");
PatientAnatomy->value("");
t = time(NULL);
switch (pref->dateType)
{
   case 1:
      iPatDMY->setonly();
      strftime(&st[0], 20, "%d.%m.%Y", localtime(&t));
      break;
   case 2:
      iPatYMD->setonly();
      strftime(&st[0], 20, "%Y.%m.%d", localtime(&t));
      break;
   case 3:
      iPatMDY->setonly();
      strftime(&st[0], 20, "%m.%d.%Y", localtime(&t));
      break;
}
PatientRecordingDate->value(&st[0]);
PatientRemarks->value("");
PatientScanFileName->value("");
patInputFileBase->value("");
PatientScanPath->value("");
PatientDataPath->value("");
PatientCancel->label("Cancel");
initPatient();

while (PatientWindow->visible())
   Fl::wait();

if (!patientGeladen)
{
   delete scnfile;
   scnfile = oldscan;
}
else
{
   delete oldscan;
   reset();
   numLEDs = 6;
   numCamSys = 1;
   numCams = 3;

   AnimStart->deactivate();
   AnimStop->deactivate();
   AnimOneFwd->deactivate();
   AnimOneBwd->deactivate();
   AnimPlayBwd->deactivate();
   AnimReset->deactivate();
   AnimStoreAnim->deactivate();
   MotionNameOutput->value(&nomotiontxt[0]);

   insertFOV();
};
}
void OPTISGui::cb_FileNewPatient(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_FileNewPatient_i(o,v);
}

inline void OPTISGui::cb_FileExportTrajectories_i(Fl_Menu_*, void*) {
  ObjectData *tmpdata;
int i;
char st[256], tst[256];
char *p;

i = 0;
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   if ((tmpdata->type>=200)&&(tmpdata->type<=220))


      i++;
   tmpdata = tmpdata->next;
}

if (i == 0)
   return;

sprintf(st, "%s/", scnfile->scandir);
p = fl_file_chooser("Export Trajectories: Enter Directory and File Name", "*.xls", 
    &st[0]);
if (p == NULL)
   return;

i = 0;
tmpdata = objview->objlist;
while (tmpdata != NULL)
{


   if (((tmpdata->type%1000)>=200)&&((tmpdata->type%1000)<=220))
   {
      if (((tmpdata->type%1000)<220)&&(mainAnimation->num_steps > 0))
         tmpdata->point = mainAnimation->led[(tmpdata->type%1000)-200+(18*(tmpdata->type/1000))][0];
      objview->getLabel(tmpdata, &tst[0]);
      if (i == 0)
         sprintf(st, "%s %s, %s, %s, %s", scnfile->name, scnfile->firstname,
            scnfile->anatomy, scnfile->date, mainAnimation->comment);
      mainAnimation->exportTrajectories(tmpdata->point, p, i, &tst[0], &st[0],
        tmpdata->camSys, tmpdata->motionOfObject, tmpdata->reference,
        tmpdata->startStep, tmpdata->stopStep,(tmpdata->type%1000),tmpdata->type,&tmpdata->point_leds[0]);
      i++;
   }
   tmpdata = tmpdata->next;
};
}
void OPTISGui::cb_FileExportTrajectories(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_FileExportTrajectories_i(o,v);
}

inline void OPTISGui::cb_sgiSnapshot_i(Fl_Menu_*, void*) {
  sprintf(imgFormat, "sgi");
recBase = fl_file_chooser("Snapshot: Enter Directory and File Name (without Extension)", "*.sgi", NULL);
if (recBase != NULL)
   objview->saveImage(recBase, &imgFormat[0], -1, pref->imgcopy, pref->extracode);
}
void OPTISGui::cb_sgiSnapshot(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_sgiSnapshot_i(o,v);
}

inline void OPTISGui::cb_tifSnapshot_i(Fl_Menu_*, void*) {
  sprintf(imgFormat, "tif");
recBase = fl_file_chooser("Snapshot: Enter Directory and File Name (without Extension)", "*.tif", NULL);
if (recBase != NULL)
   objview->saveImage(recBase, &imgFormat[0], -1, pref->imgcopy, pref->extracode);
}
void OPTISGui::cb_tifSnapshot(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_tifSnapshot_i(o,v);
}

inline void OPTISGui::cb_gifSnapshot_i(Fl_Menu_*, void*) {
  sprintf(imgFormat, "gif");
recBase = fl_file_chooser("Snapshot: Enter Directory and File Name (without Extension)", "*.gif", NULL);
if (recBase != NULL)
   objview->saveImage(recBase, &imgFormat[0], -1, pref->imgcopy, pref->extracode);
}
void OPTISGui::cb_gifSnapshot(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_gifSnapshot_i(o,v);
}

inline void OPTISGui::cb_jpgSnapshot_i(Fl_Menu_*, void*) {
  sprintf(imgFormat, "jpg");
recBase = fl_file_chooser("Snapshot: Enter Directory and File Name (without Extension)", "*.jpg", NULL);
if (recBase != NULL)
   objview->saveImage(recBase, &imgFormat[0], -1, pref->imgcopy, pref->extracode);
}
void OPTISGui::cb_jpgSnapshot(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_jpgSnapshot_i(o,v);
}

inline void OPTISGui::cb_otherSnapshot_i(Fl_Menu_*, void*) {
  const char *format;
char st[10];

format = fl_input("Snapshot: Specifie the File Format", &imgFormat[0]);
if (format == NULL)
   return;
if (strlen(format) > 9)
{
   fl_message("Invalid File Format");
   return;
}
sprintf(imgFormat, "%s", format);
sprintf(st, "*.%s", format);
recBase = fl_file_chooser("Snapshot: Enter Directory and File Name (without Extension)", &st[0], NULL);
if (recBase != NULL)
   objview->saveImage(recBase, &imgFormat[0], -1, pref->imgcopy, pref->extracode);
}
void OPTISGui::cb_otherSnapshot(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_otherSnapshot_i(o,v);
}

inline void OPTISGui::cb_FileClose_i(Fl_Menu_*, void*) {
  close();
exit(0);
}
void OPTISGui::cb_FileClose(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_FileClose_i(o,v);
}

inline void OPTISGui::cb_EditSubject_i(Fl_Menu_*, void*) {
  insertValues();
PatientCancel->label("Cancel");
initPatient();
}
void OPTISGui::cb_EditSubject(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_EditSubject_i(o,v);
}

inline void OPTISGui::cb_EditObjects_i(Fl_Menu_*, void*) {
  ObjectData *tmpdata;

tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   objview->getLabel(tmpdata,&tmpdata->oldlabel[0]);
   tmpdata->olddrawstyle->copyFieldValues(tmpdata->drawstyle, FALSE);
   tmpdata->oldmaterial->copyFieldValues(tmpdata->material, FALSE);
   tmpdata->oldanimated = tmpdata->animated;
   tmpdata->oldpseudo = tmpdata->pseudo;
   tmpdata = tmpdata->next;
}
setObjectEditorObjects();
EditLEDViewer->show();
}
void OPTISGui::cb_EditObjects(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_EditObjects_i(o,v);
}

//radius setup
inline void OPTISGui::cb_LedR05_i(Fl_Menu_*, void*) {
  ledRadius = 0.5;
resetLEDs();
}
void OPTISGui::cb_LedR05(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR05_i(o,v);
}

inline void OPTISGui::cb_LedR10_i(Fl_Menu_*, void*) {
  ledRadius = 1.0;
resetLEDs();
}
void OPTISGui::cb_LedR10(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR10_i(o,v);
}

inline void OPTISGui::cb_LedR15_i(Fl_Menu_*, void*) {
  ledRadius = 1.5;
resetLEDs();
}
void OPTISGui::cb_LedR15(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR15_i(o,v);
}

inline void OPTISGui::cb_LedR20_i(Fl_Menu_*, void*) {
  ledRadius = 2.0;
resetLEDs();
}
void OPTISGui::cb_LedR20(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR20_i(o,v);
}

inline void OPTISGui::cb_LedR25_i(Fl_Menu_*, void*) {
  ledRadius = 2.5;
resetLEDs();
}
void OPTISGui::cb_LedR25(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR25_i(o,v);
}

inline void OPTISGui::cb_LedR30_i(Fl_Menu_*, void*) {
  ledRadius = 3.0;
resetLEDs();
}
void OPTISGui::cb_LedR30(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR30_i(o,v);
}

inline void OPTISGui::cb_LedR40_i(Fl_Menu_*, void*) {
  ledRadius = 4.0;
resetLEDs();
}
void OPTISGui::cb_LedR40(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR40_i(o,v);
}

inline void OPTISGui::cb_LedR50_i(Fl_Menu_*, void*) {
  ledRadius = 5.0;
resetLEDs();
}
void OPTISGui::cb_LedR50(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR50_i(o,v);
}

inline void OPTISGui::cb_LedR60_i(Fl_Menu_*, void*) {
  ledRadius = 6.0;
resetLEDs();
}
void OPTISGui::cb_LedR60(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR60_i(o,v);
}

inline void OPTISGui::cb_LedR70_i(Fl_Menu_*, void*) {
  ledRadius = 7.0;
resetLEDs();
}
void OPTISGui::cb_LedR70(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR70_i(o,v);
}

inline void OPTISGui::cb_LedR80_i(Fl_Menu_*, void*) {
  ledRadius = 8.0;
resetLEDs();
}
void OPTISGui::cb_LedR80(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR80_i(o,v);
}

inline void OPTISGui::cb_LedR90_i(Fl_Menu_*, void*) {
  ledRadius = 9.0;
resetLEDs();
}
void OPTISGui::cb_LedR90(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR90_i(o,v);
}

inline void OPTISGui::cb_LedR100_i(Fl_Menu_*, void*) {
  ledRadius = 10.0;
resetLEDs();
}
void OPTISGui::cb_LedR100(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_LedR100_i(o,v);
}

inline void OPTISGui::cb_EditTrajectories_i(Fl_Menu_*, void*) {
  ObjectData *tmpdata;
char st[256];
int i = 0;

deActivateCamSystemChoice(numCamSys);
TrajectoryName->hide();
LEDNameChoice->hide();
Tbtn_ok->hide();
Tbtn_ok3->hide();
Tbtn_cancel->hide();
TrajNameChoice->show();
TrajNameChoice->clear();
Tbtn_del->show();
Tbtn_ok2->show();
Tbtn_cancel2->show();
XCoord->activate();
YCoord->activate();
ZCoord->activate();
TrajCamSysChoice->activate();


tmpdata = objview->objlist;
while (tmpdata != NULL) 
{
//   if (((tmpdata->type%1000) >= 200) && ((tmpdata->type%1000) <= 220))
   if ((((tmpdata->type%1000) >= 200) && ((tmpdata->type%1000) <= 220))||((tmpdata->type%1000) == 222))
   {
      objview->getLabel(tmpdata, &st[0]);
      TrajNameChoice->add(&st[0], 0, 0, 0, 0);
      i++;
      tmpdata->oldpoint = tmpdata->point;
      tmpdata->oldStart = tmpdata->startStep;
      tmpdata->oldStop = tmpdata->stopStep;
      tmpdata->oldCamSys = tmpdata->camSys;
   }
   tmpdata = tmpdata->next;
}

if (i == 0)
   return;

tmpdata = objview->objlist;
//while ((tmpdata != NULL)&& (((tmpdata->type%1000) < 200) || ((tmpdata->type%1000) > 220)))
while ((tmpdata != NULL)&& (((tmpdata->type%1000) < 200) || ((tmpdata->type%1000) > 222) || ((tmpdata->type%1000) == 221)))
   tmpdata = tmpdata->next;
XCoord->value(tmpdata->point[0]);
YCoord->value(tmpdata->point[1]);
ZCoord->value(tmpdata->point[2]);
FirstStep->value(tmpdata->startStep+1);
LastStep->value(tmpdata->stopStep+1);
TotalSteps->value(mainAnimation->num_steps);
TrajNameChoice->value(0);
TrajCamSysChoice->value(tmpdata->camSys);

if (((tmpdata->type%1000)>199)&&((tmpdata->type%1000)<218)||((tmpdata->type%1000)==222))
   {
      TrajObjChoice->deactivate();
      TrajRefChoice->deactivate();
   }
else
   {
      TrajObjChoice->activate();
      TrajRefChoice->activate();
   }
if ((tmpdata->type%1000)==222) //070108
   {
      TrajObjChoice->deactivate();
      TrajRefChoice->deactivate();
   }

TrajObjChoice->value(tmpdata->motionOfObject+1);
TrajRefChoice->value(tmpdata->reference+1);



oldTrajChoice = 0;
TrajectoryWindow->position(
   LEDViewer->x()+((LEDViewer->w()-TrajectoryWindow->w())/2),
   LEDViewer->y()+((LEDViewer->h()-TrajectoryWindow->h())/2));
TrajectoryWindow->show();
}
void OPTISGui::cb_EditTrajectories(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_EditTrajectories_i(o,v);
}

inline void OPTISGui::cb_EditBackGroundColor_i(Fl_Menu_*, void*) {
  double r, g, b;
int ok;

r = objview->backgroundcolor[0];
g = objview->backgroundcolor[1];
b = objview->backgroundcolor[2];
ok = fl_color_chooser("Background Color", r, g, b);
if (ok)
{
   objview->backgroundcolor[0] = r;
   objview->backgroundcolor[1] = g;
   objview->backgroundcolor[2] = b;
   objview->scenemanager->setBackgroundColor(
     SbColor(objview->backgroundcolor[0],
     objview->backgroundcolor[1], objview->backgroundcolor[2]));
   objview->redraw();
};
}
void OPTISGui::cb_EditBackGroundColor(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_EditBackGroundColor_i(o,v);
}

inline void OPTISGui::cb_EditPreferences_i(Fl_Menu_*, void*) {
  char cmd[256];
float         fr, fg, fb;
unsigned char ur, ug, ub;

fr = 255.0 * pref->LEDViewerColor[0];
ur = (unsigned char) fr;
fg = 255.0 * pref->LEDViewerColor[1];
ug = (unsigned char) fg;
fb = 255.0 * pref->LEDViewerColor[2];
ub = (unsigned char) fb;
OldColorBox->r = ur;
OldColorBox->g = ug;
OldColorBox->b = ub;
newPrefColor.setValue(objview->backgroundcolor[0],
   objview->backgroundcolor[1], objview->backgroundcolor[2]);
fr = 255.0 * objview->backgroundcolor[0];
ur = (unsigned char) fr;
fg = 255.0 * objview->backgroundcolor[1];
ug = (unsigned char) fg;
fb = 255.0 * objview->backgroundcolor[2];
ub = (unsigned char) fb;
NewColorBox->r = ur;
NewColorBox->g = ug;
NewColorBox->b = ub;
wigWidth->value(objview->w());
wigHeight->value(objview->h());
wigXPos->value(LEDViewer->x());
wigYPos->value(LEDViewer->y());
PrefWindow->position(
   LEDViewer->x()+((LEDViewer->w()-PrefWindow->w())/2),
   LEDViewer->y()+((LEDViewer->h()-PrefWindow->h())/2));
inputScanPath->value(pref->getscanpath());
inputDataPath->value(pref->getdatapath());
inputImgCopy->value(pref->imgcopy);
inputExtraCode->value(pref->extracode);
inputSocketPort->value(pref->socketPort);
inputSocketHost->value(pref->socketHost);
sprintf(cmd, "%s image.sgi %simage.jpg", inputImgCopy->value(),
        inputExtraCode->value());
outputImgCopy->value(&cmd[0]);
LEDOkay->value(pref->LEDwarningYellow+1);
LEDVisible->value(pref->LEDwarningRed+1);
//LEDWeakly->value(pref->LEDerror+1);
LEDWeakly->value(pref->LEDwarningRedRed+1);
inputOPTISController->value(pref->optisController);
inputTempDir->value(pref->optisTempDir);

PrefWindow->show();
}
void OPTISGui::cb_EditPreferences(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_EditPreferences_i(o,v);
}

inline void OPTISGui::cb_ViewLoad_i(Fl_Menu_*, void*) {
  char *fn;
char st[256];

if (scnfile != NULL)
{
   sprintf(st, "%s/", scnfile->scandir);
   fn = fl_file_chooser("Load View: Enter Directory and File Name", "*.vws", &st[0]);
}
else
   fn = fl_file_chooser("Load View: Enter Directory and File Name", "*.vws", NULL);
if (fn != NULL)
   pref->readViewFile(fn, objview->perspCamera, objview->headlight);
objview->redraw();
}
void OPTISGui::cb_ViewLoad(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_ViewLoad_i(o,v);
}

inline void OPTISGui::cb_ViewSaveAs_i(Fl_Menu_*, void*) {
  char *fn;
char st[256];

if (scnfile != NULL)
{
   sprintf(st, "%s/", scnfile->scandir);
   fn = fl_file_chooser("Save View: Enter Directory and File Name", "*.vws", &st[0]);
}
else
   fn = fl_file_chooser("Save View: Enter Directory and File Name", "*.vws", NULL);
if (fn != NULL)
   pref->writeViewFile(fn, objview->perspCamera, objview->headlight);
}
void OPTISGui::cb_ViewSaveAs(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_ViewSaveAs_i(o,v);
}

inline void OPTISGui::cb_RSFOV_i(Fl_Menu_*, void*) {
  SbVec3d vd1, vd2, vd3, vd4, testvec, tmp1;
SdMatrix md, m1;
int i, num, type, camsysnr, oldRSnr;
ObjectData *tmpdata;

mainAnimation->setRSnr(-1);
testvec.setValue(-120.0, -120.0, -120.0);
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camsysnr = tmpdata->type/1000;
   if ((type >= 200)&&(type < 220))
   {
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      for (i=0; i<num; i++)
      {
         vd1 = mainAnimation->led[18*camsysnr+type-200][i+tmpdata->startStep];
         vd2 = mainAnimation->led[18*camsysnr+type-200][i+1+tmpdata->startStep];
         if ((vd1 == testvec) || (vd2 == testvec))
         {
            vd1 = vd2 = testvec;
         }
         tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
         tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
      }
   }
//   if (type == 220)
   if (type == 220 && tmpdata->reference == -1) //070105
   {
      oldRSnr = mainAnimation->RSnr;
      mainAnimation->setRSnr(tmpdata->reference);
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      for (i=0; i<num; i++)
      {
         mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
         mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd1);
         md = mainAnimation->fov_trafo[camsysnr].inverse();
         md.multMatrixVec(vd1, vd3);
         mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
         mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd2);
         md = mainAnimation->fov_trafo[camsysnr].inverse();
         md.multMatrixVec(vd2, vd4);
         vd1 = vd3;
         vd2 = vd4;
         tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
         tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
      }
      mainAnimation->setRSnr(oldRSnr);
   }
   else if (type == 220 && tmpdata->reference > -1) //070105
   {
         mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
         m1 = mainAnimation->mRefRefSys[0].inverse();
         m1.multMatrixVec(tmpdata->point, tmp1);

      oldRSnr = mainAnimation->RSnr;
      mainAnimation->setRSnr(tmpdata->reference);
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      for (i=0; i<num; i++)
      {
         mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
         mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd1);
         md = mainAnimation->fov_trafo[camsysnr].inverse();
         md.multMatrixVec(vd1, vd3);
         mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
         mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd2);
         md = mainAnimation->fov_trafo[camsysnr].inverse();
         md.multMatrixVec(vd2, vd4);
         vd1 = vd3;
         vd2 = vd4;
         tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
         tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
      }
      mainAnimation->setRSnr(oldRSnr);
   }
   tmpdata = tmpdata->next;
}

if (mainAnimation != NULL)
   applyMotion(1);
else
   objview->redraw();
mainAnimation->RSsysnr =-1;
oldRSsysnr = mainAnimation->RSsysnr;
}
void OPTISGui::cb_RSFOV(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_RSFOV_i(o,v);
}

inline void OPTISGui::cb_RSObj1_i(Fl_Menu_*, void*) {
  SbVec3d vd1, vd2, testvec, tmp1;
SdMatrix md;
SdMatrix m1;
int i, num, type, camsysnr;;
ObjectData *tmpdata;

testvec.setValue(-120.0, -120.0, -120.0);
num = 0;
for (i=0; i<18; i++)
{
   if (mainAnimation->LEDofObject[0][i] == 0)
   { 
      if (mainAnimation->led[i][0] != testvec)
         num++;
   }
}
if (num < 3)
   return;

mainAnimation->setRSnr(0);
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camsysnr = tmpdata->type/1000;
//   if (type == 220)
   if (type == 220 && tmpdata->reference == -1) //070105
   {
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmpdata->point;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }
   else if (type == 220 && tmpdata->reference > -1) //070105
   {
         mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
         m1 = mainAnimation->mRefRefSys[0].inverse();
         m1.multMatrixVec(tmpdata->point, tmp1);
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmp1;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;   
   }
   if ((type >= 200)&&(type < 220))
   {
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      for (i=0; i<num; i++)
      {
         vd1 = mainAnimation->led[18*camsysnr+type-200][i+tmpdata->startStep];
         vd2 = mainAnimation->led[18*camsysnr+type-200][i+1+tmpdata->startStep];
         if ((vd1 == testvec) || (vd2 == testvec))
         {
            vd1 = vd2 = testvec;
         }
         else
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i
	    +tmpdata->startStep], vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i
	    +tmpdata->startStep+1], vd2);
         }
         tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
         tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
      }
   }
   tmpdata = tmpdata->next;
}

if (mainAnimation != NULL)
   applyMotion(1);
else
   objview->redraw();
mainAnimation->RSsysnr =0;
oldRSsysnr = mainAnimation->RSsysnr;
}
void OPTISGui::cb_RSObj1(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_RSObj1_i(o,v);
}

inline void OPTISGui::cb_RSObj2_i(Fl_Menu_*, void*) {
  SbVec3d vd1, vd2, testvec, tmp1;
SdMatrix md, m1;
int i, num, type, camsysnr;;
ObjectData *tmpdata;

testvec.setValue(-120.0, -120.0, -120.0);
num = 0;
for (i=0; i<18; i++)
{
   if (mainAnimation->LEDofObject[0][i] == 1)
   { 
      if (mainAnimation->led[i][0] != testvec)
         num++;
   }
}
if (num < 3)
   return;

mainAnimation->setRSnr(1);
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camsysnr = tmpdata->type/1000;
//   if (type == 220)
   if (type == 220 && tmpdata->reference == -1) //070105
   {
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point , vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmpdata->point;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }
   else if (type == 220 && tmpdata->reference > -1) //070105
   {
         mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
         m1 = mainAnimation->mRefRefSys[0].inverse();
         m1.multMatrixVec(tmpdata->point, tmp1);
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)

      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1 , vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmp1;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }

   if ((type >= 200)&&(type < 220))
   {
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      for (i=0; i<num; i++)
      {
         vd1 = mainAnimation->led[18*camsysnr+type-200][i+tmpdata->startStep];
         vd2 = mainAnimation->led[18*camsysnr+type-200][i+1+tmpdata->startStep];
         if ((vd1 == testvec) || (vd2 == testvec))
         {
            vd1 = vd2 = testvec;
         }
         else
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep], vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep+1], vd2);
         }
         tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
         tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
      }
   }
   tmpdata = tmpdata->next;
}

if (mainAnimation != NULL)
   applyMotion(1);
else
   objview->redraw();
mainAnimation->RSsysnr =1;
oldRSsysnr = mainAnimation->RSsysnr;
}
void OPTISGui::cb_RSObj2(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_RSObj2_i(o,v);
}

inline void OPTISGui::cb_RSObj3_i(Fl_Menu_*, void*) {
  SbVec3d vd1, vd2, testvec, tmp1;
SdMatrix md, m1;
int i, num, type, camsysnr;;
ObjectData *tmpdata;

testvec.setValue(-120.0, -120.0, -120.0);
num = 0;
for (i=0; i<18; i++)
{
   if (mainAnimation->LEDofObject[0][i] == 2)
   { 
      if (mainAnimation->led[i][0] != testvec)
         num++;
   }
}
if (num < 3)
   return;

mainAnimation->setRSnr(2);
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camsysnr = tmpdata->type/1000;
//   if (type == 220)
   if (type == 220 && tmpdata->reference == -1) //070105
   {
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmpdata->point;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }
   else if (type == 220 && tmpdata->reference > -1) //070105
   {
         mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
         m1 = mainAnimation->mRefRefSys[0].inverse();
         m1.multMatrixVec(tmpdata->point, tmp1);
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmp1;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }

   if ((type >= 200)&&(type < 220))
   {
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      for (i=0; i<num; i++)
      {
         vd1 = mainAnimation->led[18*camsysnr+type-200][i+tmpdata->startStep];
         vd2 = mainAnimation->led[18*camsysnr+type-200][i+1+tmpdata->startStep];
         if ((vd1 == testvec) || (vd2 == testvec))
         {
            vd1 = vd2 = testvec;
         }
         else
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep], vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep+1], vd2);
         }
         tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
         tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
      }
   }
   tmpdata = tmpdata->next;
}

if (mainAnimation != NULL)
   applyMotion(1);
else
   objview->redraw();
mainAnimation->RSsysnr =2;
oldRSsysnr = mainAnimation->RSsysnr;
}
void OPTISGui::cb_RSObj3(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_RSObj3_i(o,v);
}

inline void OPTISGui::cb_RSObj4_i(Fl_Menu_*, void*) {
  SbVec3d vd1, vd2, testvec, tmp1;
SdMatrix md, m1;
int i, num, type, camsysnr;;
ObjectData *tmpdata;

testvec.setValue(-120.0, -120.0, -120.0);
num = 0;
for (i=0; i<18; i++)
{
   if (mainAnimation->LEDofObject[0][i] == 3)
   { 
      if (mainAnimation->led[i][0] != testvec)
         num++;
   }
}
if (num < 3)
   return;

mainAnimation->setRSnr(3);
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camsysnr = tmpdata->type/1000;
//   if (type == 220)
   if (type == 220 && tmpdata->reference == -1) //070105
   {
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmpdata->point;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }
   else if (type == 220 && tmpdata->reference > -1) //070105
   {
         mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
         m1 = mainAnimation->mRefRefSys[0].inverse();
         m1.multMatrixVec(tmpdata->point, tmp1);
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmp1;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }
   
   if ((type >= 200)&&(type < 220))
   {
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      for (i=0; i<num; i++)
      {
         vd1 = mainAnimation->led[18*camsysnr+type-200][i+tmpdata->startStep];
         vd2 = mainAnimation->led[18*camsysnr+type-200][i+1+tmpdata->startStep];
         if ((vd1 == testvec) || (vd2 == testvec))
         {
            vd1 = vd2 = testvec;
         }
         else
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep], vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep+1], vd2);
         }
         tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
         tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
      }
   }
   tmpdata = tmpdata->next;
}

if (mainAnimation != NULL)
   applyMotion(1);
else
   objview->redraw();
mainAnimation->RSsysnr =3;
oldRSsysnr = mainAnimation->RSsysnr;
}
void OPTISGui::cb_RSObj4(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_RSObj4_i(o,v);
}

inline void OPTISGui::cb_RSObj5_i(Fl_Menu_*, void*) {
  SbVec3d vd1, vd2, testvec, tmp1;
SdMatrix md, m1;
int i, num, type, camsysnr;;
ObjectData *tmpdata;

testvec.setValue(-120.0, -120.0, -120.0);
num = 0;
for (i=0; i<18; i++)
{
   if (mainAnimation->LEDofObject[0][i] == 4)
   { 
      if (mainAnimation->led[i][0] != testvec)
         num++;
   }
}
if (num < 3)
   return;

mainAnimation->setRSnr(4);
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camsysnr = tmpdata->type/1000;
//   if (type == 220)
   if (type == 220 && tmpdata->reference == -1) //070105
   {
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmpdata->point;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }
   else if (type == 220 && tmpdata->reference > -1) //070105
   {
         mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
         m1 = mainAnimation->mRefRefSys[0].inverse();
         m1.multMatrixVec(tmpdata->point, tmp1);
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmp1;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }
   
   if ((type >= 200)&&(type < 220))
   {
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      for (i=0; i<num; i++)
      {
         vd1 = mainAnimation->led[18*camsysnr+type-200][i+tmpdata->startStep];
         vd2 = mainAnimation->led[18*camsysnr+type-200][i+1+tmpdata->startStep];
         if ((vd1 == testvec) || (vd2 == testvec))
         {
            vd1 = vd2 = testvec;
         }
         else
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep], vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep+1], vd2);
         }
         tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
         tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
      }
   }
   tmpdata = tmpdata->next;
}

if (mainAnimation != NULL)
   applyMotion(1);
else
   objview->redraw();
mainAnimation->RSsysnr =4;
oldRSsysnr = mainAnimation->RSsysnr;
}
void OPTISGui::cb_RSObj5(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_RSObj5_i(o,v);
}

inline void OPTISGui::cb_RSObj6_i(Fl_Menu_*, void*) {
  SbVec3d vd1, vd2, testvec, tmp1;
SdMatrix md, m1;
int i, num, type, camsysnr;;
ObjectData *tmpdata;

testvec.setValue(-120.0, -120.0, -120.0);
num = 0;
for (i=0; i<18; i++)
{
   if (mainAnimation->LEDofObject[0][i] == 5)
   { 
      if (mainAnimation->led[i][0] != testvec)
         num++;
   }
}
if (num < 3)
   return;

mainAnimation->setRSnr(5);
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camsysnr = tmpdata->type/1000;
//   if (type == 220)
   if (type == 220 && tmpdata->reference == -1) //070105
   {
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmpdata->point, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmpdata->point;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }
   else if (type == 220 && tmpdata->reference > -1) //070105
   {
         mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
         m1 = mainAnimation->mRefRefSys[0].inverse();
         m1.multMatrixVec(tmpdata->point, tmp1);
      mainAnimation->RSchanged;
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         for (i=0; i<num; i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camsysnr].multMatrixVec(tmp1, vd2);
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else
      {
         for (i=0; i<num; i++)
         {
            vd1 = vd2 = tmp1;
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      mainAnimation->RSchanged;
   }
   
   if ((type >= 200)&&(type < 220))
   {
      num = tmpdata->vertexproperty->vertex.getNum()/2;
      for (i=0; i<num; i++)
      {
         vd1 = mainAnimation->led[18*camsysnr+type-200][i+tmpdata->startStep];
         vd2 = mainAnimation->led[18*camsysnr+type-200][i+1+tmpdata->startStep];
         if ((vd1 == testvec) || (vd2 == testvec))
         {
            vd1 = vd2 = testvec;
         }
         else
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep], vd1);
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep+1);
            mainAnimation->fov_trafo[camsysnr].multMatrixVec(mainAnimation->led[(18*camsysnr)+type-200][i+tmpdata->startStep+1], vd2);
         }
         tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
         tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
      }
   }
   tmpdata = tmpdata->next;
}

if (mainAnimation != NULL)
   applyMotion(1);
else
   objview->redraw();
mainAnimation->RSsysnr =5;
oldRSsysnr = mainAnimation->RSsysnr;
}
void OPTISGui::cb_RSObj6(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_RSObj6_i(o,v);
}


inline void OPTISGui::cb_InsTrajLED_i(Fl_Menu_*, void*) {
 ObjectData *tmpdata;
int type, i, camnr, j;
char st[256], st1[256];

if (mainAnimation == NULL)
   return;
if (mainAnimation->num_steps == 0)
   return;
if (numLEDs < 1)
   return;

TrajectoryName->hide();
TrajNameChoice->hide();
Tbtn_del->hide();
Tbtn_ok->hide();
Tbtn_ok2->hide();
Tbtn_cancel2->hide();
Tbtn_ok3->show();
Tbtn_cancel->show();
LEDNameChoice->show();
LEDNameChoice->clear();
XCoord->deactivate();
YCoord->deactivate();
ZCoord->deactivate();
TrajCamSysChoice->deactivate();
TrajObjChoice->value(0);
TrajObjChoice->deactivate();
TrajRefChoice->value(0);
TrajRefChoice->deactivate();
//LEDRefChoice->value(5);	//add 060630
//LEDRefChoice->deactivate();	//add 060630
   oldrefcoord = 0; //070105

i = 0;
tmpdata = objview->objlist;
while (tmpdata != NULL) 
{
   type = tmpdata->type%1000;
   camnr = tmpdata->type/1000;
   if ((type >= 100) && (type <= 117))
   {
      objview->getLabel(tmpdata, &st[0]);
      sprintf(st1, "Trajectory of %s", st);
      LEDNameChoice->add(&st1[0], 0, 0, 0, 0);
      i++;
      tmpdata->point = mainAnimation->led[(camnr*18)+type-100][0];
      tmpdata->camSys = camnr;
   }
   tmpdata = tmpdata->next;
}

if (i == 0)
   return;

tmpdata = objview->objlist;
while ((tmpdata != NULL)&& (((tmpdata->type%1000) < 100) || ((tmpdata->type%1000) > 117)))
   tmpdata = tmpdata->next;
XCoord->value(tmpdata->point[0]);
YCoord->value(tmpdata->point[1]);
ZCoord->value(tmpdata->point[2]);
FirstStep->value(1);
LastStep->value(mainAnimation->num_steps);
TotalSteps->value(mainAnimation->num_steps);
LEDNameChoice->value(0);
TrajCamSysChoice->value(tmpdata->camSys);
// Objekt- und Referenznummern suchen
//search object and reference number

j = 0;
TrajObjChoice->value(j+1);
for (i=0; i<6; i++)
   if (LEDGroupsBtn[tmpdata->type%100][i]->value() > 0)
   {
      TrajObjChoice->value(i+1);
      j = i;
   }
TrajRefChoice->value(0);
for (i=0; i<7; i++)
   if (ObjGroupsBtn[j][i]->value() > 0)
      TrajRefChoice->value(i);

TrajectoryWindow->position(
   LEDViewer->x()+((LEDViewer->w()-TrajectoryWindow->w())/2),
   LEDViewer->y()+((LEDViewer->h()-TrajectoryWindow->h())/2));
TrajectoryWindow->show();
}
void OPTISGui::cb_InsTrajLED(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_InsTrajLED_i(o,v);
}

inline void OPTISGui::cb_InsTrajCoord_i(Fl_Menu_*, void*) {
  if (mainAnimation == NULL)
   return;
if (mainAnimation->num_steps == 0)
   return;

TrajectoryName->show();
Tbtn_ok->show();
Tbtn_cancel->show();
TrajNameChoice->hide();
LEDNameChoice->hide();
Tbtn_del->hide();
Tbtn_ok2->hide();
Tbtn_ok3->hide();
Tbtn_cancel2->hide();
XCoord->activate();
YCoord->activate();
ZCoord->activate();
TrajCamSysChoice->activate();

TrajectoryName->value("Trajectory");
TotalSteps->value(mainAnimation->num_steps);
FirstStep->value(1);
FirstStep->maximum(mainAnimation->num_steps);
LastStep->value(mainAnimation->num_steps);
LastStep->maximum(mainAnimation->num_steps);
TrajCamSysChoice->value(0);
//LEDRefChoice->value(5); // add 060630
//LEDRefChoice->activate(); // add 060630
//TrajObjChoice->value(2); //default
TrajObjChoice->value(oldobjcoord); //2=object2
TrajObjChoice->activate();
//TrajRefChoice->value(1); //default
TrajRefChoice->value(oldrefcoord);//0=FOV
TrajRefChoice->activate();
deActivateCamSystemChoice(numCamSys-1);
TrajectoryWindow->position(
   LEDViewer->x()+((LEDViewer->w()-TrajectoryWindow->w())/2),
   LEDViewer->y()+((LEDViewer->h()-TrajectoryWindow->h())/2));
TrajectoryWindow->show();
}
void OPTISGui::cb_InsTrajCoord(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_InsTrajCoord_i(o,v);
}

inline void OPTISGui::cb_AnimRecMotion_i(Fl_Menu_*, void*) {
  RecMotionBtn->value(1);
RecMotionBtn->do_callback();
}
void OPTISGui::cb_AnimRecMotion(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_AnimRecMotion_i(o,v);
}

inline void OPTISGui::cb_AnimLoadMainMotion_i(Fl_Menu_*, void*) {
  LoadMotionBtn->value(1);
LoadMotionBtn->do_callback();
}
void OPTISGui::cb_AnimLoadMainMotion(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_AnimLoadMainMotion_i(o,v);
}

inline void OPTISGui::cb_AnimLEDCharacteristics_i(Fl_Menu_*, void*) {
  int i, j;

if (mainAnimation == NULL)
   return;

LEDCharActualCamSys = 0;
getLEDCharValues(0);
LEDCharCamSysChoice->value(0);

for (i=0; i<10; i++)
{
   for (j=0; j<18; j++)
      mainAnimation->oldLEDofObject[i][j] = mainAnimation->LEDofObject[i][j];
		pref->LEDofObjectP[j] = mainAnimation->LEDofObject[0][j];//add
   for (j=0; j<6; j++)
      mainAnimation->oldObjectsAndReferences[i][j] = mainAnimation->ObjectsAndReferences[i][j];
   mainAnimation->oldSpeed[i] = mainAnimation->Speed[i];
		pref->ObjectsAndReferencesP[j] = mainAnimation->ObjectsAndReferences[0][j];//add
}

LEDCharWindow->position(
   LEDViewer->x()+((LEDViewer->w()-LEDCharWindow->w())/2),
   LEDViewer->y()+((LEDViewer->h()-LEDCharWindow->h())/2));
LEDCharWindow->show();
}
void OPTISGui::cb_AnimLEDCharacteristics(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_AnimLEDCharacteristics_i(o,v);
}

inline void OPTISGui::cb_AnimStart_i(Fl_Menu_*, void*) {
  StartMotionBtn->value(1);
StartMotionBtn->do_callback();
}
void OPTISGui::cb_AnimStart(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_AnimStart_i(o,v);
}

inline void OPTISGui::cb_AnimStop_i(Fl_Menu_*, void*) {
  StopMotionBtn->do_callback();
}
void OPTISGui::cb_AnimStop(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_AnimStop_i(o,v);
}

inline void OPTISGui::cb_AnimOneFwd_i(Fl_Menu_*, void*) {
  FwdMotionBtn->do_callback();
}
void OPTISGui::cb_AnimOneFwd(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_AnimOneFwd_i(o,v);
}

inline void OPTISGui::cb_AnimOneBwd_i(Fl_Menu_*, void*) {
  RwdMotionBtn->do_callback();
}
void OPTISGui::cb_AnimOneBwd(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_AnimOneBwd_i(o,v);
}

inline void OPTISGui::cb_AnimPlayBwd_i(Fl_Menu_*, void*) {
  PlayBackwardMotionBtn->value(1);
PlayBackwardMotionBtn->do_callback();
}
void OPTISGui::cb_AnimPlayBwd(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_AnimPlayBwd_i(o,v);
}

inline void OPTISGui::cb_AnimReset_i(Fl_Menu_*, void*) {
  ResetMotionBtn->do_callback();
}
void OPTISGui::cb_AnimReset(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_AnimReset_i(o,v);
}

inline void OPTISGui::cb_ImpTraj_i(Fl_Menu_*, void*) {

char    st[256], filename[256],comment[256];
dirent  **list;	
int     n, i,len, maxlen,j;
FILE    *readfile;

if (mainAnimation == NULL)
   return;

   sprintf(st, "%s/%s/", pref->datapath, scnfile->scanmov.path);
   maxlen = 0;
   list = NULL;
   n = fl_filename_list(&st[0], &list);
   for(i=2; i<n; i++)
   {
      sprintf(st, "%s", list[i]->d_name);
      len = strlen(st);
      if ((st[len-3]=='x')&&(st[len-2]=='l')&&(st[len-1]=='s'))
	  {
         if (len > maxlen) maxlen = len;
	  }
   }
   ImpTrajBrowser->clear();
for(i=2; i<n; i++)
{
   sprintf(st, "%s", list[i]->d_name);
   len = strlen(st);
   if ((len>0)&&(st[len-3]=='x')&&(st[len-2]=='l')&&(st[len-1]=='s'))
   {
      for(j=len; ((j<maxlen+5)&&(j<254)); j++)
         st[j] = ' ';
      if ((maxlen+5)<256)
         st[maxlen+5] = '\0';
      else
         st[255] = '\0';
      sprintf(filename, "%s/%s/%s", pref->datapath, scnfile->scanmov.path, list[i]->d_name);
      if((readfile = fopen(&filename[0], "rb")) != NULL)
      {
         fgets(comment,256,readfile);  //printf("%s\n",filename2);
         fclose(readfile);
         strcat(st, comment);
      }
      ImpTrajBrowser->add(&st[0]);
   }
}
for(i=n; i>0;)
   free((void*)(list[--i]));
free((void*)list);
ImpTrajWindow->size_range(400, 200, 0, 0, 0, 0, 0);
ImpTrajWindow->show();	
	
///////////////////////	
 /*  sprintf(filename, "C:/goessi/Database/satsuma_toyoko/19_06_2006/left/test2.xls");
 //  mainAnimation->read_trajfile( * filename);
   mainAnimation->read_trajfile(filename);
SbVec3f vd1, vd2;
SbVec3f *linexyz, posxyz;
SbVec3d src;
int numSteps, oldRSnr, objnr;
SdMatrix md;

src.setValue(mainAnimation->impTraj[0][0][0], mainAnimation->impTraj[0][0][1], mainAnimation->impTraj[0][0][2]);
numSteps = mainAnimation-> imp_steps;
linexyz = new SbVec3f[2*(numSteps-1)];
oldRSnr = mainAnimation->RSnr;
mainAnimation->setRSnr(TrajRefChoice->value()-1);
//objnr = TrajObjChoice->value()-1;
objnr = 0;

for (i=0; i<(numSteps-1); i++)
{
      vd1 = mainAnimation->impTraj[0][i];
      vd2 = mainAnimation->impTraj[0][i+1];
   linexyz[2*i].setValue(vd1[0], vd1[1], vd1[2]);
   linexyz[2*i+1].setValue(vd2[0], vd2[1], vd2[2]);
}
//objview->objlist->motionOfObject = TrajObjChoice->value()-1;
//objview->objlist->reference = TrajRefChoice->value()-1;
sprintf(st, "import trajectory");
objview->addLineObject(&st[0], linexyz, (numSteps-1), 2*(numSteps-1));
objview->objlist->type = 222;
objview->objlist->startStep = 0;
objview->objlist->stopStep = mainAnimation->imp_steps-1;
objview->objlist->point = src;
objview->objlist->camSys = 0;
objview->objlist->motionOfObject = 0;
objview->objlist->reference = -1;
mainAnimation->setRSnr(oldRSnr);

TrajectoryWindow->hide();
objview->orderChildren();
applyMotion(-1);

delete[] linexyz;*/

////////////////////////;

}
void OPTISGui::cb_ImpTraj(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_ImpTraj_i(o,v);
}
inline void OPTISGui::cb_StoreSGI_i(Fl_Menu_*, void*) {
  char st[10];

sprintf(imgFormat, "sgi");
if (mainAnimation == NULL)
{
   FilmButton->value(0);
   return;
}
sprintf(st, "*.%s", imgFormat);
recBase = fl_file_chooser("Store Animation: Enter Directory and File Name without Extension ...", &st[0], NULL);
if (recBase == NULL)
{
   FilmButton->value(0);
   return;
}
FilmButton->value(1);
recStep = 1;
}
void OPTISGui::cb_StoreSGI(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_StoreSGI_i(o,v);
}

inline void OPTISGui::cb_StoreTIF_i(Fl_Menu_*, void*) {
  char st[10];

sprintf(imgFormat, "tif");
if (mainAnimation == NULL)
{
   FilmButton->value(0);
   return;
}
sprintf(st, "*.%s", imgFormat);
recBase = fl_file_chooser("Store Animation: Enter Directory and File Name without Extension ...", &st[0], NULL);
if (recBase == NULL)
{
   FilmButton->value(0);
   return;
}
FilmButton->value(1);
recStep = 1;
}
void OPTISGui::cb_StoreTIF(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_StoreTIF_i(o,v);
}

inline void OPTISGui::cb_StoreGIF_i(Fl_Menu_*, void*) {
  char st[10];

sprintf(imgFormat, "gif");
if (mainAnimation == NULL)
{
   FilmButton->value(0);
   return;
}
sprintf(st, "*.%s", imgFormat);
recBase = fl_file_chooser("Store Animation: Enter Directory and File Name without Extension ...", &st[0], NULL);
if (recBase == NULL)
{
   FilmButton->value(0);
   return;
}
FilmButton->value(1);
recStep = 1;
}
void OPTISGui::cb_StoreGIF(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_StoreGIF_i(o,v);
}

inline void OPTISGui::cb_StoreJPEG_i(Fl_Menu_*, void*) {
  char st[10];

sprintf(imgFormat, "jpg");
if (mainAnimation == NULL)
{
   FilmButton->value(0);
   return;
}
sprintf(st, "*.%s", imgFormat);
recBase = fl_file_chooser("Store Animation: Enter Directory and File Name without Extension ...", &st[0], NULL);
if (recBase == NULL)
{
   FilmButton->value(0);
   return;
}
FilmButton->value(1);
recStep = 1;
}
void OPTISGui::cb_StoreJPEG(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_StoreJPEG_i(o,v);
}

inline void OPTISGui::cb_StoreOther_i(Fl_Menu_*, void*) {
  const char *format;
char st[10];

format = fl_input("Store Animation: Enter the Format Extension", &imgFormat[0]);
if (format != NULL)
{
   if (strlen(format) > 9)
   {
      fl_message("Invalid File Format");
      return;
   }
   else
      sprintf(imgFormat, "%s", format);
}
else
   return;

if (mainAnimation == NULL)
{
   FilmButton->value(0);
   return;
}
sprintf(st, "*.%s", imgFormat);
recBase = fl_file_chooser("Store Animation: Enter Directory and File Name without Extension ...", &st[0], NULL);
if (recBase == NULL)
{
   FilmButton->value(0);
   return;
}
FilmButton->value(1);
recStep = 1;
}
void OPTISGui::cb_StoreOther(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_StoreOther_i(o,v);
}


inline void OPTISGui::cb_camNum03_i(Fl_Menu_*, void*) {
  changeCamNumber(3);
}
void OPTISGui::cb_camNum03(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum03_i(o,v);
}

inline void OPTISGui::cb_camNum06_i(Fl_Menu_*, void*) {
  changeCamNumber(6);
}
void OPTISGui::cb_camNum06(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum06_i(o,v);
}

inline void OPTISGui::cb_camNum09_i(Fl_Menu_*, void*) {
  changeCamNumber(9);
}
void OPTISGui::cb_camNum09(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum09_i(o,v);
}

inline void OPTISGui::cb_camNum12_i(Fl_Menu_*, void*) {
  changeCamNumber(12);
}
void OPTISGui::cb_camNum12(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum12_i(o,v);
}

inline void OPTISGui::cb_camNum15_i(Fl_Menu_*, void*) {
  changeCamNumber(15);
}
void OPTISGui::cb_camNum15(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum15_i(o,v);
}

inline void OPTISGui::cb_camNum18_i(Fl_Menu_*, void*) {
  changeCamNumber(18);
}
void OPTISGui::cb_camNum18(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum18_i(o,v);
}

inline void OPTISGui::cb_camNum21_i(Fl_Menu_*, void*) {
  changeCamNumber(21);
}
void OPTISGui::cb_camNum21(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum21_i(o,v);
}

inline void OPTISGui::cb_camNum24_i(Fl_Menu_*, void*) {
  changeCamNumber(24);
}
void OPTISGui::cb_camNum24(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum24_i(o,v);
}

inline void OPTISGui::cb_camNum27_i(Fl_Menu_*, void*) {
  changeCamNumber(27);
}
void OPTISGui::cb_camNum27(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum27_i(o,v);
}

inline void OPTISGui::cb_camNum30_i(Fl_Menu_*, void*) {
  changeCamNumber(30);
}
void OPTISGui::cb_camNum30(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_camNum30_i(o,v);
}

inline void OPTISGui::cb_cameraMatrix_i(Fl_Menu_*, void*) {
  int i;

if (numCamSys < 2)
   return;

for(i=0; i<10; i++)
{
   tmpCamSysRot[i] = pref->camSysRot[i];
   tmpCamSysTrans[i] = pref->camSysTrans[i];
   tmpCamSysOverlap[i] = pref->camSysOverlap[i];
}

MatrixChoice->value(0);
oldCamSys = 0;
deActivateCamSystemChoice(numCamSys-1);
SetMatrixWinValues(1);
MatrixWindow->position(
   LEDViewer->x()+((LEDViewer->w()-MatrixWindow->w())/2),
   LEDViewer->y()+((LEDViewer->h()-MatrixWindow->h())/2));
MatrixWindow->show();
}
void OPTISGui::cb_cameraMatrix(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_cameraMatrix_i(o,v);
}

inline void OPTISGui::cb_cameraConnect_i(Fl_Menu_*, void*)//receive data 
{
  char c, message[260], cmd[256];
int i;
clock_t start, finish;
float duration;

clearLEDs();
if (mainAnimation != NULL)
   delete mainAnimation; //delete pointer
mainAnimation = new Motion(pref, scnfile); //new pointer
mainAnimation->initRealTime(numCams);
resetCamSysTrafo();
resetTrajectories();
StepNrOutput->value(1);
StepNrOutput->minimum(0);
StepNrOutput->maximum(999999);
StepNrOutput->deactivate();
StepSlider->value(2);
StepSlider->maximum(2);
StepSlider->deactivate();
NumberOfStepsOutput->value(999999);
MotionNameOutput->value("Camera View: LIVE");
AnimStop->activate();
ImpTraj->activate(); //060822

      LEDViewer->cursor(FL_CURSOR_WAIT);
      MenuBarLEDViewer->deactivate();
      ControllerTop->deactivate();
      ControllerLeft->deactivate();
      ControllerBottom->deactivate();
      ControllerRight->deactivate();
if (csoc.connected == 0)
{
   c = connectSocket(0);
   if (c == 0)
   {
      ConnectInfoWin->position(
         LEDViewer->x()+((LEDViewer->w()-ConnectInfoWin->w())/2),
         LEDViewer->y()+((LEDViewer->h()-ConnectInfoWin->h())/2));
      ConnectInfoWin->show();
      sprintf(cmd, "%s", pref->optisController);
      printf("%s\n", cmd);
      pref->RunApp(cmd);
      duration = 0.0;
      start = clock();
      while (duration < 2.0)
      {
         Fl::check();
         finish = clock();
         duration = (float)(finish - start) / CLOCKS_PER_SEC;
      }
      ConnectInfoWin->hide();
   }
}
      MenuBarLEDViewer->activate();
      ControllerTop->activate();
      ControllerLeft->activate();
      ControllerBottom->activate();
      ControllerRight->activate();
      LEDViewer->cursor(FL_CURSOR_DEFAULT);

if (csoc.connected == 0)
{
   c = connectSocket();
   if (c == 0)
   {
      RecMotionBtn->value(0);
      return;
   }
}

for (i=0; i<260; i++)
   message[i] = '\0';
//sprintf(message, "f%s", scnfile->scanmov.base);	//original
//sprintf(message, "f%s/%s", pref->datapath, scnfile->scanmov.path); //until060622
sprintf(message, "f%s/%s", pref->datapath, scnfile->scanmov.path);
sprintf((message+130), "f%s/%s/%s", pref->datapath, scnfile->scanmov.path, scnfile->scanmov.base);	//add 060619
if ((socketStopped == 0)&&(csoc.connected>0))
{
   do
   {
      c = csoc.SendMsg(&message[0], 260);
      if (c < 0)
          socketStopped = 1;
      Fl::check();
   } while ((c < 1)&&(socketStopped == 0)&&(csoc.connected>0));
}

getNewRecordingText();

receiveSocketData();
}
void OPTISGui::cb_cameraConnect(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_cameraConnect_i(o,v);
}

inline void OPTISGui::cb_cameraDisconnect_i(Fl_Menu_*, void*) {
  StartMotionBtn->value(0);
PlayBackwardMotionBtn->value(0);
RecMotionBtn->value(0);
ImpTraj->deactivate(); //060823
socketStopped = 1;
disconnectSocket();
}
void OPTISGui::cb_cameraDisconnect(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_cameraDisconnect_i(o,v);
}

inline void OPTISGui::cb_extraCameraTest_i(Fl_Menu_*, void*) {
  camTestWin->show();
}
void OPTISGui::cb_extraCameraTest(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_extraCameraTest_i(o,v);
}

inline void OPTISGui::cb_WindowSize512_i(Fl_Menu_*, void*) {
  LEDViewer->size(576, 621);
}
void OPTISGui::cb_WindowSize512(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_WindowSize512_i(o,v);
}

inline void OPTISGui::cb_WindowSize640_i(Fl_Menu_*, void*) {
  LEDViewer->size(704, 589);
}
void OPTISGui::cb_WindowSize640(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_WindowSize640_i(o,v);
}

inline void OPTISGui::cb_WindowSize768_i(Fl_Menu_*, void*) {
  LEDViewer->size(832, 877);
}
void OPTISGui::cb_WindowSize768(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_WindowSize768_i(o,v);
}

inline void OPTISGui::cb_WindowSizeOther_i(Fl_Menu_*, void*) {
  inputWindowWidth->value(objview->w());
inputWindowHeight->value(objview->h());
WindowSizeWindow->position(
   LEDViewer->x()+((LEDViewer->w()-WindowSizeWindow->w())/2),
   LEDViewer->y()+((LEDViewer->h()-WindowSizeWindow->h())/2));
WindowSizeWindow->show();
}
void OPTISGui::cb_WindowSizeOther(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_WindowSizeOther_i(o,v);
}

inline void OPTISGui::cb_WindowLEDControl_i(Fl_Menu_*, void*) {
  iMean100 = 0;
vMean100.setValue(0.0, 0.0, 0.0);
jMean100.setValue(0.0, 0.0, 0.0);
LEDControlWindow->size_range(500, 200, 0, 0, 0, 0, 0);
LEDControlWindow->show();
}
void OPTISGui::cb_WindowLEDControl(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_WindowLEDControl_i(o,v);
}

inline void OPTISGui::cb_WindowLEDControl2_i(Fl_Menu_*, void*) {
/*  iMean100 = 0;
vMean100.setValue(0.0, 0.0, 0.0);
jMean100.setValue(0.0, 0.0, 0.0);*/
LEDControl2Window->size_range(500, 200, 0, 0, 0, 0, 0);//RefLEDControlWindow
LEDControl2Window->show();
}
void OPTISGui::cb_WindowLEDControl2(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_WindowLEDControl2_i(o,v);
}

inline void OPTISGui::cb_HelpManual_i(Fl_Menu_*, void*) {
  help_dialog->resize(LEDViewer->x()+((LEDViewer->w()-650)/2),
   LEDViewer->y()+((LEDViewer->h()-650)/2), 650, 650);
help_dialog->load("help/help.html");
help_dialog->show();
}
void OPTISGui::cb_HelpManual(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_HelpManual_i(o,v);
}

inline void OPTISGui::cb_HelpAbout_i(Fl_Menu_*, void*) {
  AboutWindow->position(
   LEDViewer->x()+((LEDViewer->w()-AboutWindow->w())/2),
   LEDViewer->y()+((LEDViewer->h()-AboutWindow->h())/2));
AboutWindow->show();
}
void OPTISGui::cb_HelpAbout(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_HelpAbout_i(o,v);
}


//menuitem setup
Fl_Menu_Item OPTISGui::menu_MenuBarLEDViewer[] = {
 {"File", 0,  0, 0, 64, 0, 0, 14, 56},
 {"New Subject", 0x4006e,  (Fl_Callback*)OPTISGui::cb_FileNewPatient, 0, 128, 0, 0, 14, 56},
 {"Export", 0,  0, 0, 64, 0, 0, 14, 56},
 {"Trajectories", 0,  (Fl_Callback*)OPTISGui::cb_FileExportTrajectories, 0, 0, 0, 0, 14, 56},
 {0},
 {"Snapshot", 0,  0, 0, 192, 0, 0, 14, 56},
 {"SGI", 0,  (Fl_Callback*)OPTISGui::cb_sgiSnapshot, 0, 0, 0, 0, 14, 56},
 {"TIFF", 0,  (Fl_Callback*)OPTISGui::cb_tifSnapshot, 0, 0, 0, 0, 14, 56},
 {"GIF", 0,  (Fl_Callback*)OPTISGui::cb_gifSnapshot, 0, 0, 0, 0, 14, 56},
 {"JPEG", 0,  (Fl_Callback*)OPTISGui::cb_jpgSnapshot, 0, 0, 0, 0, 14, 56},
 {"Other ...", 0,  (Fl_Callback*)OPTISGui::cb_otherSnapshot, 0, 0, 0, 0, 14, 56},
 {0},
 {"Exit", 0x40071,  (Fl_Callback*)OPTISGui::cb_FileClose, 0, 0, 0, 0, 14, 56},
 {0},
 {"Edit", 0,  0, 0, 64, 0, 0, 14, 56},
 {"Subject", 0x40065,  (Fl_Callback*)OPTISGui::cb_EditSubject, 0, 128, 0, 0, 14, 56},

 {"Appearance of the Objects", 0x40061,  (Fl_Callback*)OPTISGui::cb_EditObjects, 0, 0, 0, 0, 14, 56},
 {"Radius of the Spheres", 0,  0, 0, 64, 0, 0, 14, 56},
 {"0.5 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR05, 0, 8, 0, 0, 14, 56},
 {"1.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR10, 0, 8, 0, 0, 14, 56},
 {"1.5 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR15, 0, 8, 0, 0, 14, 56},
 {"2.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR20, 0, 8, 0, 0, 14, 56},
 {"2.5 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR25, 0, 8, 0, 0, 14, 56},
 {"3.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR30, 0, 12, 0, 0, 14, 56},
 {"4.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR40, 0, 8, 0, 0, 14, 56},
 {"5.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR50, 0, 8, 0, 0, 14, 56},
 {"6.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR60, 0, 8, 0, 0, 14, 56},
 {"7.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR70, 0, 8, 0, 0, 14, 56},
 {"8.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR80, 0, 8, 0, 0, 14, 56},
 {"9.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR90, 0, 8, 0, 0, 14, 56},
 {"10.0 mm", 0,  (Fl_Callback*)OPTISGui::cb_LedR100, 0, 8, 0, 0, 14, 56},
 {0},

 {"Trajectories", 0x40064,  (Fl_Callback*)OPTISGui::cb_EditTrajectories, 0, 128, 0, 0, 14, 56},
 {"Background Color", 0,  (Fl_Callback*)OPTISGui::cb_EditBackGroundColor, 0, 128, 0, 0, 14, 56},
 {"Preferences ...", 0,  (Fl_Callback*)OPTISGui::cb_EditPreferences, 0, 0, 0, 0, 14, 56},
 {0},
 {"View", 0,  0, 0, 64, 0, 0, 14, 56},
 {"Load Position ...", 0,  (Fl_Callback*)OPTISGui::cb_ViewLoad, 0, 0, 0, 0, 14, 56},
 {"Save Position ...", 0,  (Fl_Callback*)OPTISGui::cb_ViewSaveAs, 0, 128, 0, 0, 14, 56},
 {"Reference System", 0,  0, 0, 64, 0, 0, 14, 56},
 {"FOV", 0x40030,  (Fl_Callback*)OPTISGui::cb_RSFOV, 0, 12, 0, 0, 14, 56},
 {"Object 1", 0x40031,  (Fl_Callback*)OPTISGui::cb_RSObj1, 0, 8, 0, 0, 14, 56},
 {"Object 2", 0x40032,  (Fl_Callback*)OPTISGui::cb_RSObj2, 0, 8, 0, 0, 14, 56},
 {"Object 3", 0x40033,  (Fl_Callback*)OPTISGui::cb_RSObj3, 0, 8, 0, 0, 14, 56},
 {"Object 4", 0x40034,  (Fl_Callback*)OPTISGui::cb_RSObj4, 0, 8, 0, 0, 14, 56},
 {"Object 5", 0x40035,  (Fl_Callback*)OPTISGui::cb_RSObj5, 0, 8, 0, 0, 14, 56},
 {"Object 6", 0x40036,  (Fl_Callback*)OPTISGui::cb_RSObj6, 0, 8, 0, 0, 14, 56},
 {0},
 {0},
 {"Insert", 0,  0, 0, 64, 0, 0, 14, 56},
 {"Trajectory ...", 0,  0, 0, 64, 0, 0, 14, 56},
 {"of LEDs ...", 0x4006c,  (Fl_Callback*)OPTISGui::cb_InsTrajLED, 0, 0, 0, 0, 14, 56},
 {"by Coordinate ...", 0x40074,  (Fl_Callback*)OPTISGui::cb_InsTrajCoord, 0, 0, 0, 0, 14, 56},
 {0},
 {0},
 {"Animation", 0,  0, 0, 64, 0, 0, 14, 56},
 {"Record Motion", 0x2b,  (Fl_Callback*)OPTISGui::cb_AnimRecMotion, 0, 128, 0, 0, 14, 1},
 {"Load Motion ...", 0x4006f,  (Fl_Callback*)OPTISGui::cb_AnimLoadMainMotion, 0, 128, 0, 0, 14, 56},
 {"LED Characteristics", 0,  (Fl_Callback*)OPTISGui::cb_AnimLEDCharacteristics, 0, 129, 0, 0, 14, 56},
 {"Start", 0x40072,  (Fl_Callback*)OPTISGui::cb_AnimStart, 0, 1, 0, 0, 14, 56},
 {"Stop", 0x2d,  (Fl_Callback*)OPTISGui::cb_AnimStop, 0, 1, 0, 0, 14, 56},
 {"One Step Forward", 0,  (Fl_Callback*)OPTISGui::cb_AnimOneFwd, 0, 1, 0, 0, 14, 56},
 {"One Step Backward", 0,  (Fl_Callback*)OPTISGui::cb_AnimOneBwd, 0, 1, 0, 0, 14, 56},
 {"Play Backward", 0,  (Fl_Callback*)OPTISGui::cb_AnimPlayBwd, 0, 129, 0, 0, 14, 56},
 {"Reset", 0xff50,  (Fl_Callback*)OPTISGui::cb_AnimReset, 0, 129, 0, 0, 14, 56},
 {"Import Trajectory", 0,  (Fl_Callback*)OPTISGui::cb_ImpTraj, 0, 129, 0, 0, 14, 56},
 {"Store Animation As ...", 0,  0, 0, 65, 0, 0, 14, 56},
 {"SGI", 0,  (Fl_Callback*)OPTISGui::cb_StoreSGI, 0, 0, 0, 0, 14, 56},
 {"TIFF", 0,  (Fl_Callback*)OPTISGui::cb_StoreTIF, 0, 4, 0, 0, 14, 56},
 {"GIF", 0,  (Fl_Callback*)OPTISGui::cb_StoreGIF, 0, 0, 0, 0, 14, 56},
 {"JPEG", 0,  (Fl_Callback*)OPTISGui::cb_StoreJPEG, 0, 0, 0, 0, 14, 56},
 {"Other ...", 0,  (Fl_Callback*)OPTISGui::cb_StoreOther, 0, 0, 0, 0, 14, 56},
 {0},
 {0},
 {"Cameras", 0,  0, 0, 64, 0, 0, 14, 56},
 {"Number of Camera Systems", 0,  0, 0, 64, 0, 0, 14, 56},
 {"1", 0,  (Fl_Callback*)OPTISGui::cb_camNum03, 0, 12, 0, 0, 14, 56},
 {"2", 0,  (Fl_Callback*)OPTISGui::cb_camNum06, 0, 8, 0, 0, 14, 56},
 {"3", 0,  (Fl_Callback*)OPTISGui::cb_camNum09, 0, 8, 0, 0, 14, 56},
 {"4", 0,  (Fl_Callback*)OPTISGui::cb_camNum12, 0, 8, 0, 0, 14, 56},
 {"5", 0,  (Fl_Callback*)OPTISGui::cb_camNum15, 0, 8, 0, 0, 14, 56},
 {"6", 0,  (Fl_Callback*)OPTISGui::cb_camNum18, 0, 8, 0, 0, 14, 56},
 {"7", 0,  (Fl_Callback*)OPTISGui::cb_camNum21, 0, 8, 0, 0, 14, 56},
 {"8", 0,  (Fl_Callback*)OPTISGui::cb_camNum24, 0, 8, 0, 0, 14, 56},
 {"9", 0,  (Fl_Callback*)OPTISGui::cb_camNum27, 0, 8, 0, 0, 14, 56},
 {"10", 0,  (Fl_Callback*)OPTISGui::cb_camNum30, 0, 8, 0, 0, 14, 56},
 {0},
 {"Position of the Camera Systems", 0,  (Fl_Callback*)OPTISGui::cb_cameraMatrix, 0, 128, 0, 0, 14, 56},
 {"Connect", 0,  (Fl_Callback*)OPTISGui::cb_cameraConnect, 0, 0, 0, 0, 14, 56},
 {"Disconnect", 0,  (Fl_Callback*)OPTISGui::cb_cameraDisconnect, 0, 0, 0, 0, 14, 56},
 {0},
 {"Extra", 0,  0, 0, 64, 0, 0, 14, 56},
 {"Camera Test", 0,  (Fl_Callback*)OPTISGui::cb_extraCameraTest, 0, 0, 0, 0, 14, 56},
 {0},
 {"Window", 0,  0, 0, 64, 0, 0, 14, 56},
 {"Drawing Area Size", 0,  0, 0, 64, 0, 0, 14, 56},
 {"512 x 512", 0,  (Fl_Callback*)OPTISGui::cb_WindowSize512, 0, 0, 0, 0, 14, 56},
 {"640 x 480", 0,  (Fl_Callback*)OPTISGui::cb_WindowSize640, 0, 0, 0, 0, 14, 56},
 {"768 x 768", 0,  (Fl_Callback*)OPTISGui::cb_WindowSize768, 0, 0, 0, 0, 14, 56},
 {"Other ...", 0,  (Fl_Callback*)OPTISGui::cb_WindowSizeOther, 0, 0, 0, 0, 14, 56},
 {0},
 {"LED Control", 0,  (Fl_Callback*)OPTISGui::cb_WindowLEDControl, 0, 0, 0, 0, 14, 56},
 {"Reference LED Control", 0,  (Fl_Callback*)OPTISGui::cb_WindowLEDControl2, 0, 0, 0, 0, 14, 56},
 {0},
 {"Help", 0,  0, 0, 64, 0, 0, 14, 56},
 {"Manual", 0xffbe,  (Fl_Callback*)OPTISGui::cb_HelpManual, 0, 128, 0, 0, 14, 56},
 {"About OPTIS", 0,  (Fl_Callback*)OPTISGui::cb_HelpAbout, 0, 0, 0, 0, 14, 56},
 {0},
 {"Pointer", 0,  0, 0, 64, 0, 0, 14, 56},
 {"MIPT", 0,  (Fl_Callback*)OPTISGui::cb_MIPT, 0, 0, 0, 0, 14, 56},
  {"MIPT cancel", 0,  (Fl_Callback*)OPTISGui::cb_MIPTcancel, 0, 0, 0, 0, 14, 56},
 {0},
 {0}

};
Fl_Menu_Item* OPTISGui::menuFile = OPTISGui::menu_MenuBarLEDViewer + 0;
Fl_Menu_Item* OPTISGui::FileNewPatient = OPTISGui::menu_MenuBarLEDViewer + 1;
Fl_Menu_Item* OPTISGui::FileExport = OPTISGui::menu_MenuBarLEDViewer + 2;
Fl_Menu_Item* OPTISGui::FileExportTrajectories = OPTISGui::menu_MenuBarLEDViewer + 3;
Fl_Menu_Item* OPTISGui::submenuSnapshot = OPTISGui::menu_MenuBarLEDViewer + 5;
Fl_Menu_Item* OPTISGui::sgiSnapshot = OPTISGui::menu_MenuBarLEDViewer + 6;
Fl_Menu_Item* OPTISGui::tifSnapshot = OPTISGui::menu_MenuBarLEDViewer + 7;
Fl_Menu_Item* OPTISGui::gifSnapshot = OPTISGui::menu_MenuBarLEDViewer + 8;
Fl_Menu_Item* OPTISGui::jpgSnapshot = OPTISGui::menu_MenuBarLEDViewer + 9;
Fl_Menu_Item* OPTISGui::otherSnapshot = OPTISGui::menu_MenuBarLEDViewer + 10;
Fl_Menu_Item* OPTISGui::FileClose = OPTISGui::menu_MenuBarLEDViewer + 12;
Fl_Menu_Item* OPTISGui::menuEdit = OPTISGui::menu_MenuBarLEDViewer + 14;
Fl_Menu_Item* OPTISGui::EditSubject = OPTISGui::menu_MenuBarLEDViewer + 15;
Fl_Menu_Item* OPTISGui::EditObjects = OPTISGui::menu_MenuBarLEDViewer + 16;
Fl_Menu_Item* OPTISGui::EditLEDRadius = OPTISGui::menu_MenuBarLEDViewer + 17;
Fl_Menu_Item* OPTISGui::LedR05 = OPTISGui::menu_MenuBarLEDViewer + 18;
Fl_Menu_Item* OPTISGui::LedR10 = OPTISGui::menu_MenuBarLEDViewer + 19;
Fl_Menu_Item* OPTISGui::LedR15 = OPTISGui::menu_MenuBarLEDViewer + 20;
Fl_Menu_Item* OPTISGui::LedR20 = OPTISGui::menu_MenuBarLEDViewer + 21;
Fl_Menu_Item* OPTISGui::LedR25 = OPTISGui::menu_MenuBarLEDViewer + 22;
Fl_Menu_Item* OPTISGui::LedR30 = OPTISGui::menu_MenuBarLEDViewer + 23;
Fl_Menu_Item* OPTISGui::LedR40 = OPTISGui::menu_MenuBarLEDViewer + 24;
Fl_Menu_Item* OPTISGui::LedR50 = OPTISGui::menu_MenuBarLEDViewer + 25;
Fl_Menu_Item* OPTISGui::LedR60 = OPTISGui::menu_MenuBarLEDViewer + 26;
Fl_Menu_Item* OPTISGui::LedR70 = OPTISGui::menu_MenuBarLEDViewer + 27;
Fl_Menu_Item* OPTISGui::LedR80 = OPTISGui::menu_MenuBarLEDViewer + 28;
Fl_Menu_Item* OPTISGui::LedR90 = OPTISGui::menu_MenuBarLEDViewer + 29;
Fl_Menu_Item* OPTISGui::LedR100 = OPTISGui::menu_MenuBarLEDViewer + 30;
Fl_Menu_Item* OPTISGui::EditTrajectories = OPTISGui::menu_MenuBarLEDViewer + 32;
Fl_Menu_Item* OPTISGui::EditBackGroundColor = OPTISGui::menu_MenuBarLEDViewer + 33;
Fl_Menu_Item* OPTISGui::EditPreferences = OPTISGui::menu_MenuBarLEDViewer + 34;
Fl_Menu_Item* OPTISGui::menuView = OPTISGui::menu_MenuBarLEDViewer + 36;
Fl_Menu_Item* OPTISGui::ViewLoad = OPTISGui::menu_MenuBarLEDViewer + 37;
Fl_Menu_Item* OPTISGui::ViewSaveAs = OPTISGui::menu_MenuBarLEDViewer + 38;
Fl_Menu_Item* OPTISGui::ReferenceSystem = OPTISGui::menu_MenuBarLEDViewer + 39;
Fl_Menu_Item* OPTISGui::RSFOV = OPTISGui::menu_MenuBarLEDViewer + 40;
Fl_Menu_Item* OPTISGui::RSObj1 = OPTISGui::menu_MenuBarLEDViewer + 41;
Fl_Menu_Item* OPTISGui::RSObj2 = OPTISGui::menu_MenuBarLEDViewer + 42;
Fl_Menu_Item* OPTISGui::RSObj3 = OPTISGui::menu_MenuBarLEDViewer + 43;
Fl_Menu_Item* OPTISGui::RSObj4 = OPTISGui::menu_MenuBarLEDViewer + 44;
Fl_Menu_Item* OPTISGui::RSObj5 = OPTISGui::menu_MenuBarLEDViewer + 45;
Fl_Menu_Item* OPTISGui::RSObj6 = OPTISGui::menu_MenuBarLEDViewer + 46;
Fl_Menu_Item* OPTISGui::menuInsert = OPTISGui::menu_MenuBarLEDViewer + 49;
Fl_Menu_Item* OPTISGui::InsertTrajectory = OPTISGui::menu_MenuBarLEDViewer + 50;
Fl_Menu_Item* OPTISGui::InsTrajLED = OPTISGui::menu_MenuBarLEDViewer + 51;
Fl_Menu_Item* OPTISGui::InsTrajCoord = OPTISGui::menu_MenuBarLEDViewer + 52;
Fl_Menu_Item* OPTISGui::menuAnimation = OPTISGui::menu_MenuBarLEDViewer + 55;
Fl_Menu_Item* OPTISGui::AnimRecMotion = OPTISGui::menu_MenuBarLEDViewer + 56;
Fl_Menu_Item* OPTISGui::AnimLoadMainMotion = OPTISGui::menu_MenuBarLEDViewer + 57;
Fl_Menu_Item* OPTISGui::AnimLEDCharacteristics = OPTISGui::menu_MenuBarLEDViewer + 58;
Fl_Menu_Item* OPTISGui::AnimStart = OPTISGui::menu_MenuBarLEDViewer + 59;
Fl_Menu_Item* OPTISGui::AnimStop = OPTISGui::menu_MenuBarLEDViewer + 60;
Fl_Menu_Item* OPTISGui::AnimOneFwd = OPTISGui::menu_MenuBarLEDViewer + 61;
Fl_Menu_Item* OPTISGui::AnimOneBwd = OPTISGui::menu_MenuBarLEDViewer + 62;
Fl_Menu_Item* OPTISGui::AnimPlayBwd = OPTISGui::menu_MenuBarLEDViewer + 63;
Fl_Menu_Item* OPTISGui::AnimReset = OPTISGui::menu_MenuBarLEDViewer + 64;
Fl_Menu_Item* OPTISGui::ImpTraj = OPTISGui::menu_MenuBarLEDViewer + 65;
Fl_Menu_Item* OPTISGui::AnimStoreAnim = OPTISGui::menu_MenuBarLEDViewer + 66;
Fl_Menu_Item* OPTISGui::StoreSGI = OPTISGui::menu_MenuBarLEDViewer + 67;
Fl_Menu_Item* OPTISGui::StoreTIF = OPTISGui::menu_MenuBarLEDViewer + 68;
Fl_Menu_Item* OPTISGui::StoreGIF = OPTISGui::menu_MenuBarLEDViewer + 69;
Fl_Menu_Item* OPTISGui::StoreJPEG = OPTISGui::menu_MenuBarLEDViewer + 70;
Fl_Menu_Item* OPTISGui::StoreOther = OPTISGui::menu_MenuBarLEDViewer + 71;
Fl_Menu_Item* OPTISGui::menuCameras = OPTISGui::menu_MenuBarLEDViewer + 74;
Fl_Menu_Item* OPTISGui::cameraNumber = OPTISGui::menu_MenuBarLEDViewer + 75;
Fl_Menu_Item* OPTISGui::camNum03 = OPTISGui::menu_MenuBarLEDViewer + 76;
Fl_Menu_Item* OPTISGui::camNum06 = OPTISGui::menu_MenuBarLEDViewer + 77;
Fl_Menu_Item* OPTISGui::camNum09 = OPTISGui::menu_MenuBarLEDViewer + 78;
Fl_Menu_Item* OPTISGui::camNum12 = OPTISGui::menu_MenuBarLEDViewer + 79;
Fl_Menu_Item* OPTISGui::camNum15 = OPTISGui::menu_MenuBarLEDViewer + 80;
Fl_Menu_Item* OPTISGui::camNum18 = OPTISGui::menu_MenuBarLEDViewer + 81;
Fl_Menu_Item* OPTISGui::camNum21 = OPTISGui::menu_MenuBarLEDViewer + 82;
Fl_Menu_Item* OPTISGui::camNum24 = OPTISGui::menu_MenuBarLEDViewer + 83;
Fl_Menu_Item* OPTISGui::camNum27 = OPTISGui::menu_MenuBarLEDViewer + 84;
Fl_Menu_Item* OPTISGui::camNum30 = OPTISGui::menu_MenuBarLEDViewer + 85;
Fl_Menu_Item* OPTISGui::cameraMatrix = OPTISGui::menu_MenuBarLEDViewer + 87;
Fl_Menu_Item* OPTISGui::cameraConnect = OPTISGui::menu_MenuBarLEDViewer + 88;
Fl_Menu_Item* OPTISGui::cameraDisconnect = OPTISGui::menu_MenuBarLEDViewer + 89;
Fl_Menu_Item* OPTISGui::menuExtra = OPTISGui::menu_MenuBarLEDViewer + 91;
Fl_Menu_Item* OPTISGui::extraCameraTest = OPTISGui::menu_MenuBarLEDViewer + 92;
Fl_Menu_Item* OPTISGui::menuWindow = OPTISGui::menu_MenuBarLEDViewer + 94;
Fl_Menu_Item* OPTISGui::WindowSize = OPTISGui::menu_MenuBarLEDViewer + 95;
Fl_Menu_Item* OPTISGui::WindowSize512 = OPTISGui::menu_MenuBarLEDViewer + 96;
Fl_Menu_Item* OPTISGui::WindowSize640 = OPTISGui::menu_MenuBarLEDViewer + 97;
Fl_Menu_Item* OPTISGui::WindowSize768 = OPTISGui::menu_MenuBarLEDViewer + 98;
Fl_Menu_Item* OPTISGui::WindowSizeOther = OPTISGui::menu_MenuBarLEDViewer + 99;
Fl_Menu_Item* OPTISGui::WindowLEDControl = OPTISGui::menu_MenuBarLEDViewer + 101;
Fl_Menu_Item* OPTISGui::WindowLEDControl2 = OPTISGui::menu_MenuBarLEDViewer + 102;

Fl_Menu_Item* OPTISGui::menuHelp = OPTISGui::menu_MenuBarLEDViewer + 104;
Fl_Menu_Item* OPTISGui::HelpManual = OPTISGui::menu_MenuBarLEDViewer + 105;
Fl_Menu_Item* OPTISGui::HelpAbout = OPTISGui::menu_MenuBarLEDViewer + 106;
//Fl_Menu_Item* OPTISGui::menupointer = OPTISGui::menu_MenuBarLEDViewer + 107;

inline void OPTISGui::cb_RecMotionBtn_i(Fl_Button*, void*) {
  ObjectData *tmpdata;
int i, num, j;
char c, message[260];
char st[256];

PlayBackwardMotionBtn->value(0);
StartMotionBtn->value(0);
StopMotionBtn->value(0);
//abcd1234
//060814
if (RecMotionBtn->value() == 0)
{
   StopMotionBtn->value(0);
   printf("stop button\n");
   for (i=0; i<260; i++)
      message[i] = '\0';
   sprintf(message, "a");
   c = csoc.SendMsg(&message[0], 260);
   MotionNameOutput->color(7); //make the color to white in the name window
   MotionNameOutput->redraw();
   getNewRecordingText();
}//

if (RecMotionBtn->value() < 1)
{
   trajOk = 0;
   return;
}

if (csoc.connected == 0)
{
   RecMotionBtn->value(0);
   cameraConnect->do_callback(MenuBarLEDViewer);
   return;
}

for (i=0; i<260; i++)
   message[i] = '\0';
sprintf(message, "s");
do
{
   c = csoc.SendMsg(&message[0], 260);
   if (c < 0)
       socketStopped = 1;
   Fl::check();
} while ((c < 1)&&(socketStopped == 0)&&(csoc.connected>0));
   if(socketStopped > 0)
   {
      csoc.CloseSocket();
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }
   if (csoc.connected == 0)
   {
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }
//fl_message("This button is not yet in use.");
//RecMotionBtn->value(0);

for (j=0; j<(numCams/3); j++)//each camera systems
{
   for (i=0; i<18; i++)//each LED
   {
      num = mainAnimation->led[(j*18)+i].getNum();
      if (num > 1)
         mainAnimation->led[(j*18)+i].deleteValues(0, num-1);
   }
   num = mainAnimation->click[j].getNum();
   if (num > 1)
      mainAnimation->click[j].deleteValues(0, num-1);
}
num = mainAnimation->click[0].getNum();
mainAnimation->num_steps = num;
mainAnimation->animation_step = num-1;

//RSObj1->do_callback(MenuBarLEDViewer);
//RSObj1->setonly();
//mainAnimation->setRSnr(0);
i = 0;
tmpdata = objview->objlist;
/*for (j=0; j<numCamSys; j++)
{
   while (tmpdata != NULL)
   {
//      if (tmpdata->type == (205+1000*j)) //trajectory LED 6
      if (tmpdata->type == (200+1000*j)) //trajectory LED 1
         i++;
      tmpdata = tmpdata->next;
   }
   if (i == 0)
//      insertLEDTrajectory(5, j); //insert traj LED 6
      insertLEDTrajectory(0, j); //insert traj LED 1
}*/
resetTrajectories();
trajStep = 0;
trajOk = 1;

//   sprintf(st, "%s%d", mainAnimation->flname,filecount);
   sprintf(st, "%s%d.mvm", scnfile->scanmov.base,filecount);
   MotionNameOutput->value(st); //put the file name
   MotionNameOutput->color(1);  //make the color to red in the name window
   MotionNameOutput->redraw();

}
void OPTISGui::cb_RecMotionBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_RecMotionBtn_i(o,v);
}

inline void OPTISGui::cb_LoadMotionBtn_i(Fl_Button*, void* v) {
  char    st[256], filename[256], comment[256];
dirent  **list;	
int     n, i, len, maxlen, j;
FILE    *readfile;

PlayBackwardMotionBtn->value(0);
StartMotionBtn->value(0);
StopMotionBtn->value(0);
RecMotionBtn->value(0);
trajOk = 0;

if (csoc.connected > 0)
{
   if (!fl_ask("Do you really want to disconnect the cameras and load a motion?"))
   {
      LoadMotionBtn->value(0);
      return;
   }
   socketStopped = 1;
   disconnectSocket();
}

StepSlider->activate();
StepNrOutput->activate();
sprintf(st, "%s/%s/", pref->datapath, scnfile->scanmov.path);
maxlen = 0;
list = NULL;
n = fl_filename_list(&st[0], &list);
for(i=2; i<n; i++)
{
   sprintf(st, "%s", list[i]->d_name);
   len = strlen(st);
//   if ((st[len-3]=='m')&&(st[len-2]=='v')&&(st[len-1]=='m'))
//   if ((st[len-3]!='e')&&(st[len-2]!='n')&&(st[len-1]!='t'))
   if (((st[len-3]=='m')&&(st[len-2]=='v')&&(st[len-1]=='m'))||(st[len-3]=='.'))
   {
      if (len > maxlen)
         maxlen = len;
   }
}
MotionBrowser->clear();
for(i=2; i<n; i++)
{
   sprintf(st, "%s", list[i]->d_name);
   len = strlen(st);
//   if ((len>0)&&(st[len-3]=='m')&&(st[len-2]=='v')&&(st[len-1]=='m'))
//   if ((len>0)&&(st[len-3]!='e')&&(st[len-2]!='n')&&(st[len-1]!='t'))
   if (((len>0)&&(st[len-3]=='m')&&(st[len-2]=='v')&&(st[len-1]=='m'))||((len>0)&&(st[len-3]=='.')))
   {
      for(j=len; ((j<maxlen+5)&&(j<254)); j++)
         st[j] = ' ';
      if ((maxlen+5)<256)
         st[maxlen+5] = '\0';
      else
         st[255] = '\0';
      sprintf(filename, "%s/%s/%s", pref->datapath, scnfile->scanmov.path, list[i]->d_name);
      if((readfile = fopen(&filename[0], "rb")) != NULL)
      {
         fseek(readfile, 0, SEEK_SET);
         fread(comment, 256, 1, readfile);
         comment[256] = '\0';
         fclose(readfile);
         strcat(st, comment);
      }
      MotionBrowser->add(&st[0]);
   }
}
for(i=n; i>0;)
   free((void*)(list[--i]));
free((void*)list);
LoadMotionBtn->value(1);
MotionWindow->size_range(400, 200, 0, 0, 0, 0, 0);
MotionWindow->show();
}
void OPTISGui::cb_LoadMotionBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LoadMotionBtn_i(o,v);
}

inline void OPTISGui::cb_ResetMotionBtn_i(Fl_Button*, void*) {
  PlayBackwardMotionBtn->value(0);
StartMotionBtn->value(0);
StopMotionBtn->value(0);

if (mainAnimation == NULL)
   return;
if (csoc.connected > 0)
   return;

mainAnimation->resetStep();
applyMotion(0);
}
void OPTISGui::cb_ResetMotionBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ResetMotionBtn_i(o,v);
}

inline void OPTISGui::cb_PlayBackwardMotionBtn_i(Fl_Button*, void*) {
  clock_t start, finish;
double duration, length, speed;
long step;

if ((mainAnimation == NULL)||(csoc.connected > 0))
{
   PlayBackwardMotionBtn->value(0);
   return;
}

StartMotionBtn->value(0);
StopMotionBtn->value(0);
speed = SpeedSlider->value();
//length = 0.01487*(mainAnimation->num_steps-1.0)/speed;
length = mainAnimation->freq*(mainAnimation->num_steps-1.0)/speed;
start = clock();
if (mainAnimation->animation_step > 0)
{
/*   start -= (clock_t)((mainAnimation->num_steps-mainAnimation->animation_step)
                      *0.01487/speed*CLOCKS_PER_SEC);*/
   start -= (clock_t)((mainAnimation->num_steps-mainAnimation->animation_step)
                      *mainAnimation->freq/speed*CLOCKS_PER_SEC);
}
while (PlayBackwardMotionBtn->value() > 0)
{
   if (FilmButton->value() > 0)
      mainAnimation->oneStepBackward();
   else
   {
      if (speed != SpeedSlider->value())
      {
         start = finish-((finish-start)*(speed/SpeedSlider->value()));
         speed = SpeedSlider->value();
//         length = 0.01487*(mainAnimation->num_steps-1.0)/speed;
         length = mainAnimation->freq*(mainAnimation->num_steps-1.0)/speed;
      }
      finish = clock();
      duration = (double)(finish - start) / CLOCKS_PER_SEC;
      duration /= length;
      if (duration > 1.0)
      {
         step = (long)duration;
         duration -= (double)step;
      }
      step = (long)(double(duration*(mainAnimation->num_steps-1.0)));
      step = mainAnimation->num_steps-1-step;
      mainAnimation->goToStep(step);
   }
   applyMotion(-1);
   if ((FilmButton->value() > 0) && (recBase != NULL))
   {
      objview->saveImage(recBase, &imgFormat[0], recStep, pref->imgcopy, pref->extracode);
      recStep++;
   }
   Fl::check();
   if (PlayBackwardMotionBtn->value() == 0)
   {
      StopMotionBtn->value(0);
   }
};
}
void OPTISGui::cb_PlayBackwardMotionBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_PlayBackwardMotionBtn_i(o,v);
}

inline void OPTISGui::cb_RwdMotionBtn_i(Fl_Repeat_Button*, void*) {
  PlayBackwardMotionBtn->value(0);
StartMotionBtn->value(0);
StopMotionBtn->value(0);

if ((mainAnimation == NULL)||(csoc.connected > 0))
   return;

mainAnimation->oneStepBackward();
applyMotion(-1);
if ((FilmButton->value() > 0) && (recBase != NULL))
{
   objview->saveImage(recBase, &imgFormat[0], recStep, pref->imgcopy, pref->extracode);
   recStep++;
};
}
void OPTISGui::cb_RwdMotionBtn(Fl_Repeat_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_RwdMotionBtn_i(o,v);
}

inline void OPTISGui::cb_StopMotionBtn_i(Fl_Button*, void*) {
  char c, message[260];
int i;

StartMotionBtn->value(0);
PlayBackwardMotionBtn->value(0);
RecMotionBtn->value(0);
trajOk = 0;
if (csoc.connected>0)
{
   for (i=0; i<260; i++)
      message[i] = '\0';
   sprintf(message, "a");
   do
   {
      c = csoc.SendMsg(&message[0], 260);
      if (c < 0)
         socketStopped = 1;
      Fl::check();
   } while ((c < 1)&&(socketStopped == 0)&&(csoc.connected>0));
   if(socketStopped > 0)
   {
      csoc.CloseSocket();
      CameraOkBox->color(1);
      CameraOkBox->redraw();
   }
   if (csoc.connected == 0)
   {
      CameraOkBox->color(1);
      CameraOkBox->redraw();
   }
   MotionNameOutput->color(7); //make the color to white in the name window
   MotionNameOutput->redraw();

   getNewRecordingText();
};
}
void OPTISGui::cb_StopMotionBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_StopMotionBtn_i(o,v);
}

inline void OPTISGui::cb_FwdMotionBtn_i(Fl_Repeat_Button*, void*) {
  PlayBackwardMotionBtn->value(0);
StartMotionBtn->value(0);
StopMotionBtn->value(0);

if ((mainAnimation == NULL)||(csoc.connected > 0))
   return;

mainAnimation->oneStepForward();
applyMotion(1);
if ((FilmButton->value() > 0) && (recBase != NULL))
{
   objview->saveImage(recBase, &imgFormat[0], recStep, pref->imgcopy, pref->extracode);
   recStep++;
};
}
void OPTISGui::cb_FwdMotionBtn(Fl_Repeat_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_FwdMotionBtn_i(o,v);
}

inline void OPTISGui::cb_StartMotionBtn_i(Fl_Button*, void*) {
  clock_t start, finish;
double duration, length, speed;
double step;

if ((mainAnimation == NULL)||(csoc.connected > 0))
{
   StartMotionBtn->value(0);
   return;
}
PlayBackwardMotionBtn->value(0);
StopMotionBtn->value(0);
speed = SpeedSlider->value();
//length = 0.005*(mainAnimation->num_steps-1.0)/speed;
length = mainAnimation->freq*(mainAnimation->num_steps-1.0)/speed;
start = clock();
if (mainAnimation->animation_step > 0)
{
//   start -= (clock_t)((mainAnimation->animation_step+1)*0.005/speed*CLOCKS_PER_SEC);
   start -= (clock_t)((mainAnimation->animation_step+1)*mainAnimation->freq/speed*CLOCKS_PER_SEC);
}
while (StartMotionBtn->value() > 0)
{
   if (FilmButton->value() > 0)
      mainAnimation->oneStepForward();
   else
   {
      if (speed != SpeedSlider->value())
      {
         start = finish-((finish-start)*(speed/SpeedSlider->value()));
         speed = SpeedSlider->value();
//         length = 0.005*(mainAnimation->num_steps-1.0)/speed;
         length = mainAnimation->freq*(mainAnimation->num_steps-1.0)/speed;
      }
      finish = clock();
      duration = (double)(finish - start) / CLOCKS_PER_SEC;
      duration /= length;
      if (duration > 1.0)
      {
         step = floor(duration);
         duration -= step;
         start = finish - ((clock_t)(duration*CLOCKS_PER_SEC));
      }
      step = (double(duration*(mainAnimation->num_steps-1.0)));
      mainAnimation->goToStep(step);
   }
   applyMotion(1);
   if ((FilmButton->value() > 0) && (recBase != NULL))
   {
      objview->saveImage(recBase, &imgFormat[0], recStep, pref->imgcopy, pref->extracode);
      recStep++;
   }
   Fl::check();
   if (StartMotionBtn->value() == 0)
   {
      StopMotionBtn->value(0);
   }
};
}
void OPTISGui::cb_StartMotionBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_StartMotionBtn_i(o,v);
}

inline void OPTISGui::cb_StepSlider_i(Fl_Slider*, void*) {
  if (RecMotionBtn->value() > 0)
   return;

StartMotionBtn->value(0);
PlayBackwardMotionBtn->value(0);
if (mainAnimation == NULL)
   return;
mainAnimation->goToStep(StepSlider->value());
if (mainAnimation->click[0][(long)StepSlider->value()]>0)
   objview->scenemanager->setBackgroundColor(SbColor(1.0,
      1.0, 0.0));
else
   objview->scenemanager->setBackgroundColor(SbColor(objview->backgroundcolor[0],
     objview->backgroundcolor[1], objview->backgroundcolor[2]));
applyMotion(0);
}
void OPTISGui::cb_StepSlider(Fl_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_StepSlider_i(o,v);
}

inline void OPTISGui::cb_StepNrOutput_i(Fl_Value_Input*, void*) {
  if (RecMotionBtn->value() > 0)
   return;
if (mainAnimation == NULL)
{
   StepNrOutput->value(0);
   return;
}
if (StepNrOutput->value() > mainAnimation->num_steps)
   StepNrOutput->value(mainAnimation->num_steps);
if (StepNrOutput->value() < 1)
   StepNrOutput->value(1);

mainAnimation->goToStep(StepNrOutput->value()-1);
applyMotion(0);
}
void OPTISGui::cb_StepNrOutput(Fl_Value_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_StepNrOutput_i(o,v);
}

inline void OPTISGui::cb_objview_i(ObjectViewer*, void*) {
  objview->reshape(objview->w(), objview->h());
objview->redraw();
}
void OPTISGui::cb_objview(ObjectViewer* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_objview_i(o,v);
}

inline void OPTISGui::cb_FilmButton_i(Fl_Button*, void*) {
  const char *format;
char st[10];

PlayBackwardMotionBtn->value(0);
StartMotionBtn->value(0);
StopMotionBtn->value(0);

if (FilmButton->value() < 1)
   return;
if (mainAnimation == NULL)
{
   FilmButton->value(0);
   recBase = NULL;
   return;
}
format = fl_input("Store Animation: Enter the Format Extension", &imgFormat[0]);
if (format != NULL)
{
   if (strlen(format) > 9)
   {
      fl_message("Invalid File Format");
      return;
   }
   else
      sprintf(imgFormat, "%s", format);
}
else
{
   FilmButton->value(0);
   recBase = NULL;
   return;
}
sprintf(st, "*.%s", imgFormat);
recBase = fl_file_chooser("Store Animation: Enter Directory and File Name without Extension...", &st[0], NULL);
if (recBase == NULL)
{
   FilmButton->value(0);
   return;
}
recStep = 1;
}
void OPTISGui::cb_FilmButton(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_FilmButton_i(o,v);
}

inline void OPTISGui::cb_PhotoButton_i(Fl_Button*, void*) {
  const char *format;
char st[10];

format = fl_input("Snapshot: Enter the Format Extension", &imgFormat[0]);
if (format == NULL)
   return;
if (strlen(format) > 9)
{
   fl_message("Invalid File Format");
   return;
}
sprintf(imgFormat, "%s", format);
sprintf(st, "*.%s", format);
recBase = fl_file_chooser("Snapshot: Enter Directory and File Name (without Extension)", &st[0], NULL);
if (recBase != NULL)
   objview->saveImage(recBase, &imgFormat[0], -1, pref->imgcopy, pref->extracode);
}
void OPTISGui::cb_PhotoButton(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_PhotoButton_i(o,v);
}



inline void OPTISGui::cb_AppAxisBtn_i(Fl_Button*, void*) {
	objview->appflag ^= 1;
	ObjectData *tmpdata;

tmpdata = objview->objlist;
if(objview->appflag ==1){
while (tmpdata != NULL)
{
   objview->getLabel(tmpdata,&tmpdata->oldlabel[0]);
	if(!strcmp(&tmpdata->oldlabel[0],"X")){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"Y")){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"Z")){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"Scale Values")){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"Scale Lines")){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"FOV")){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
    }
      tmpdata = tmpdata->next;
}
}else{
while (tmpdata != NULL)
{
   objview->getLabel(tmpdata,&tmpdata->oldlabel[0]);
	if(!strcmp(&tmpdata->oldlabel[0],"X")){
       tmpdata->drawstyle->style = SoDrawStyle::FILLED;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"Y")){
       tmpdata->drawstyle->style = SoDrawStyle::FILLED;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"Z")){
       tmpdata->drawstyle->style = SoDrawStyle::FILLED;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"Scale Values")){
       tmpdata->drawstyle->style = SoDrawStyle::FILLED;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"Scale Lines")){
       tmpdata->drawstyle->style = SoDrawStyle::LINES;
       objview->redraw();
	}else if(!strcmp(&tmpdata->oldlabel[0],"FOV")){
       tmpdata->drawstyle->style = SoDrawStyle::LINES;
       objview->redraw();
	}
      tmpdata = tmpdata->next;
}
}

}
void OPTISGui::cb_AppAxisBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_AppAxisBtn_i(o,v);
}

inline void OPTISGui::cb_AppTF1Btn_i(Fl_Button*, void*) {
	int i;
	objview->appTF1flag ^= 1;
	ObjectData *tmpdata;

if(objview->appTF1flag ==1){

   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[0][i] == 0){
         tmpdata = objview->objlist;
         while (tmpdata != NULL)
		 {
            if(tmpdata->type==i+100){
				tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
				pref->LEDdrawstyle[0] = 3;
				objview->redraw();
			}
			tmpdata = tmpdata->next;
		 }
	  }
   }
   tmpdata = objview->objlist;
   while (tmpdata != NULL)
   {
      if(tmpdata->type==2){
         tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
         objview->redraw();
	  }
	  tmpdata = tmpdata->next;
   }

}else{

   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[0][i] == 0){
         tmpdata = objview->objlist;
		 while (tmpdata != NULL)
		 {
			 if(tmpdata->type==i+100){
				 tmpdata->drawstyle->style = SoDrawStyle::FILLED;
				 pref->LEDdrawstyle[0] = 0;
				 objview->redraw();
			 }
			 tmpdata = tmpdata->next;
		 }
	  }
   }
   tmpdata = objview->objlist;
   while (tmpdata != NULL)
   {
      if(tmpdata->type==2){
         tmpdata->drawstyle->style = SoDrawStyle::FILLED;
         objview->redraw();
	  }
	  tmpdata = tmpdata->next;
   }

}

}
void OPTISGui::cb_AppTF1Btn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_AppTF1Btn_i(o,v);
}

inline void OPTISGui::cb_AppTF2Btn_i(Fl_Button*, void*) {
	int i;
	objview->appTF2flag ^= 1;
	ObjectData *tmpdata;

if(objview->appTF2flag ==1){
   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[0][i] == 1){
         tmpdata = objview->objlist;
         while (tmpdata != NULL)
		 {
            if(tmpdata->type==i+100){
				tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
				pref->LEDdrawstyle[0] = 3;
				objview->redraw();
			}
			tmpdata = tmpdata->next;
		 }
	  }
   }
   tmpdata = objview->objlist;
   while (tmpdata != NULL)
   {
      if(tmpdata->type==3){
         tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
         objview->redraw();
	  }
	  tmpdata = tmpdata->next;
   }

}else{
   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[0][i] == 1){
         tmpdata = objview->objlist;
		 while (tmpdata != NULL)
		 {
			 if(tmpdata->type==i+100){
				 tmpdata->drawstyle->style = SoDrawStyle::FILLED;
				 pref->LEDdrawstyle[0] = 0;
				 objview->redraw();
			 }
			 tmpdata = tmpdata->next;
		 }
	  }
   }
   tmpdata = objview->objlist;
   while (tmpdata != NULL)
   {
      if(tmpdata->type==3){
         tmpdata->drawstyle->style = SoDrawStyle::FILLED;
         objview->redraw();
	  }
	  tmpdata = tmpdata->next;
   }

}

}
void OPTISGui::cb_AppTF2Btn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_AppTF2Btn_i(o,v);
}

inline void OPTISGui::cb_AppTF3Btn_i(Fl_Button*, void*) {
	int i;
	objview->appTF3flag ^= 1;
	ObjectData *tmpdata;

if(objview->appTF3flag ==1){
   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[0][i] == 2){
         tmpdata = objview->objlist;
         while (tmpdata != NULL)
		 {
            if(tmpdata->type==i+100){
				tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
				pref->LEDdrawstyle[0] = 3;
				objview->redraw();
			}
			tmpdata = tmpdata->next;
		 }
	  }
   }
   tmpdata = objview->objlist;
   while (tmpdata != NULL)
   {
      if(tmpdata->type==4){
         tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
         objview->redraw();
	  }
	  tmpdata = tmpdata->next;
   }

}else{
   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[0][i] == 2){
         tmpdata = objview->objlist;
		 while (tmpdata != NULL)
		 {
			 if(tmpdata->type==i+100){
				 tmpdata->drawstyle->style = SoDrawStyle::FILLED;
				 pref->LEDdrawstyle[0] = 0;
				 objview->redraw();
			 }
			 tmpdata = tmpdata->next;
		 }
	  }
   }
   tmpdata = objview->objlist;
   while (tmpdata != NULL)
   {
      if(tmpdata->type==4){
         tmpdata->drawstyle->style = SoDrawStyle::FILLED;
         objview->redraw();
	  }
	  tmpdata = tmpdata->next;
   }

}

}
void OPTISGui::cb_AppTF3Btn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_AppTF3Btn_i(o,v);
}

inline void OPTISGui::cb_AppCOSBtn_i(Fl_Button*, void*) {
	int i,j,cnum;
	int cnum_flag[7];
	objview->appcoordflag ^= 1;
	ObjectData *tmpdata;

if(objview->appcoordflag ==1){
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
	if(tmpdata->type==2 || tmpdata->type==3 || tmpdata->type==4 || 
	    tmpdata->type==5 || tmpdata->type==6 || tmpdata->type==7){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
    }
      tmpdata = tmpdata->next;
}
}else{
for (j=0; j<6; j++)cnum_flag[j]=0;
for (j=0; j<6; j++)
{
   cnum=0;
   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[0][i] == j)
      {
		 tmpdata = objview->objlist;
		 while (tmpdata != NULL)
		 {
			if(tmpdata->type==(100+i) && (tmpdata->drawstyle->style.getValue() == SoDrawStyle::INVISIBLE))
			{
			cnum++;
			}
		 tmpdata = tmpdata->next;
		 }
   if(cnum==3) cnum_flag[j]=1;
      
	  }
   }
}
	
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
	if(tmpdata->type==2 || tmpdata->type==3 || tmpdata->type==4 || 
	    tmpdata->type==5 || tmpdata->type==6 || tmpdata->type==7){
		if(cnum_flag[tmpdata->type-2]==1)
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
		else
       tmpdata->drawstyle->style = SoDrawStyle::FILLED;
       objview->redraw();
	}
      tmpdata = tmpdata->next;
}




}
}

void OPTISGui::cb_AppCOSBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_AppCOSBtn_i(o,v);
}

inline void OPTISGui::cb_AppledBtn_i(Fl_Button*, void*) {
	objview->appledflag ^= 1;
	ObjectData *tmpdata;

tmpdata = objview->objlist;
if(objview->appledflag ==1){
while (tmpdata != NULL)
{
	if(tmpdata->type==100 || tmpdata->type==101 || tmpdata->type==102 || 
		tmpdata->type==103 || tmpdata->type==104 || tmpdata->type==105){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
	}else if(tmpdata->type==106 || tmpdata->type==107 || tmpdata->type==108 ||
	    tmpdata->type==109 || tmpdata->type==110 || tmpdata->type==111){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
	}else if(tmpdata->type==112 || tmpdata->type==113 || tmpdata->type==114 || 
	    tmpdata->type==115 || tmpdata->type==116 || tmpdata->type==117){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
	}else if(tmpdata->type==2 || tmpdata->type==3 || tmpdata->type==4 || 
	    tmpdata->type==5 || tmpdata->type==6 || tmpdata->type==7){
       tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
       objview->redraw();
    }
      tmpdata = tmpdata->next;
}
}else{
while (tmpdata != NULL)
{
	if(tmpdata->type==100 || tmpdata->type==101 || tmpdata->type==102 || 
		tmpdata->type==103 || tmpdata->type==104 || tmpdata->type==105){
       tmpdata->drawstyle->style = SoDrawStyle::FILLED;
       objview->redraw();
	}else if(tmpdata->type==106 || tmpdata->type==107 || tmpdata->type==108 ||
	    tmpdata->type==109 || tmpdata->type==110 || tmpdata->type==111){
       tmpdata->drawstyle->style = SoDrawStyle::FILLED;
       objview->redraw();
	}else if(tmpdata->type==112 || tmpdata->type==113 || tmpdata->type==114 || 
	    tmpdata->type==115 || tmpdata->type==116 || tmpdata->type==117){
       tmpdata->drawstyle->style = SoDrawStyle::FILLED;
       objview->redraw();
	}else if(tmpdata->type==2 || tmpdata->type==3 || tmpdata->type==4 || 
	    tmpdata->type==5 || tmpdata->type==6 || tmpdata->type==7){
       tmpdata->drawstyle->style = SoDrawStyle::FILLED;
       objview->redraw();
	}
      tmpdata = tmpdata->next;
}
}
}

void OPTISGui::cb_AppledBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_AppledBtn_i(o,v);
}

inline void OPTISGui::cb_RotX_i(Fl_Roller*, void*) {
  float wert, diff;

wert = RotX->value();
diff = wert - oldRotX;
if (wert > 180.0)
   RotX->value(wert-360.0);
if (wert < -180.0)
   RotX->value(wert+360.0);

objview->RotateX(-diff/180.0*3.14159);
oldRotX = wert;
}
void OPTISGui::cb_RotX(Fl_Roller* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_RotX_i(o,v);
}

inline void OPTISGui::cb_TransY_i(Fl_Roller*, void*) {
  objview->setLocator3D(SbVec2s((objview->w()/2),(objview->h()/2)));
objview->panCamera(SbVec2s((objview->w()/2), (objview->h()/2)+(oldTransY-TransY->value())));
oldTransY = TransY->value();
}
void OPTISGui::cb_TransY(Fl_Roller* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_TransY_i(o,v);
}

inline void OPTISGui::cb_RotY_i(Fl_Roller*, void*) {
  float wert, diff;

wert = RotY->value();
diff = wert - oldRotY;
if (wert > 180.0)
   RotY->value(wert-360.0);
if (wert < -180.0)
   RotY->value(wert+360.0);

objview->RotateY(-diff/180.0*3.14159);
oldRotY = wert;
}
void OPTISGui::cb_RotY(Fl_Roller* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_RotY_i(o,v);
}
//20130207
inline void OPTISGui::cb_TransX_i(Fl_Roller*, void*) {
  objview->setLocator3D(SbVec2s((objview->w()/2),(objview->h()/2)));
objview->panCamera(SbVec2s((objview->w()/2)+(oldTransX-TransX->value()), (objview->h()/2)));
oldTransX = TransX->value();
}
void OPTISGui::cb_TransX(Fl_Roller* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_TransX_i(o,v);
}

inline void OPTISGui::cb_ZView_i(Fl_Button*, void*) //Change X,Y,Z View functions to suit mechanical models
{
  objview->resetView();
oldTransX = 0.0;
oldTransY = 0.0;
oldZoom = 0.0;
TransX->value(oldTransX);
TransY->value(oldTransY);
Zoom->value(oldZoom);
objview->RotateZ(-1.5708);
objview->RotateY(-1.5708*2.0);
objview->redraw();
}
void OPTISGui::cb_ZView(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ZView_i(o,v);
}

inline void OPTISGui::cb_XView_i(Fl_Button*, void*) {
  objview->resetView();
oldTransX = 0.0;
oldTransY = 0.0;
oldZoom = 0.0;
TransX->value(oldTransX);
TransY->value(oldTransY);
Zoom->value(oldZoom);
objview->RotateY(-1.5708);
objview->redraw();
}
void OPTISGui::cb_XView(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_XView_i(o,v);
}

inline void OPTISGui::cb_YView_i(Fl_Button*, void*) {
  objview->resetView();
oldTransX = 0.0;
oldTransY = 0.0;
oldZoom = 0.0;
TransX->value(oldTransX);
TransY->value(oldTransY);
Zoom->value(oldZoom);
objview->RotateX(1.5708);
objview->redraw();
}
void OPTISGui::cb_YView(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_YView_i(o,v);
}

inline void OPTISGui::cb_FView_i(Fl_Button*, void*) {
  objview->resetView();
oldTransX = 0.0;
oldTransY = 0.0;
oldZoom = 0.0;
TransX->value(oldTransX);
TransY->value(oldTransY);
Zoom->value(oldZoom);
objview->RotateZ(1.5708);
objview->RotateX(1.5708);
objview->redraw();
}
void OPTISGui::cb_FView(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_FView_i(o,v);
}
inline void OPTISGui::cb_SView_i(Fl_Button*, void*) {
  objview->resetView();
oldTransX = 0.0;
oldTransY = 0.0;
oldZoom = 0.0;
TransX->value(oldTransX);
TransY->value(oldTransY);
Zoom->value(oldZoom);
objview->RotateZ(1.5708*2.0);
objview->RotateX(1.5708);
objview->redraw();
}
void OPTISGui::cb_SView(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_SView_i(o,v);
}
inline void OPTISGui::cb_HView_i(Fl_Button*, void*) {
  objview->resetView();
oldTransX = 0.0;
oldTransY = 0.0;
oldZoom = 0.0;
TransX->value(oldTransX);
TransY->value(oldTransY);
Zoom->value(oldZoom);
objview->RotateZ(1.5708);
objview->redraw();
}
void OPTISGui::cb_HView(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_HView_i(o,v);
}

inline void OPTISGui::cb_transparency_slider2_i(Fl_Value_Slider*, void*) {
  objdata->material->transparency.setValue(transparency_slider2->value());
objview->redraw();
}
void OPTISGui::cb_transparency_slider2(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_transparency_slider2_i(o,v);
}

//Object Window
inline void OPTISGui::cb_ObjWindow_i(Fl_Choice*, void*) {
  setObjectEditorValuesCB2();
}
void OPTISGui::cb_ObjWindow(Fl_Choice* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ObjWindow_i(o,v);
}

inline void OPTISGui::cb_RotZ_i(Fl_Roller*, void*) {
  float wert, diff;

wert = RotZ->value();
diff = wert - oldRotZ;
if (wert > 180.0)
   RotZ->value(wert-360.0);
if (wert < -180.0)
   RotZ->value(wert+360.0);

objview->RotateZ(diff/180.0*3.14159);
oldRotZ = wert;
}
void OPTISGui::cb_RotZ(Fl_Roller* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_RotZ_i(o,v);
}

inline void OPTISGui::cb_Zoom_i(Fl_Roller*, void*) {
  objview->dollyCamera((float)(oldZoom-Zoom->value())/40.0);
oldZoom = Zoom->value();
}
void OPTISGui::cb_Zoom(Fl_Roller* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_Zoom_i(o,v);
}

inline void OPTISGui::cb_ObjectChoice_i(Fl_Choice*, void*) {
  setObjectEditorValuesCB();
}
void OPTISGui::cb_ObjectChoice(Fl_Choice* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_ObjectChoice_i(o,v);
}

inline void OPTISGui::cb_EditObjectNameBtn_i(Fl_Button*, void*) {
  ObjectData *tmpdata;
const char *newname;
char oldname[256];
int j;

objview->getLabel(objdata,&oldname[0]);
newname = fl_input("Enter new name:", &oldname[0]);

if (newname != NULL)
{
   j = ObjectChoice->value();
   objview->setLabel(objdata, (char*)newname);
   ObjectChoice->clear();
   tmpdata = objview->objlist;
   while(tmpdata != NULL)
   {
      objview->getLabel(tmpdata,&oldname[0]);
      ObjectChoice->add(oldname, 0, 0, 0, 0);
      tmpdata = tmpdata->next;
   }
   ObjectChoice->value(j);
};
}
void OPTISGui::cb_EditObjectNameBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_EditObjectNameBtn_i(o,v);
}

inline void OPTISGui::cb_SolidRadio_i(Fl_Check_Button*, void*) {
  PointSizeSlider->deactivate();
LineWidthSlider->deactivate();
LinePatternSlider->deactivate();

objdata->drawstyle->style = SoDrawStyle::FILLED;
objview->redraw();
}
void OPTISGui::cb_SolidRadio(Fl_Check_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_SolidRadio_i(o,v);
}

inline void OPTISGui::cb_LineRadio_i(Fl_Check_Button*, void*) {
  PointSizeSlider->deactivate();
LineWidthSlider->activate();
LinePatternSlider->activate();

objdata->drawstyle->style = SoDrawStyle::LINES;
objview->redraw();
}
void OPTISGui::cb_LineRadio(Fl_Check_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_LineRadio_i(o,v);
}

inline void OPTISGui::cb_PointRadio_i(Fl_Check_Button*, void*) {
  LineWidthSlider->deactivate();
LinePatternSlider->deactivate();
PointSizeSlider->activate();

objdata->drawstyle->style = SoDrawStyle::POINTS;
objview->redraw();
}
void OPTISGui::cb_PointRadio(Fl_Check_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PointRadio_i(o,v);
}

inline void OPTISGui::cb_HideRadio_i(Fl_Check_Button*, void*) {
  PointSizeSlider->deactivate();
LineWidthSlider->deactivate();
LinePatternSlider->deactivate();

objdata->drawstyle->style = SoDrawStyle::INVISIBLE;
objview->redraw();
}
void OPTISGui::cb_HideRadio(Fl_Check_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_HideRadio_i(o,v);
}

inline void OPTISGui::cb_PointSizeSlider_i(Fl_Value_Slider*, void*) {
  objdata->drawstyle->pointSize = PointSizeSlider->value();
objview->redraw();
}
void OPTISGui::cb_PointSizeSlider(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PointSizeSlider_i(o,v);
}

inline void OPTISGui::cb_LineWidthSlider_i(Fl_Value_Slider*, void*) {
  objdata->drawstyle->lineWidth = LineWidthSlider->value();
objview->redraw();
}
void OPTISGui::cb_LineWidthSlider(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_LineWidthSlider_i(o,v);
}

inline void OPTISGui::cb_LinePatternSlider_i(Fl_Value_Slider*, void*) {
  objdata->drawstyle->linePattern = 
   (short)(65535.0/100.0*LinePatternSlider->value());
objview->redraw();
}
void OPTISGui::cb_LinePatternSlider(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_LinePatternSlider_i(o,v);
}

inline void OPTISGui::cb_ambient_red_i(Fl_Value_Slider*, void*) {
  objdata->material->ambientColor.setValue(ambient_red->value(),
   ambient_green->value(), ambient_blue->value());
objview->redraw();
}
void OPTISGui::cb_ambient_red(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ambient_red_i(o,v);
}

inline void OPTISGui::cb_diffuse_red_i(Fl_Value_Slider*, void*) {
  objdata->material->diffuseColor.setValue(diffuse_red->value(),
   diffuse_green->value(), diffuse_blue->value());
objview->redraw();
}
void OPTISGui::cb_diffuse_red(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_diffuse_red_i(o,v);
}

inline void OPTISGui::cb_emission_red_i(Fl_Value_Slider*, void*) {
  objdata->material->emissiveColor.setValue(emission_red->value(),
   emission_green->value(), emission_blue->value());
objview->redraw();
}
void OPTISGui::cb_emission_red(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_emission_red_i(o,v);
}

inline void OPTISGui::cb_specular_red_i(Fl_Value_Slider*, void*) {
  objdata->material->specularColor.setValue(specular_red->value(),
   specular_green->value(), specular_blue->value());
objview->redraw();
}
void OPTISGui::cb_specular_red(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_specular_red_i(o,v);
}

inline void OPTISGui::cb_ambient_green_i(Fl_Value_Slider*, void*) {
  objdata->material->ambientColor.setValue(ambient_red->value(),
   ambient_green->value(), ambient_blue->value());
objview->redraw();
}
void OPTISGui::cb_ambient_green(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ambient_green_i(o,v);
}

inline void OPTISGui::cb_diffuse_green_i(Fl_Value_Slider*, void*) {
  objdata->material->diffuseColor.setValue(diffuse_red->value(),
   diffuse_green->value(), diffuse_blue->value());
objview->redraw();
}
void OPTISGui::cb_diffuse_green(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_diffuse_green_i(o,v);
}

inline void OPTISGui::cb_emission_green_i(Fl_Value_Slider*, void*) {
  objdata->material->emissiveColor.setValue(emission_red->value(),
   emission_green->value(), emission_blue->value());
objview->redraw();
}
void OPTISGui::cb_emission_green(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_emission_green_i(o,v);
}

inline void OPTISGui::cb_specular_green_i(Fl_Value_Slider*, void*) {
  objdata->material->specularColor.setValue(specular_red->value(),
   specular_green->value(), specular_blue->value());
objview->redraw();
}
void OPTISGui::cb_specular_green(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_specular_green_i(o,v);
}

inline void OPTISGui::cb_ambient_blue_i(Fl_Value_Slider*, void*) {
  objdata->material->ambientColor.setValue(ambient_red->value(),
   ambient_green->value(), ambient_blue->value());
objview->redraw();
}
void OPTISGui::cb_ambient_blue(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ambient_blue_i(o,v);
}

inline void OPTISGui::cb_diffuse_blue_i(Fl_Value_Slider*, void*) {
  objdata->material->diffuseColor.setValue(diffuse_red->value(),
   diffuse_green->value(), diffuse_blue->value());
objview->redraw();
}
void OPTISGui::cb_diffuse_blue(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_diffuse_blue_i(o,v);
}

inline void OPTISGui::cb_emission_blue_i(Fl_Value_Slider*, void*) {
  objdata->material->emissiveColor.setValue(emission_red->value(),
   emission_green->value(), emission_blue->value());
objview->redraw();
}
void OPTISGui::cb_emission_blue(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_emission_blue_i(o,v);
}

inline void OPTISGui::cb_specular_blue_i(Fl_Value_Slider*, void*) {
  objdata->material->specularColor.setValue(specular_red->value(),
   specular_green->value(), specular_blue->value());
objview->redraw();
}
void OPTISGui::cb_specular_blue(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_specular_blue_i(o,v);
}

inline void OPTISGui::cb_shininess_slider_i(Fl_Value_Slider*, void*) {
  objdata->material->shininess.setValue(shininess_slider->value());
objview->redraw();
}
void OPTISGui::cb_shininess_slider(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_shininess_slider_i(o,v);
}

inline void OPTISGui::cb_transparency_slider_i(Fl_Value_Slider*, void*) {
  objdata->material->transparency.setValue(transparency_slider->value());
objview->redraw();
}
void OPTISGui::cb_transparency_slider(Fl_Value_Slider* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_transparency_slider_i(o,v);
}

inline void OPTISGui::cb_defaultcolorsbtn_i(Fl_Button*, void*) {
/*  ambient_red->value(0.2);
ambient_green->value(0.2);
ambient_blue->value(0.2);*/
  ambient_red->value(1.0);
ambient_green->value(1.0);
ambient_blue->value(1.0);

diffuse_red->value(0.8);
diffuse_green->value(0.8);
diffuse_blue->value(0.8);
emission_red->value(0.0);
emission_green->value(0.0);
emission_blue->value(0.0);
specular_red->value(1.0);
specular_green->value(1.0);
specular_blue->value(1.0);
shininess_slider->value(1.0);
transparency_slider->value(0.0);

objdata->material->ambientColor.setValue(ambient_red->value(),
   ambient_green->value(), ambient_blue->value());
objdata->material->diffuseColor.setValue(diffuse_red->value(),
   diffuse_green->value(), diffuse_blue->value());
objdata->material->emissiveColor.setValue(emission_red->value(),
   emission_green->value(), emission_blue->value());
objdata->material->specularColor.setValue(specular_red->value(),
   specular_green->value(), specular_blue->value());
objdata->material->shininess.setValue(shininess_slider->value());
objdata->material->transparency.setValue(transparency_slider->value());

objview->redraw();
}
void OPTISGui::cb_defaultcolorsbtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_defaultcolorsbtn_i(o,v);
}

inline void OPTISGui::cb_Obtn_cancel_i(Fl_Button*, void*) {
  char oldname[256];
ObjectData *tmpdata;
int j;

tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   objview->setLabel(tmpdata, &tmpdata->oldlabel[0]);
   tmpdata->drawstyle->copyFieldValues(tmpdata->olddrawstyle, FALSE);
   tmpdata->material->copyFieldValues(tmpdata->oldmaterial, FALSE);
   tmpdata->animated = tmpdata->oldanimated;
   tmpdata->pseudo = tmpdata->oldpseudo;
   if (tmpdata->minmap != NULL)
   {
      if (tmpdata->pseudo > 0)
         tmpdata->matbinding->value = SoMaterialBinding::PER_VERTEX_INDEXED;
      else
         tmpdata->matbinding->value = SoMaterialBinding::OVERALL;
   }
   tmpdata = tmpdata->next;
}

j = ObjectChoice->value();
ObjectChoice->clear();
tmpdata = objview->objlist;
while(tmpdata != NULL)
{
   objview->getLabel(tmpdata,&oldname[0]);
   ObjectChoice->add(oldname, 0, 0, 0, 0);
   tmpdata = tmpdata->next;
}
ObjectChoice->value(j);
EditLEDViewer->hide();
setObjectEditorValuesCB();
objview->redraw();
}
void OPTISGui::cb_Obtn_cancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Obtn_cancel_i(o,v);
}

inline void OPTISGui::cb_Obtn_ok_i(Fl_Return_Button*, void*) {
  EditLEDViewer->hide();

ObjectData *tmpdata;
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   if ((tmpdata->type > 99) && (tmpdata->type < 118))
   {
	if(tmpdata->drawstyle->style.getValue() == SoDrawStyle::FILLED)
    pref->LEDdrawstyle[tmpdata->type-100] = 0;
	if(tmpdata->drawstyle->style.getValue() == SoDrawStyle::LINES)
    pref->LEDdrawstyle[tmpdata->type-100] = 1;
	if(tmpdata->drawstyle->style.getValue() == SoDrawStyle::POINTS)
    pref->LEDdrawstyle[tmpdata->type-100] = 2;
	if(tmpdata->drawstyle->style.getValue() == SoDrawStyle::INVISIBLE)
    pref->LEDdrawstyle[tmpdata->type-100] = 3;
   }
   tmpdata = tmpdata->next;
}
	
  ObjWindow->value(ObjectChoice->value());
objview->orderChildren();
objview->redraw();
//add
pref->write_inifile();
//add;
}
void OPTISGui::cb_Obtn_ok(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Obtn_ok_i(o,v);
}

inline void OPTISGui::cb_LoadMotionOk_i(Fl_Return_Button*, void*) {
  int i, j, num,ifrag;
  SbVec3d testvec;
  char st[256],ext[256];
  char st2[256];
  int k;

if (MotionBrowser->value() < 1)
{
   LoadMotionBtn->value(0);
   MotionWindow->hide();
   return;
}

if (LoadMotionBtn->value() > 0)
{
   if (mainAnimation != NULL)
      delete mainAnimation;
   mainAnimation = new Motion(pref, scnfile);

   strcpy(st,MotionBrowser->text(MotionBrowser->value()));
    for(j=0; j<256;j++)ext[j]='\0';
    i = 0;
	j = 0;
	while (st[i] != '\0')
	{
		if (st[i] == '.'){
			ifrag =1;
			i++;
		}else if(ifrag==1){
			ext[j]=st[i];
			i++;
			j++;
		}else if(j == 6){
			ifrag =0;
		}else{
			i++;
		}
	}
   if ((ext[0]=='m')&&(ext[1]=='v')&&(ext[2]=='m')){
   mainAnimation->load_mvmfile(MotionBrowser->text(MotionBrowser->value()));
   mainAnimation->freq = 0.005;
   }else{
   mainAnimation->load_j3dfile(MotionBrowser->text(MotionBrowser->value()));
   mainAnimation->freq = 0.01487;
   }
   
   printf("Load MVM file ->  %s\n",MotionBrowser->text(MotionBrowser->value()));//060818
   changeCamNumber(mainAnimation->numCameras);
   if (numCams != mainAnimation->numCameras)
   {
      changeCamNumber(mainAnimation->numCameras);
   }
   j = 0;
   for (i=0; i<mainAnimation->numCamSystems; i++)
       j += mainAnimation->numLEDs[i];
   clearLEDs();
   numLEDs = j;
   resetTrajectories();
   StepSlider->maximum(mainAnimation->num_steps-1);
   NumberOfStepsOutput->value(mainAnimation->num_steps);
//      sprintf(st2, "%s  %s", mainAnimation->flname,mainAnimation->comment);
      sprintf(st2, "%s", mainAnimation->flname);
   MotionNameOutput->value(st2);
//   MotionNameOutput->value(mainAnimation->comment);
   LoadMotionBtn->value(0);
//   AppRefBtn->value(0);
//   	objview->appRefflag = 0;
   StepNrOutput->value(1);
   StepNrOutput->minimum(0);
   StepNrOutput->maximum(mainAnimation->num_steps);
   LEDViewer->redraw();
   applyMotion(0);
   AnimStart->activate();
   AnimStop->activate();
   AnimOneFwd->activate();
   AnimOneBwd->activate();
   AnimPlayBwd->activate();
   AnimReset->activate();
   ImpTraj->activate();
   AnimStoreAnim->activate();
   AnimLEDCharacteristics->activate();
}
/*else
{
   if (secondAnimation != NULL)
      delete secondAnimation;
   secondAnimation = new Motion(pref, scnfile);
   secondAnimation->calculateReferences();
   secondAnimation->load_j3dfile(MotionBrowser->text(MotionBrowser->value()));
}*/

// change source leds data of the extra point (type=220(traj) and 221(actual point)) 070105
	ObjectData *tmpdata;
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   if(tmpdata->type==220 || tmpdata->type==221 )
   {
      for (k=0; k<18; k++)
		  tmpdata->point_leds[k] = mainAnimation->led[k][0];
//		printf("objview->objlist->point_leds\n");
for (j=0; j<18; j+=2)
printf("point(%2d): %9.3f\t%9.3f\t%9.3f\n",(j+1),tmpdata->point_leds[j][0]
	   ,tmpdata->point_leds[j][1],tmpdata->point_leds[j][2]);
   }
   tmpdata = tmpdata->next;
}


testvec.setValue(-120.0, -120.0, -120.0);
for (j=0; j<6; j++)
{
   num = 0;
   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[0][i] == j)
      { 
         if (mainAnimation->led[i][0] != testvec)
            num++;
      }
   }
   if (num < 3)
   {
      switch (j)
      {
         case 0: RSObj1->deactivate(); break;
         case 1: RSObj2->deactivate(); break;
         case 2: RSObj3->deactivate(); break;
         case 3: RSObj4->deactivate(); break;
         case 4: RSObj5->deactivate(); break;
         case 5: RSObj6->deactivate(); break;
      }
      if (mainAnimation->RSnr == j)
      {
         RSFOV->setonly();
         RSFOV->do_callback(MenuBarLEDViewer);
      }
   }
   else
   {
      switch (j)
      {
         case 0: RSObj1->activate(); break;
         case 1: RSObj2->activate(); break;
         case 2: RSObj3->activate(); break;
         case 3: RSObj4->activate(); break;
         case 4: RSObj5->activate(); break;
         case 5: RSObj6->activate(); break;
      }
   }
}
//         RSFOV->setonly();
//         RSFOV->do_callback(MenuBarLEDViewer);
//printf("mainAnimation->RSsysnr =%d\n",mainAnimation->RSsysnr);
//printf("oldRSsysnr =%d\n",oldRSsysnr);
switch (oldRSsysnr)
{
   case -1: RSFOV->do_callback(MenuBarLEDViewer);  break;
   case  0: RSObj1->do_callback(MenuBarLEDViewer); break;
   case  1: RSObj2->do_callback(MenuBarLEDViewer); break;
   case  2: RSObj3->do_callback(MenuBarLEDViewer); break;
   case  3: RSObj4->do_callback(MenuBarLEDViewer); break;
   case  4: RSObj5->do_callback(MenuBarLEDViewer); break;
   case  5: RSObj6->do_callback(MenuBarLEDViewer); break;
   default: RSFOV->do_callback(MenuBarLEDViewer);  break;
};

LoadMotionBtn->value(0);
MotionWindow->hide();



setObjectEditorObjects2();
}
void OPTISGui::cb_LoadMotionOk(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LoadMotionOk_i(o,v);
}

inline void OPTISGui::cb_LoadMotionCancel_i(Fl_Button*, void*) {
  MotionWindow->hide();
LoadMotionBtn->value(0);
}
void OPTISGui::cb_LoadMotionCancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LoadMotionCancel_i(o,v);
}

inline void OPTISGui::cb_ImpTrajOk_i(Fl_Return_Button*, void*) {
char    st[256];
dirent  **list;	
int     n, i,len, maxlen;
	
if (ImpTrajBrowser->value() < 1)
{
   ImpTrajWindow->hide();
   return;
}
   if (mainAnimation == NULL) mainAnimation = new Motion(pref, scnfile);

/////////////////////
   mainAnimation->load_trajfile(ImpTrajBrowser->text(ImpTrajBrowser->value()));
/////////////////////
   maxlen = 0;
   list = NULL;
   n = fl_filename_list(&st[0], &list);
   for(i=0; i<mainAnimation->numtraj; i++)
   {
      sprintf(st, "%s", mainAnimation->trajcomm[i]);
      len = strlen(st);
      if (len > maxlen) maxlen = len;
   }
   ChsTrajBrowser->clear();
for(i=0; i<mainAnimation->numtraj; i++)
{
   sprintf(st, "%s", mainAnimation->trajcomm[i]);
   len = strlen(st);
//   printf("%s\n",st);
   ChsTrajBrowser->add(&st[0]);
}
for(i=n; i>0;)
   free((void*)(list[--i]));
free((void*)list);
ChsTrajWindow->size_range(400, 200, 0, 0, 0, 0, 0);
ChsTrajWindow->show();
//ImpTrajWindow->hide();

setObjectEditorObjects2();
}
void OPTISGui::cb_ImpTrajOk(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ImpTrajOk_i(o,v);
}

inline void OPTISGui::cb_ImpTrajCancel_i(Fl_Button*, void*) {
  ImpTrajWindow->hide();
}
void OPTISGui::cb_ImpTrajCancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ImpTrajCancel_i(o,v);
}

inline void OPTISGui::cb_ChsTrajOk_i(Fl_Return_Button*, void*) {
int     i,inum;
char    st[256];

	inum = ChsTrajBrowser->value();
//	printf("import No.%d trajectory\n",inum);
/////////////////////   
SbVec3f *impTraj2;
SbVec3f vd1, vd2;
SbVec3d vdd1, vdd2, vd3, vd4;
SbVec3f *linexyz, posxyz;
SbVec3d src;
int numSteps, oldRSnr, objnr;
SdMatrix md;
/////////////////////   
SbVec3d testvec;
SdMatrix m1, m2, m3;

	testvec.setValue(-120.0, -120.0, -120.0);
//imported traj object
	mainAnimation->calc_animationTrafoImp(0, 1, 0);
	m1 = mainAnimation->mUVWImp[0];
/*	printf("m1\t%.3f\t%.3f\t%.3f\t%.3f\r\n",m1[0][0],m1[0][1],m1[0][2],m1[0][3]);
	printf("m1\t%.3f\t%.3f\t%.3f\t%.3f\r\n",m1[1][0],m1[1][1],m1[1][2],m1[1][3]);
	printf("m1\t%.3f\t%.3f\t%.3f\t%.3f\r\n",m1[2][0],m1[2][1],m1[2][2],m1[2][3]);
	printf("m1\t%.3f\t%.3f\t%.3f\t%.3f\r\n",m1[3][0],m1[3][1],m1[3][2],m1[3][3]);*/
// current object
	mainAnimation->calc_animationTrafo4(0,1,0);
	m2 = mainAnimation->mUVW2[0];
/*	printf("m2\t%.3f\t%.3f\t%.3f\t%.3f\r\n",m2[0][0],m2[0][1],m2[0][2],m2[0][3]);
	printf("m2\t%.3f\t%.3f\t%.3f\t%.3f\r\n",m2[1][0],m2[1][1],m2[1][2],m2[1][3]);
	printf("m2\t%.3f\t%.3f\t%.3f\t%.3f\r\n",m2[2][0],m2[2][1],m2[2][2],m2[2][3]);
	printf("m2\t%.3f\t%.3f\t%.3f\t%.3f\r\n",m2[3][0],m2[3][1],m2[3][2],m2[3][3]);*/
	m2 = m2.inverse();
	m3 = m2 * m1;

if(m2[0][3]==0&&m2[1][3]==0&&m2[2][3]==0)return;
	mainAnimation->traj_trafo = m3;

numSteps = mainAnimation-> imp_steps;
linexyz = new SbVec3f[2*(numSteps-1)];
 oldRSnr = mainAnimation->RSnr;
 mainAnimation->setRSnr(TrajRefChoice->value()-1);
objnr = 0;
impTraj2 = new SbVec3f[2*(numSteps-1)];
for (i=0; i<(numSteps); i++)
{
   vdd1[0] = (double)mainAnimation->impTraj[inum-1][i][0];
   vdd1[1] = (double)mainAnimation->impTraj[inum-1][i][1];
   vdd1[2] = (double)mainAnimation->impTraj[inum-1][i][2];
   mainAnimation->traj_trafo.multMatrixVec(vdd1, vdd2);

   impTraj2[i].setValue(vdd2[0],vdd2[1],vdd2[2]);
//   impTraj2[i].setValue(vdd1[0],vdd1[1],vdd1[2]); //no transfomation
}	
for (i=0; i<(numSteps-1); i++)
{
      vd1 = impTraj2[i];
      vd2 = impTraj2[i+1];

   linexyz[2*i].setValue(vd1[0], vd1[1], vd1[2]);
   linexyz[2*i+1].setValue(vd2[0], vd2[1], vd2[2]);
}	
/////////////////////   
src.setValue(impTraj2[0][0], impTraj2[0][1], impTraj2[0][2]);

sprintf(st, "import trajectory");
objview->addLineObject(&st[0], linexyz, (numSteps-1), 2*(numSteps-1));
objview->objlist->type = 222;
objview->objlist->startStep = 0;
objview->objlist->stopStep = mainAnimation->imp_steps-1;
objview->objlist->point = src;
objview->objlist->camSys = 0;
objview->objlist->motionOfObject = 0;
objview->objlist->reference = -1;
 mainAnimation->setRSnr(oldRSnr);

objview->objlist->material->diffuseColor.setValue(0.0, 0.8, 0.8);//cyan color
objview->objlist->material->emissiveColor.setValue(0.0, 0.0, 0.0);


TrajectoryWindow->hide();
objview->orderChildren();
applyMotion(-1);

delete[] linexyz;
	printf("import No.%d trajectory\n",inum);
////////////////////////
//  ChsTrajWindow->hide();
}
void OPTISGui::cb_ChsTrajOk(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ChsTrajOk_i(o,v);
}
inline void OPTISGui::cb_ChsTrajCancel_i(Fl_Button*, void*) {
  ChsTrajWindow->hide();
}
void OPTISGui::cb_ChsTrajCancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ChsTrajCancel_i(o,v);
}




inline void OPTISGui::cb_WSW_Cancel_i(Fl_Button*, void*) {
  WindowSizeWindow->hide();
}
void OPTISGui::cb_WSW_Cancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_WSW_Cancel_i(o,v);
}

inline void OPTISGui::cb_WSW_Ok_i(Fl_Return_Button*, void*) {
  if (inputWindowWidth->value()<512)
   inputWindowWidth->value(512);
if (inputWindowHeight->value()<480)
   inputWindowHeight->value(480);
LEDViewer->size(inputWindowWidth->value()+64, inputWindowHeight->value()+109);
WindowSizeWindow->hide();
}
void OPTISGui::cb_WSW_Ok(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_WSW_Ok_i(o,v);
}

inline void OPTISGui::cb_PrefScnDirBrowser_i(Fl_Button*, void*) {
  char *p;
char st2[256];

sprintf(st2, "%s/", inputScanPath->value());
p = fl_dir_chooser("Scan Files: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st2, "%s", p);
   inputScanPath->value(&st2[0]);
};
}
void OPTISGui::cb_PrefScnDirBrowser(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PrefScnDirBrowser_i(o,v);
}

inline void OPTISGui::cb_PrefDataDirBrowser_i(Fl_Button*, void*) {
  char *p;
char st2[256];

sprintf(st2, "%s/", inputDataPath->value());
p = fl_dir_chooser("Data Files: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st2, "%s", p);
   inputDataPath->value(&st2[0]);
};
}
void OPTISGui::cb_PrefDataDirBrowser(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PrefDataDirBrowser_i(o,v);
}

inline void OPTISGui::cb_inputImgCopy_i(Fl_Input*, void*) {
  char cmd[256];

sprintf(cmd, "%s image.sgi %simage.jpg", inputImgCopy->value(),
        inputExtraCode->value());
outputImgCopy->value(&cmd[0]);
}
void OPTISGui::cb_inputImgCopy(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_inputImgCopy_i(o,v);
}

inline void OPTISGui::cb_PrefImgCopyBrowser_i(Fl_Button*, void*) {
  char *p;
char st2[256];
int i;

sprintf(st2, "%s/", inputImgCopy->value());
#ifdef WIN32
   i = 0;
   while ((i<255)&&(st2[i]!='\0'))
   {
      if (st2[i] == '\\')
         st2[i] = '/';
      i++;
   }
#endif
   i = strlen(st2);
   while ((i>=0)&&(st2[i]!='/'))
   {
      i--;
   }
   st2[i] = '\0';
p = fl_file_chooser("Select the image conversion program", "*.exe", &st2[0]);
if (p != NULL)
{
   sprintf(st2, "%s", p);
#ifdef WIN32
   i = 0;
   while ((i<255)&&(st2[i]!='\0'))
   {
      if (st2[i] == '/')
         st2[i] = '\\';
      i++;
   }
#endif
   inputImgCopy->value(&st2[0]);

   sprintf(st2, "%s image.sgi %simage.jpg", inputImgCopy->value(),
           inputExtraCode->value());
   outputImgCopy->value(&st2[0]);
};
}
void OPTISGui::cb_PrefImgCopyBrowser(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PrefImgCopyBrowser_i(o,v);
}

inline void OPTISGui::cb_inputExtraCode_i(Fl_Input*, void*) {
  char cmd[256];

sprintf(cmd, "%s image.sgi %simage.jpg", inputImgCopy->value(),
        inputExtraCode->value());
outputImgCopy->value(&cmd[0]);
}
void OPTISGui::cb_inputExtraCode(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_inputExtraCode_i(o,v);
}

inline void OPTISGui::cb_BgCChangeBtn_i(Fl_Button*, void*) {
  double r, g, b;
unsigned char ur, ug, ub;
int ok;

r = newPrefColor[0];
g = newPrefColor[1];
b = newPrefColor[2];
ok = fl_color_chooser("Background Color", r, g, b);
if (ok)
{
   newPrefColor.setValue(r, g, b);
   r *= 255.0;
   ur = (unsigned char) r;
   g *= 255.0;
   ug = (unsigned char) g;
   b *= 255.0;
   ub = (unsigned char) b;
   NewColorBox->r = ur;
   NewColorBox->g = ug;
   NewColorBox->b = ub;
}
PrefWindow->redraw();
}
void OPTISGui::cb_BgCChangeBtn(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_BgCChangeBtn_i(o,v);
}

inline void OPTISGui::cb_OPTISContrBrowse_i(Fl_Button*, void*) {
  char *p;
char st2[256];
int i;

sprintf(st2, "%s/", inputOPTISController->value());
#ifdef WIN32
   i = 0;
   while ((i<255)&&(st2[i]!='\0'))
   {
      if (st2[i] == '\\')
         st2[i] = '/';
      i++;
   }
#endif
   i = strlen(st2);
   while ((i>=0)&&(st2[i]!='/'))
   {
      i--;
   }
   st2[i] = '\0';
p = fl_file_chooser("Select the OPTIS Controller program", "*.exe", &st2[0]);
if (p != NULL)
{
   sprintf(st2, "%s", p);
#ifdef WIN32
   i = 0;
   while ((i<255)&&(st2[i]!='\0'))
   {
      if (st2[i] == '/')
         st2[i] = '\\';
      i++;
   }
#endif
   inputOPTISController->value(&st2[0]);
};
}
void OPTISGui::cb_OPTISContrBrowse(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_OPTISContrBrowse_i(o,v);
}

inline void OPTISGui::cb_TempDirBrowse_i(Fl_Button*, void*) {
  char *p;
char st2[256];

sprintf(st2, "%s/", inputTempDir->value());
p = fl_dir_chooser("Scan Files: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st2, "%s", p);
   inputTempDir->value(&st2[0]);
};
}
void OPTISGui::cb_TempDirBrowse(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_TempDirBrowse_i(o,v);
}

inline void OPTISGui::cb_PrefCancel_i(Fl_Button*, void*) {
  PrefWindow->hide();
}
void OPTISGui::cb_PrefCancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PrefCancel_i(o,v);
}

inline void OPTISGui::cb_PrefOk_i(Fl_Return_Button*, void*) {
  pref->LEDViewerWidth = wigWidth->value();
pref->LEDViewerHeight = wigHeight->value();
pref->LEDViewerX = wigXPos->value();
pref->LEDViewerY = wigYPos->value();
pref->LEDViewerColor.setValue(newPrefColor[0],
   newPrefColor[1], newPrefColor[2]);
LEDViewer->size(wigWidth->value()+64, wigHeight->value()+109);
LEDViewer->position(wigXPos->value(), wigYPos->value());
objview->backgroundcolor[0] = newPrefColor[0];
objview->backgroundcolor[1] = newPrefColor[1];
objview->backgroundcolor[2] = newPrefColor[2];
objview->scenemanager->setBackgroundColor(
   SbColor(objview->backgroundcolor[0],
   objview->backgroundcolor[1], objview->backgroundcolor[2]));
pref->setdatapath(inputDataPath->value());
pref->setscanpath(inputScanPath->value());
sprintf(pref->imgcopy, "%s", inputImgCopy->value());
sprintf(pref->extracode, "%s", inputExtraCode->value());
sprintf(pref->socketPort, "%s", inputSocketPort->value());
sprintf(pref->socketHost, "%s", inputSocketHost->value());
checkLEDValues();
//pref->LEDerror = LEDWeakly->value()-1;
pref->LEDerror = LEDError->value();
pref->LEDwarningRedRed = LEDWeakly->value()-1;
pref->LEDwarningRed = LEDVisible->value()-1;
pref->LEDwarningYellow = LEDOkay->value()-1;
sprintf(pref->optisController, "%s", inputOPTISController->value());
sprintf(pref->optisTempDir, "%s", inputTempDir->value());

pref->write_inifile();
PrefWindow->hide();
objview->redraw();
}
void OPTISGui::cb_PrefOk(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PrefOk_i(o,v);
}

inline void OPTISGui::cb_NewPatientBtn_i(Fl_Check_Button*, void*) {
  NewPatientBtn->setonly();
}
void OPTISGui::cb_NewPatientBtn(Fl_Check_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_NewPatientBtn_i(o,v);
}

inline void OPTISGui::cb_ExistingPatientBtn_i(Fl_Check_Button*, void*) {
  char *p;
int err, i;
char st[256], st1[256], st2[256];

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

ExistingPatientBtn->setonly();
sprintf(st, "%s/", patInputScanPath->value());
p = fl_file_chooser("Select a Scan File (*.scn)", "*.scn", &st[0]);
if (p == NULL)
{
   NewPatientBtn->setonly();
   return;
}
if (scnfile != NULL)
   delete(scnfile);
scnfile = new Scanfile;
err = scnfile->read(p);
if (err == 1)
{
   sprintf(scnfile->movdir, "%s/%s", pref->datapath, scnfile->scanmov.path);
   sprintf(st1, "%s", pref->scanpath);
   sprintf(st2, "%s", scnfile->scandir);
   i = 0;
   while((i < 256) && (st1[i] == st2[i]))
      i++;
   sprintf(scnfile->shortScandir, "%s", &st2[i+1]);
   insertValues();
}
if (err == 0)
{
   sprintf(st, "Could not open file %s", p);
   fl_message(&st[0]);
   NewPatientBtn->setonly();
   return;
};
}
void OPTISGui::cb_ExistingPatientBtn(Fl_Check_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_ExistingPatientBtn_i(o,v);
}

inline void OPTISGui::cb_PatientName_i(Fl_Input*, void*) {
  if (PatDirAutoBtn->value()>0)
   buildDirectoryNames();
NewPatientBtn->setonly();
}
void OPTISGui::cb_PatientName(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientName_i(o,v);
}

inline void OPTISGui::cb_PatientFirstName_i(Fl_Input*, void*) {
  if (PatDirAutoBtn->value()>0)
   buildDirectoryNames();
NewPatientBtn->setonly();
}
void OPTISGui::cb_PatientFirstName(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientFirstName_i(o,v);
}

inline void OPTISGui::cb_PatientAnatomy_i(Fl_Input*, void*) {
  if (PatDirAutoBtn->value()>0)
   buildDirectoryNames();
NewPatientBtn->setonly();
}
void OPTISGui::cb_PatientAnatomy(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientAnatomy_i(o,v);
}

inline void OPTISGui::cb_PatientRecordingDate_i(Fl_Input*, void*) {
  if (PatDirAutoBtn->value()>0)
   buildDirectoryNames();
NewPatientBtn->setonly();
}
void OPTISGui::cb_PatientRecordingDate(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientRecordingDate_i(o,v);
}

inline void OPTISGui::cb_PatientRemarks_i(Fl_Input*, void*) {
  NewPatientBtn->setonly();
}
void OPTISGui::cb_PatientRemarks(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientRemarks_i(o,v);
}

inline void OPTISGui::cb_PatientScanFileName_i(Fl_Input*, void*) {
  NewPatientBtn->setonly();
}
void OPTISGui::cb_PatientScanFileName(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientScanFileName_i(o,v);
}

inline void OPTISGui::cb_PatientHelp_i(Fl_Button*, void*) {
  help_dialog->resize(LEDViewer->x()+((LEDViewer->w()-650)/2),
   LEDViewer->y()+((LEDViewer->h()-650)/2), 650, 650);
help_dialog->load("help/help.html");
help_dialog->textsize(14);
help_dialog->show();
}
void OPTISGui::cb_PatientHelp(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientHelp_i(o,v);
}

inline void OPTISGui::cb_iPatDMY_i(Fl_Round_Button*, void*) {
  char st[20];
time_t t;

pref->dateType = 1;
pref->write_inifile();

t = time(NULL);
strftime(&st[0], 20, "%d.%m.%Y", localtime(&t));
PatientRecordingDate->value(&st[0]);

if (PatDirAutoBtn->value()>0)
   buildDirectoryNames();
}
void OPTISGui::cb_iPatDMY(Fl_Round_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_iPatDMY_i(o,v);
}

inline void OPTISGui::cb_iPatYMD_i(Fl_Round_Button*, void*) {
  char st[20];
time_t t;

pref->dateType = 2;
pref->write_inifile();

t = time(NULL);
strftime(&st[0], 20, "%Y.%m.%d", localtime(&t));
PatientRecordingDate->value(&st[0]);

if (PatDirAutoBtn->value()>0)
   buildDirectoryNames();
}
void OPTISGui::cb_iPatYMD(Fl_Round_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_iPatYMD_i(o,v);
}

inline void OPTISGui::cb_iPatMDY_i(Fl_Round_Button*, void*) {
  char st[20];
time_t t;

pref->dateType = 3;
pref->write_inifile();

t = time(NULL);
strftime(&st[0], 20, "%m.%d.%Y", localtime(&t));
PatientRecordingDate->value(&st[0]);

if (PatDirAutoBtn->value()>0)
   buildDirectoryNames();
}
void OPTISGui::cb_iPatMDY(Fl_Round_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_iPatMDY_i(o,v);
}

inline void OPTISGui::cb_patInputFileBase_i(Fl_Input*, void*) {
  NewPatientBtn->setonly();
}
void OPTISGui::cb_patInputFileBase(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_patInputFileBase_i(o,v);
}

inline void OPTISGui::cb_PatientDirGroup_i(Fl_Group*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatientDirGroup(Fl_Group* o, void* v) {
  ((OPTISGui*)(o->parent()->user_data()))->cb_PatientDirGroup_i(o,v);
}

inline void OPTISGui::cb_PatDirAutoBtn_i(Fl_Check_Button*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatDirAutoBtn(Fl_Check_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatDirAutoBtn_i(o,v);
}

inline void OPTISGui::cb_PatDirExistBtn_i(Fl_Check_Button*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatDirExistBtn(Fl_Check_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatDirExistBtn_i(o,v);
}

inline void OPTISGui::cb_PatientDirText_i(Fl_Box*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatientDirText(Fl_Box* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientDirText_i(o,v);
}

inline void OPTISGui::cb_PatientScanDirectory_i(Fl_Input*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatientScanDirectory(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientScanDirectory_i(o,v);
}

inline void OPTISGui::cb_PatientScanPath_i(Fl_Input*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatientScanPath(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientScanPath_i(o,v);
}

inline void OPTISGui::cb_PatientDataDirectory_i(Fl_Input*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatientDataDirectory(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientDataDirectory_i(o,v);
}

inline void OPTISGui::cb_PatientDataPath_i(Fl_Input*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatientDataPath(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientDataPath_i(o,v);
}

inline void OPTISGui::cb_PatScnDirBrowser_i(Fl_Button*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatScnDirBrowser(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatScnDirBrowser_i(o,v);
}

inline void OPTISGui::cb_PatDataDirBrowser_i(Fl_Button*, void*) {
  char *p;
char st[256], st2[256];
int i;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st, "%s", p);
   PatientDataPath->value(&st[0]);
   NewPatientBtn->setonly();
};
}
void OPTISGui::cb_PatDataDirBrowser(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatDataDirBrowser_i(o,v);
}

inline void OPTISGui::cb_patInputScanPath_i(Fl_Input*, void*) {
  NewPatientBtn->setonly();
}
void OPTISGui::cb_patInputScanPath(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_patInputScanPath_i(o,v);
}

inline void OPTISGui::cb_patInputDataPath_i(Fl_Input*, void*) {
  NewPatientBtn->setonly();
}
void OPTISGui::cb_patInputDataPath(Fl_Input* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_patInputDataPath_i(o,v);
}

inline void OPTISGui::cb_DatabaseScnDirBrowser_i(Fl_Button*, void*) {
  char *p;
char st2[256];

sprintf(st2, "%s/", patInputScanPath->value());
p = fl_dir_chooser("Scan Files: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st2, "%s", p);
   patInputScanPath->value(&st2[0]);
   NewPatientBtn->setonly();
   pref->setscanpath(&st2[0]);
   pref->write_inifile();
};
}
void OPTISGui::cb_DatabaseScnDirBrowser(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_DatabaseScnDirBrowser_i(o,v);
}

inline void OPTISGui::cb_DatabaseDataDirBrowser_i(Fl_Button*, void*) {
  char *p;
char st2[256];

sprintf(st2, "%s/", patInputDataPath->value());
p = fl_dir_chooser("Data Files: Select the desired directory", &st2[0], 0);
if (p != NULL)
{
   sprintf(st2, "%s", p);
   patInputDataPath->value(&st2[0]);
   NewPatientBtn->setonly();
   pref->setdatapath(&st2[0]);
   pref->write_inifile();
};
}
void OPTISGui::cb_DatabaseDataDirBrowser(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_DatabaseDataDirBrowser_i(o,v);
}

inline void OPTISGui::cb_PatientCancel_i(Fl_Button*, void*) {
  PatientWindow->hide();
}
void OPTISGui::cb_PatientCancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientCancel_i(o,v);
}

inline void OPTISGui::cb_PatientOk_i(Fl_Return_Button*, void*) {
  char path[256], ndir[256];
int i, j;

i = 0;
if (strcmp(pref->getdatapath(), patInputDataPath->value()) != NULL)
{
   pref->setdatapath(patInputDataPath->value());
   i++;
}
if (strcmp(pref->getscanpath(), patInputScanPath->value()) != NULL)
{
   pref->setscanpath(patInputScanPath->value());
   i++;
}
if (i>0)
{
   pref->write_inifile();
}

if (strlen(PatientName->value()) == 0)
{
   fl_message("Enter a Name!");
   return;
}
if (strlen(PatientFirstName->value()) == 0)
{
   fl_message("Enter a First Name!");
   return;
}
if (strlen(PatientAnatomy->value()) == 0)
{
   fl_message("Enter an Anatomy!");
   return;
}
if (strlen(PatientRecordingDate->value()) == 0)
{
   fl_message("Enter a Recording Date!");
   return;
}
if (strlen(PatientScanFileName->value()) == 0)
{
   fl_message("Enter a Scan Filename!");
   return;
}
if (strlen(patInputFileBase->value()) == 0)
{
   fl_message("Enter the Base of the Movement Files!");
   return;
}

sprintf(ndir, "%s", PatientDataPath->value());
sprintf(path, "%s", patInputDataPath->value());
i = 0;
j = 0;
while ((i < 256) && (ndir[i] != '\0'))
{
   if (ndir[i] == '/')
   {
      ndir[i] = '\0';
      makeDir(&path[0], &ndir[j]);
      strcat(path, "/");
      strcat(path, &ndir[j]);
      j = i+1;
   }
   i++;
}
if (j < i)
{
   ndir[i] = '\0';
   makeDir(&path[0], &ndir[j]);
}
sprintf(ndir, "%s", PatientScanPath->value());
sprintf(path, "%s", patInputScanPath->value());
i = 0;
j = 0;
while ((i < 256) && (ndir[i] != '\0'))
{
   if (ndir[i] == '/')
   {
      ndir[i] = '\0';
      makeDir(&path[0], &ndir[j]);
      strcat(path, "/");
      strcat(path, &ndir[j]);
      j = i+1;
   }
   i++;
}
if (j < i)
{
   ndir[i] = '\0';
   makeDir(&path[0], &ndir[j]);
   strcat(path, "/");
   strcat(path, &ndir[j]);
}

sprintf(ndir, "%s", PatientScanFileName->value());
i = 0;
while ((i<256) && (ndir[i] != '\0'))
{
   if (ndir[i] == '.')
      ndir[i] = '\0';
   else
      i++;
}
strcat(path, "/");
strcat(path, ndir);
sprintf(scnfile->name, "%s", PatientName->value());
sprintf(scnfile->firstname, "%s", PatientFirstName->value());
sprintf(scnfile->anatomy, "%s", PatientAnatomy->value());
sprintf(scnfile->date, "%s", PatientRecordingDate->value());
sprintf(scnfile->remarks, "%s", PatientRemarks->value());
sprintf(scnfile->scanmov.base, "%s", patInputFileBase->value());
i = 0;
while ((i<256) && (scnfile->scanmov.base[i] != '\0'))
{
   if (scnfile->scanmov.base[i] == '.')
      scnfile->scanmov.base[i] = '\0';
   else
      i++;
}
sprintf(scnfile->scanmov.path, "%s", PatientDataPath->value());
sprintf(scnfile->scanbase, "%s", path);
strcat(path, ".scn");
if (NewPatientBtn->value() > 0)
{
   i = scnfile->write(&path[0], 0);
   if (i == 0)
   {
      sprintf(ndir, "Could not save the scanfile: \n%s", path);
      fl_message(&ndir[0]);
      return;
   }
}
PatientHelp->hide();
PatientWindow->hide();
patientGeladen = 1;
if (scnfile != NULL)
{
   sprintf(WindowTitle, "OPTIS: %s %s, %s", scnfile->name, scnfile->firstname, scnfile->anatomy);
   LEDViewer->label(&WindowTitle[0]);
};

//read comment file (text file)
   comList->read_comfile();

   Commentlist::cdata *d;
   int anz;
   anz = 0;

   d = comList->clist;
   MvmNameList->clear();

while(d != NULL)
{
   d = d->next;
   anz++;
}

for (i=0; i<anz; i++)
{
   d = comList->clist;
   for(j=(i+1); j<anz; j++)
      d = d->next;
   MvmNameList->add(d->cname);
//   printf("comment %s\n",d->cname);
}

MvmNameList->value(0);

}
void OPTISGui::cb_PatientOk(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_PatientOk_i(o,v);
}

inline void OPTISGui::cb_TrajNameChoice_i(Fl_Choice*, void*) {
  setTrajEditorChoice();
}
void OPTISGui::cb_TrajNameChoice(Fl_Choice* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_TrajNameChoice_i(o,v);
}

inline void OPTISGui::cb_LEDNameChoice_i(Fl_Choice*, void*) {
  setLEDEditorChoice();
}
void OPTISGui::cb_LEDNameChoice(Fl_Choice* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_LEDNameChoice_i(o,v);
}

Fl_Menu_Item OPTISGui::menu_TrajCamSysChoice[] = {
 {"main", 0,  0, 0, 0, 0, 0, 14, 56},
 {"1", 0,  0, 0, 0, 0, 0, 14, 56},
 {"2", 0,  0, 0, 0, 0, 0, 14, 56},
 {"3", 0,  0, 0, 0, 0, 0, 14, 56},
 {"4", 0,  0, 0, 0, 0, 0, 14, 56},
 {"5", 0,  0, 0, 0, 0, 0, 14, 56},
 {"6", 0,  0, 0, 0, 0, 0, 14, 56},
 {"7", 0,  0, 0, 0, 0, 0, 14, 56},
 {"8", 0,  0, 0, 0, 0, 0, 14, 56},
 {"9", 0,  0, 0, 0, 0, 0, 14, 56},
 {0}
};
Fl_Menu_Item* OPTISGui::TrajCamSysMain = OPTISGui::menu_TrajCamSysChoice + 0;
Fl_Menu_Item* OPTISGui::TrajCamSys1 = OPTISGui::menu_TrajCamSysChoice + 1;
Fl_Menu_Item* OPTISGui::TrajCamSys2 = OPTISGui::menu_TrajCamSysChoice + 2;
Fl_Menu_Item* OPTISGui::TrajCamSys3 = OPTISGui::menu_TrajCamSysChoice + 3;
Fl_Menu_Item* OPTISGui::TrajCamSys4 = OPTISGui::menu_TrajCamSysChoice + 4;
Fl_Menu_Item* OPTISGui::TrajCamSys5 = OPTISGui::menu_TrajCamSysChoice + 5;
Fl_Menu_Item* OPTISGui::TrajCamSys6 = OPTISGui::menu_TrajCamSysChoice + 6;
Fl_Menu_Item* OPTISGui::TrajCamSys7 = OPTISGui::menu_TrajCamSysChoice + 7;
Fl_Menu_Item* OPTISGui::TrajCamSys8 = OPTISGui::menu_TrajCamSysChoice + 8;
Fl_Menu_Item* OPTISGui::TrajCamSys9 = OPTISGui::menu_TrajCamSysChoice + 9;

Fl_Menu_Item OPTISGui::menu_TrajObjChoice[] = {
 {"none", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 1", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 2", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 3", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 4", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 5", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 6", 0,  0, 0, 0, 0, 0, 14, 56},
 {0}
};
Fl_Menu_Item* OPTISGui::TrajObjNone = OPTISGui::menu_TrajObjChoice + 0;
Fl_Menu_Item* OPTISGui::TrajObjObj1 = OPTISGui::menu_TrajObjChoice + 1;
Fl_Menu_Item* OPTISGui::TrajObjObj2 = OPTISGui::menu_TrajObjChoice + 2;
Fl_Menu_Item* OPTISGui::TrajObjObj3 = OPTISGui::menu_TrajObjChoice + 3;
Fl_Menu_Item* OPTISGui::TrajObjObj4 = OPTISGui::menu_TrajObjChoice + 4;
Fl_Menu_Item* OPTISGui::TrajObjObj5 = OPTISGui::menu_TrajObjChoice + 5;
Fl_Menu_Item* OPTISGui::TrajObjObj6 = OPTISGui::menu_TrajObjChoice + 6;

Fl_Menu_Item OPTISGui::menu_TrajRefChoice[] = {
 {"FOV", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 1", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 2", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 3", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 4", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 5", 0,  0, 0, 0, 0, 0, 14, 56},
 {"Object 6", 0,  0, 0, 0, 0, 0, 14, 56},
 {0}
};
Fl_Menu_Item* OPTISGui::TrajRefNone = OPTISGui::menu_TrajRefChoice + 0;
Fl_Menu_Item* OPTISGui::TrajRefObj1 = OPTISGui::menu_TrajRefChoice + 1;
Fl_Menu_Item* OPTISGui::TrajRefObj2 = OPTISGui::menu_TrajRefChoice + 2;
Fl_Menu_Item* OPTISGui::TrajRefObj3 = OPTISGui::menu_TrajRefChoice + 3;
Fl_Menu_Item* OPTISGui::TrajRefObj4 = OPTISGui::menu_TrajRefChoice + 4;
Fl_Menu_Item* OPTISGui::TrajRefObj5 = OPTISGui::menu_TrajRefChoice + 5;
Fl_Menu_Item* OPTISGui::TrajRefObj6 = OPTISGui::menu_TrajRefChoice + 6;

inline void OPTISGui::cb_RefCoordChoice_i(Fl_Choice*, void*) {
  setRefCoordChoice();
}
void OPTISGui::cb_RefCoordChoice(Fl_Choice* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_RefCoordChoice_i(o,v);
}

inline void OPTISGui::cb_Tbtn_cancel_i(Fl_Button*, void*) {
  TrajectoryWindow->hide();
objview->redraw();
}
void OPTISGui::cb_Tbtn_cancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Tbtn_cancel_i(o,v);
}

inline void OPTISGui::cb_Tbtn_ok_i(Fl_Return_Button*, void*) {
  // Trajektorie anhand Koordinaten einfgen 
  // insert the trajectory by the coordinate system
SbVec3d vd1, vd2, vd3, vd4, testvec;
SbVec3d vd5, vd6;
SbVec3f vf;
SbVec3f *linexyz, posxyz;
SbVec3d src,dst;
SbVec3d src_leds[18];//3*18 matrix
int i,j, numSteps, oldRSnr, objnr;
char st[256];
SdMatrix md;
SdMatrix m1,m2;
SdMatrix mo1;
SbVec3d tmp1, tmp2;
int refcoord;
testvec.setValue(-120.0, -120.0, -120.0);

if ((FirstStep->value() < 1) || (FirstStep->value() > mainAnimation->num_steps))
   FirstStep->value(1);
if ((LastStep->value() < FirstStep->value()) || (LastStep->value() > mainAnimation->num_steps))
   LastStep->value(mainAnimation->num_steps);

//calcurate XYZ  070104
if (TrajRefChoice->value() == 0)
{
   src.setValue(XCoord->value(), YCoord->value(), ZCoord->value());
   dst.setValue(XCoord->value(), YCoord->value(), ZCoord->value());
}else{
   refcoord = TrajRefChoice->value();
   mainAnimation->calc_animationTrafoObj(mainAnimation->animation_step, (refcoord-1));
   mo1 = mainAnimation->mObj[0].inverse();
   tmp1.setValue(XCoord->value(), YCoord->value(), ZCoord->value());
   mo1.multMatrixVec(tmp1, tmp2);
   src.setValue(tmp2[0], tmp2[1], tmp2[2]);
   dst.setValue(XCoord->value(), YCoord->value(), ZCoord->value());
}

numSteps = LastStep->value() - FirstStep->value() + 1;
linexyz = new SbVec3f[2*(numSteps-1)];
 oldRSnr = mainAnimation->RSnr;
 mainAnimation->setRSnr(TrajRefChoice->value()-1);
objnr = TrajObjChoice->value()-1;
for (j=0; j<18; j++)
	src_leds[j] = mainAnimation->led[j][mainAnimation->animation_step];
for (i=0; i<(numSteps-1); i++)
{
   mainAnimation->calc_animationTrafo(i+FirstStep->value()-1, objnr);
   mainAnimation->animation_trafo[TrajCamSysChoice->value()].multMatrixVec(src, vd1);
   md = mainAnimation->fov_trafo[TrajCamSysChoice->value()].inverse();
   md.multMatrixVec(vd1, vd3);
   
   mainAnimation->calc_animationTrafo(i+FirstStep->value(), objnr);
   mainAnimation->animation_trafo[TrajCamSysChoice->value()].multMatrixVec(src, vd2);
   md = mainAnimation->fov_trafo[TrajCamSysChoice->value()].inverse();
   md.multMatrixVec(vd2, vd4);
   
   if (RSFOV->value() > 0) //Reference system is "FOV"
   {
      vd1 = vd3;
      vd2 = vd4;
   }
   linexyz[2*i].setValue(vd1[0], vd1[1], vd1[2]);
   linexyz[2*i+1].setValue(vd2[0], vd2[1], vd2[2]);
}
sprintf(st, "%s", TrajectoryName->value());
objview->addLineObject(&st[0], linexyz, (numSteps-1), 2*(numSteps-1));
objview->objlist->type = 220 + 1000*TrajCamSysChoice->value();
objview->objlist->startStep = FirstStep->value()-1;
objview->objlist->stopStep = LastStep->value()-1;
//objview->objlist->point = src;
objview->objlist->point = dst; //070104
objview->objlist->camSys = TrajCamSysChoice->value();
objview->objlist->motionOfObject = TrajObjChoice->value()-1;
objview->objlist->reference = TrajRefChoice->value()-1;
for (j=0; j<18; j++)
objview->objlist->point_leds[j] = src_leds[j];
 mainAnimation->setRSnr(oldRSnr);

sprintf(st, "Actual Position of %s", TrajectoryName->value());
posxyz.setValue(0.0, 0.0, 0.0);
objview->addSphereObject(&st[0], &posxyz, 1, ledRadius, 0);

//edited on 26/11/2013 - dummy variable testing code operation
//sprintf(st, "Position of MIPT", TrajectoryName->value());
//posxyz.setValue(120.0, 120.0, 120.0);
//objview->addSphereObject(&st[0], &posxyz, 1, ledRadius, 0);

//objview->objlist->animated = 1;
objview->objlist->type = 221 + 1000*TrajCamSysChoice->value();
//objview->objlist->point = src;
objview->objlist->point = dst; //070104
objview->objlist->camSys = TrajCamSysChoice->value();
objview->objlist->motionOfObject = TrajObjChoice->value()-1;
objview->objlist->reference = TrajRefChoice->value()-1;
for (j=0; j<18; j++)
objview->objlist->point_leds[j] = src_leds[j];

TrajectoryWindow->hide();
objview->orderChildren();
applyMotion(-1);

delete[] linexyz;

for (j=0; j<18; j+=2)
printf("point(%2d): %9.3f\t%9.3f\t%9.3f\n",(j+1),objview->objlist->point_leds[j][0]
	   ,objview->objlist->point_leds[j][1],objview->objlist->point_leds[j][2]);

setObjectEditorObjects2();

oldobjcoord = TrajObjChoice->value();
oldrefcoord = TrajRefChoice->value();

switch (oldRSsysnr)//070105
{
   case -1: RSFOV->do_callback(MenuBarLEDViewer);  break;
   case  0: RSObj1->do_callback(MenuBarLEDViewer); break;
   case  1: RSObj2->do_callback(MenuBarLEDViewer); break;
   case  2: RSObj3->do_callback(MenuBarLEDViewer); break;
   case  3: RSObj4->do_callback(MenuBarLEDViewer); break;
   case  4: RSObj5->do_callback(MenuBarLEDViewer); break;
   case  5: RSObj6->do_callback(MenuBarLEDViewer); break;
   default: RSFOV->do_callback(MenuBarLEDViewer);  break;
};

}
void OPTISGui::cb_Tbtn_ok(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Tbtn_ok_i(o,v);
}

// Edit Trajectories Delete Button
inline void OPTISGui::cb_Tbtn_del_i(Fl_Button*, void*) {
  ObjectData *tmpdata, *prevdata;
int i;
char st[256], tst[256];

i = -1;
tmpdata = objview->objlist;
prevdata = tmpdata;
while ((tmpdata != NULL) && (i < oldTrajChoice))
{
//   if (((tmpdata->type%1000) >= 200)&&((tmpdata->type%1000) <= 220))
   if ((((tmpdata->type%1000) >= 200)&&((tmpdata->type%1000) <= 220))||((tmpdata->type%1000) == 222)) //060817
      i++;
   if (i < oldTrajChoice)
   {
      prevdata = tmpdata;
      tmpdata = tmpdata->next;
   }
}

objview->getLabel(tmpdata, &tst[0]);
sprintf(st, "Delete %s?", tst);
if (!fl_ask(st))
   return;

if ((tmpdata->type%1000) == 220)
objview->clearObject(tmpdata);
TrajectoryWindow->hide(); 
objview->redraw(); //original

setObjectEditorObjects2();
}
void OPTISGui::cb_Tbtn_del(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Tbtn_del_i(o,v);
}

// Edit Trajectories OK Button
inline void OPTISGui::cb_Tbtn_ok2_i(Fl_Return_Button*, void*) {
  // Trajektoriendaten ndern
	//trajectory change

SbVec3d vd1, vd2, vd3, vd4, testvec, tmp1;
SdMatrix md, m1;
ObjectData *tmpdata, *prevdata;
int i, numSteps, num, oldnum, type, camnr, lednr;
int *numVertices;

testvec.setValue(-120.0, -120.0, -120.0);

if ((FirstStep->value() < 1) || (FirstStep->value() > mainAnimation->num_steps))
   FirstStep->value(1);
if ((LastStep->value() < FirstStep->value()) || (LastStep->value() > mainAnimation->num_steps))
   LastStep->value(mainAnimation->num_steps);

i = -1;
tmpdata = objview->objlist;
while ((tmpdata != NULL) && (i < oldTrajChoice))
{
//   if (((tmpdata->type%1000) >= 200) && ((tmpdata->type%1000) <= 220))
   if ((((tmpdata->type%1000) >= 200) && ((tmpdata->type%1000) <= 220))||((tmpdata->type%1000) == 222))//060817
      i++;
   if (i < oldTrajChoice)
      tmpdata = tmpdata->next;
}
tmpdata->point.setValue(XCoord->value(), YCoord->value(), ZCoord->value());
tmpdata->startStep = FirstStep->value()-1;
tmpdata->stopStep = LastStep->value()-1;
tmpdata->camSys = TrajCamSysChoice->value();
tmpdata->type = (tmpdata->type%1000) + 1000*tmpdata->camSys;
tmpdata->motionOfObject = TrajObjChoice->value()-1;
tmpdata->reference = TrajRefChoice->value()-1;

tmpdata = objview->objlist;
prevdata = tmpdata;
while (tmpdata != NULL) 
{
   type = tmpdata->type%1000;
   camnr = tmpdata->type/1000;
   if ((type >= 200) && (type <= 220))
//   if ((type >= 200) && (type <= 222))//060817
   {
      numSteps = tmpdata->stopStep - tmpdata->startStep;
      num = 2*numSteps;
      numVertices = new int[numSteps];
      for (i=0; i<numSteps; i++)
         numVertices[i] = 2;
      oldnum = tmpdata->vertexproperty->vertex.getNum();
      if (oldnum > num)
      {
         tmpdata->vertexproperty->vertex.deleteValues(num, -1);
      }
      if (oldnum < num)
      {
         tmpdata->vertexproperty->vertex.insertSpace(oldnum, num-oldnum);
      }
      tmpdata->lineset->numVertices.deleteValues(0 , -1);
      tmpdata->lineset->numVertices.setValues(0, numSteps, numVertices);
      if (type < 220)
      {
         lednr = type%200;
         for(i=0; i<(numSteps); i++)
         {
            vd1 = mainAnimation->led[18*camnr+lednr][i+tmpdata->startStep];
            vd2 = mainAnimation->led[18*camnr+lednr][i+1+tmpdata->startStep];
            if ((vd1 == testvec) || (vd2 == testvec))
            {
               vd1 = vd2 = testvec;
            }
            else
            {
               if (mainAnimation->RSnr >= 0)
               {
                  mainAnimation->calc_animationTrafo(i+tmpdata->startStep);
                  mainAnimation->fov_trafo[camnr].multMatrixVec(mainAnimation->led[(18*camnr)+lednr][i+tmpdata->startStep], vd1);
                  mainAnimation->calc_animationTrafo(i+1+tmpdata->startStep);
                  mainAnimation->fov_trafo[camnr].multMatrixVec(mainAnimation->led[(18*camnr)+lednr][i+1+tmpdata->startStep], vd2);
               }
            }
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
      }
      else //type=220
      {
         if(tmpdata->reference == -1) //070105
		 {
         for (i=0; i<(numSteps); i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep);
            mainAnimation->animation_trafo[camnr].multMatrixVec(tmpdata->point, vd1);
            md = mainAnimation->fov_trafo[camnr].inverse();
            md.multMatrixVec(vd1, vd3);
            mainAnimation->calc_animationTrafo(i+1+tmpdata->startStep);
            mainAnimation->animation_trafo[camnr].multMatrixVec(tmpdata->point, vd2);
            md = mainAnimation->fov_trafo[camnr].inverse();
            md.multMatrixVec(vd2, vd4);
            if (RSFOV->value() > 0)
            {
               vd1 = vd3;
               vd2 = vd4;
            }
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
		 }

         else if(tmpdata->reference > -1) //070105
		 {
         mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
         m1 = mainAnimation->mRefRefSys[0].inverse();
         m1.multMatrixVec(tmpdata->point, tmp1);
         for (i=0; i<(numSteps); i++)
         {
            mainAnimation->calc_animationTrafo(i+tmpdata->startStep);
            mainAnimation->animation_trafo[camnr].multMatrixVec(tmp1, vd1);
            md = mainAnimation->fov_trafo[camnr].inverse();
            md.multMatrixVec(vd1, vd3);
            mainAnimation->calc_animationTrafo(i+1+tmpdata->startStep);
            mainAnimation->animation_trafo[camnr].multMatrixVec(tmp1, vd2);
            md = mainAnimation->fov_trafo[camnr].inverse();
            md.multMatrixVec(vd2, vd4);
            if (RSFOV->value() > 0)
            {
               vd1 = vd3;
               vd2 = vd4;
            }
            tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
         }
		 }
      }
      if (((tmpdata->type%1000) == 220) && ((prevdata->type%1000) == 221))
      {
         if(tmpdata->reference == -1) //070108
		 {
         prevdata->point = tmpdata->point;
         prevdata->camSys = tmpdata->camSys;
         prevdata->type = 1000*tmpdata->camSys + 221;
         prevdata->reference = tmpdata->reference; //070105
		 }
		 else if(tmpdata->reference > -1)
		 {
            mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
            m1 = mainAnimation->mRefRefSys[0].inverse();
            m1.multMatrixVec(tmpdata->point, tmp1);
         prevdata->point = tmpdata->point;
         prevdata->camSys = tmpdata->camSys;
         prevdata->type = 1000*tmpdata->camSys + 221;
         prevdata->reference = tmpdata->reference; //070105
		 }
      }
      /*if (((tmpdata->type%1000) == 222) )//060817
      {
         prevdata->point = tmpdata->point;
         prevdata->camSys = tmpdata->camSys;
         prevdata->type = 1000*tmpdata->camSys + 222;
      }*/
      delete[] numVertices;
   }
   prevdata = tmpdata;
   tmpdata = tmpdata->next;
}
TrajectoryWindow->hide();
applyMotion(-1);

switch (oldRSsysnr)//070105
{
   case -1: RSFOV->do_callback(MenuBarLEDViewer);  break;
   case  0: RSObj1->do_callback(MenuBarLEDViewer); break;
   case  1: RSObj2->do_callback(MenuBarLEDViewer); break;
   case  2: RSObj3->do_callback(MenuBarLEDViewer); break;
   case  3: RSObj4->do_callback(MenuBarLEDViewer); break;
   case  4: RSObj5->do_callback(MenuBarLEDViewer); break;
   case  5: RSObj6->do_callback(MenuBarLEDViewer); break;
   default: RSFOV->do_callback(MenuBarLEDViewer);  break;
};

}
void OPTISGui::cb_Tbtn_ok2(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Tbtn_ok2_i(o,v);
}

// Edit Trajectories Cancel Button
inline void OPTISGui::cb_Tbtn_cancel2_i(Fl_Button*, void*) {
  ObjectData *tmpdata;

tmpdata = objview->objlist;
while (tmpdata != NULL) 
{
//   if ((tmpdata->type >= 200) && (tmpdata->type <= 220))
//   if ((tmpdata->type >= 200) && (tmpdata->type <= 222))//060817
   if ((tmpdata->type >= 200) && (tmpdata->type <= 220) || (tmpdata->type == 222))//060817
   {
      tmpdata->point = tmpdata->oldpoint;
      tmpdata->startStep = tmpdata->oldStart;
      tmpdata->stopStep = tmpdata->oldStop;
      tmpdata->camSys = tmpdata->oldCamSys;
   }
   tmpdata = tmpdata->next;
}
TrajectoryWindow->hide();
objview->redraw();
}
void OPTISGui::cb_Tbtn_cancel2(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Tbtn_cancel2_i(o,v);
}

inline void OPTISGui::cb_Tbtn_ok3_i(Fl_Return_Button*, void*) {
  // Trajektorie einer LED einfgen (insert LED trajectory)

int i, camnr, lednr, type;
ObjectData *tmpdata;

if ((FirstStep->value() < 1) || (FirstStep->value() > mainAnimation->num_steps))
   FirstStep->value(1);
if ((LastStep->value() < FirstStep->value()) || (LastStep->value() > mainAnimation->num_steps))
   LastStep->value(mainAnimation->num_steps);

// Gewuenschte LED suchen (search the LED)
i = -1;
tmpdata = objview->objlist;
while ((tmpdata != NULL) && (i < LEDNameChoice->value()))
{
   type = tmpdata->type%1000;
   if ((type >= 100) && (type <= 117))
      i++;
   if (i < LEDNameChoice->value())
      tmpdata = tmpdata->next;
}
lednr = tmpdata->type%100;
camnr = tmpdata->type/1000;

// Kontrolle, ob Trajektorie bereits vorhanden (control if LED is already inserted)
i = 0;
tmpdata = objview->objlist;
while(tmpdata != NULL)
{
   if (tmpdata->type == ((1000*camnr)+200+lednr))
      i++;
   tmpdata = tmpdata->next;
}
if (i>0)
   return;

insertLEDTrajectory(lednr, camnr);
//TrajectoryWindow->hide(); //do not close the window 1129
applyMotion(-1);

setObjectEditorObjects2();
}
void OPTISGui::cb_Tbtn_ok3(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Tbtn_ok3_i(o,v);
}

inline void OPTISGui::cb_AboutOKBtn_i(Fl_Return_Button*, void*) {
  AboutWindow->hide();
}
void OPTISGui::cb_AboutOKBtn(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_AboutOKBtn_i(o,v);
}

inline void OPTISGui::cb_MatChoice1_i(Fl_Menu_*, void*) {
  SetMatrixWinValues(1);
}
void OPTISGui::cb_MatChoice1(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MatChoice1_i(o,v);
}

inline void OPTISGui::cb_MatChoice2_i(Fl_Menu_*, void*) {
  SetMatrixWinValues(2);
}
void OPTISGui::cb_MatChoice2(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MatChoice2_i(o,v);
}

inline void OPTISGui::cb_MatChoice3_i(Fl_Menu_*, void*) {
  SetMatrixWinValues(3);
}
void OPTISGui::cb_MatChoice3(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MatChoice3_i(o,v);
}

inline void OPTISGui::cb_MatChoice4_i(Fl_Menu_*, void*) {
  SetMatrixWinValues(4);
}
void OPTISGui::cb_MatChoice4(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MatChoice4_i(o,v);
}

inline void OPTISGui::cb_MatChoice5_i(Fl_Menu_*, void*) {
  SetMatrixWinValues(5);
}
void OPTISGui::cb_MatChoice5(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MatChoice5_i(o,v);
}

inline void OPTISGui::cb_MatChoice6_i(Fl_Menu_*, void*) {
  SetMatrixWinValues(6);
}
void OPTISGui::cb_MatChoice6(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MatChoice6_i(o,v);
}

inline void OPTISGui::cb_MatChoice7_i(Fl_Menu_*, void*) {
  SetMatrixWinValues(7);
}
void OPTISGui::cb_MatChoice7(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MatChoice7_i(o,v);
}

inline void OPTISGui::cb_MatChoice8_i(Fl_Menu_*, void*) {
  SetMatrixWinValues(8);
}
void OPTISGui::cb_MatChoice8(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MatChoice8_i(o,v);
}

inline void OPTISGui::cb_MatChoice9_i(Fl_Menu_*, void*) {
  SetMatrixWinValues(9);
}
void OPTISGui::cb_MatChoice9(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MatChoice9_i(o,v);
}

Fl_Menu_Item OPTISGui::menu_MatrixChoice[] = {
 {"1", 0,  (Fl_Callback*)OPTISGui::cb_MatChoice1, 0, 0, 0, 0, 14, 56},
 {"2", 0,  (Fl_Callback*)OPTISGui::cb_MatChoice2, 0, 0, 0, 0, 14, 56},
 {"3", 0,  (Fl_Callback*)OPTISGui::cb_MatChoice3, 0, 0, 0, 0, 14, 56},
 {"4", 0,  (Fl_Callback*)OPTISGui::cb_MatChoice4, 0, 0, 0, 0, 14, 56},
 {"5", 0,  (Fl_Callback*)OPTISGui::cb_MatChoice5, 0, 0, 0, 0, 14, 56},
 {"6", 0,  (Fl_Callback*)OPTISGui::cb_MatChoice6, 0, 0, 0, 0, 14, 56},
 {"7", 0,  (Fl_Callback*)OPTISGui::cb_MatChoice7, 0, 0, 0, 0, 14, 56},
 {"8", 0,  (Fl_Callback*)OPTISGui::cb_MatChoice8, 0, 0, 0, 0, 14, 56},
 {"9", 0,  (Fl_Callback*)OPTISGui::cb_MatChoice9, 0, 0, 0, 0, 14, 56},
 {0}
};
Fl_Menu_Item* OPTISGui::MatChoice1 = OPTISGui::menu_MatrixChoice + 0;
Fl_Menu_Item* OPTISGui::MatChoice2 = OPTISGui::menu_MatrixChoice + 1;
Fl_Menu_Item* OPTISGui::MatChoice3 = OPTISGui::menu_MatrixChoice + 2;
Fl_Menu_Item* OPTISGui::MatChoice4 = OPTISGui::menu_MatrixChoice + 3;
Fl_Menu_Item* OPTISGui::MatChoice5 = OPTISGui::menu_MatrixChoice + 4;
Fl_Menu_Item* OPTISGui::MatChoice6 = OPTISGui::menu_MatrixChoice + 5;
Fl_Menu_Item* OPTISGui::MatChoice7 = OPTISGui::menu_MatrixChoice + 6;
Fl_Menu_Item* OPTISGui::MatChoice8 = OPTISGui::menu_MatrixChoice + 7;
Fl_Menu_Item* OPTISGui::MatChoice9 = OPTISGui::menu_MatrixChoice + 8;

inline void OPTISGui::cb_Matrix_Cancel_i(Fl_Button*, void*) {
  MatrixWindow->hide();
}
void OPTISGui::cb_Matrix_Cancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Matrix_Cancel_i(o,v);
}

inline void OPTISGui::cb_Matrix_Ok_i(Fl_Return_Button*, void*) {
  int i, j, anz;
SbVec3d testvec;

SetMatrixWinValues(oldCamSys);
for (i=0; i<10; i++)
{
   pref->camSysRot[i] = tmpCamSysRot[i];
   pref->camSysTrans[i] = tmpCamSysTrans[i];
   pref->camSysOverlap[i] = tmpCamSysOverlap[i];
   mCamSysTrafo[i].makeIdentity();
   guiFixedXYZ(mCamSysTrafo[i],
      tmpCamSysRot[i][0]/180.0*3.14159,
      tmpCamSysRot[i][1]/180.0*3.14159,
      tmpCamSysRot[i][2]/180.0*3.14159);
   mCamSysTrafo[i][0][3] = tmpCamSysTrans[i][0];
   mCamSysTrafo[i][1][3] = tmpCamSysTrans[i][1];
   mCamSysTrafo[i][2][3] = tmpCamSysTrans[i][2];
}
resetCamSysTrafo();
MatrixWindow->hide();

if (mainAnimation != NULL)
{
   testvec.setValue(-120.0, -120.0, -120.0);
   anz = mainAnimation->led[0].getNum();
   for (i=0; i<(18*numCamSys); i++)
      for (j=0; j<anz; j++)
         if ((mainAnimation->led[i][j][0] > 100.0) || (mainAnimation->led[i][j][0] < -100.0) ||
             (mainAnimation->led[i][j][1] > 100.0) || (mainAnimation->led[i][j][1] < -100.0) ||
             (mainAnimation->led[i][j][2] > 100.0) || (mainAnimation->led[i][j][2] < -100.0))
            mainAnimation->led[i].set1Value(j, testvec);
   mainAnimation->calc_animationTrafo(0);
}

switch (mainAnimation->RSnr)
{
   case -1: RSFOV->do_callback(MenuBarLEDViewer);  break;
   case  0: RSObj1->do_callback(MenuBarLEDViewer); break;
   case  1: RSObj2->do_callback(MenuBarLEDViewer); break;
   case  2: RSObj3->do_callback(MenuBarLEDViewer); break;
   case  3: RSObj4->do_callback(MenuBarLEDViewer); break;
   case  4: RSObj5->do_callback(MenuBarLEDViewer); break;
   case  5: RSObj6->do_callback(MenuBarLEDViewer); break;
   default: RSFOV->do_callback(MenuBarLEDViewer);  break;
};
}
void OPTISGui::cb_Matrix_Ok(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Matrix_Ok_i(o,v);
}

inline void OPTISGui::cb_Matrix_Default_i(Fl_Button*, void*) {
  Matrix_Ok->do_callback();
pref->write_inifile();
}
void OPTISGui::cb_Matrix_Default(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_Matrix_Default_i(o,v);
}

inline void OPTISGui::cb_LEDCtrlConinuous_i(Fl_Round_Button*, void*) {
  LEDCtrlNext->deactivate();
}
void OPTISGui::cb_LEDCtrlConinuous(Fl_Round_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LEDCtrlConinuous_i(o,v);
}

inline void OPTISGui::cb_LEDCtrlManual_i(Fl_Round_Button*, void*) {
  LEDCtrlNext->activate();
}
void OPTISGui::cb_LEDCtrlManual(Fl_Round_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LEDCtrlManual_i(o,v);
}

inline void OPTISGui::cb_LEDCtrlNext_i(Fl_Button*, void*) {
  LEDNextValue = 1;
}
void OPTISGui::cb_LEDCtrlNext(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LEDCtrlNext_i(o,v);
}

inline void OPTISGui::cb_LEDSave_i(Fl_Button*, void*) {
  char *stuff, st[256], *fn, *xlstxt, tabOk, filename[256], tst[256];
int len, anz, i, j, k;
FILE *writefile;
time_t t;

if (scnfile != NULL)
{
   sprintf(st, "%s/", scnfile->scandir);
   fn = fl_file_chooser("Save LED Values: Enter Directory and File Name", "*.xls", &st[0]);
}
else
   fn = fl_file_chooser("Save LED Values: Enter Directory and File Name", "*.xls", NULL);
if (fn == NULL)
   return;

len = 0;
anz = LEDControlBrowser->size();

stuff = new char[anz*256];
for (i=0; i<(anz*256); i++)
   stuff[i] = '\0';
for (i=1; i<=anz; i++)
{
   sprintf(&stuff[(i-1)*256], "%s\r\n", LEDControlBrowser->text(i));
}

xlstxt = new char[anz*256];
for (i=0; i<(anz*256); i++)
   xlstxt[i] = '\0';
for (k=0; k<anz; k++)
{
   tabOk = 0;
   i = 256*k;
   j = 256*k;
   while((stuff[i] != '=') && (stuff[i] != '\0'))
   {
      xlstxt[j] = stuff[i];
      j++;
      i++;
   }
   j--;
   while((j >= 0) && (xlstxt[j] == ' '))
   {
      xlstxt[j] = '\0';
      j--;
   }
   j++;
   while(stuff[i] != '\0')
   {
      if ((stuff[i] == ' ') || (stuff[i] == '=') || 
          (stuff[i] == ',') || (stuff[i] == '(') || (stuff[i] == ')'))
      {
         if (tabOk == 0)
         {
            xlstxt[j] = '\t';
            j++;
            tabOk = 1;
         }
      }
      else
      {
         xlstxt[j] = stuff[i];
         j++;
         tabOk = 0;
      }
      i++;
   }
}

sprintf(st, fn);
i = strlen(st) - 1;
while ((i >= 0) && (st[i] != '.') && (st[i] != '/'))
   i--;
if (st[i] == '.')
   st[i] = '\0';
sprintf(filename, "%s.xls", st);
t = time(NULL);
strftime(&tst[0], 256, "date\t%d.%m.%Y\ttime\t%H:%M:%S", localtime(&t));
sprintf(st, "LED values\t%s\r\n\r\n", tst);
if((writefile = fopen(filename, "wb")) == NULL)
   fl_message("Could not open file\n%s", filename);
else
{
   len = strlen(&st[0]);
   fwrite(&st[0], len, 1, writefile);
   for (k=0; k<anz; k++)
   {
      len = strlen(&xlstxt[256*k]);
      fwrite(&xlstxt[256*k], len, 1, writefile);
   }
   fclose(writefile);
}

delete[] stuff;
delete[] xlstxt;
}
void OPTISGui::cb_LEDSave(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LEDSave_i(o,v);
}

inline void OPTISGui::cb_LEDCtrl2Coninuous_i(Fl_Round_Button*, void*) {
  LEDCtrl2Next->deactivate();
}
void OPTISGui::cb_LEDCtrl2Coninuous(Fl_Round_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LEDCtrl2Coninuous_i(o,v);
}

inline void OPTISGui::cb_LEDCtrl2Manual_i(Fl_Round_Button*, void*) {
  LEDCtrl2Next->activate();
}
void OPTISGui::cb_LEDCtrl2Manual(Fl_Round_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LEDCtrl2Manual_i(o,v);
}

inline void OPTISGui::cb_LEDCtrl2Next_i(Fl_Button*, void*) {
  LEDNextValue2 = 1;
}
void OPTISGui::cb_LEDCtrl2Next(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LEDCtrl2Next_i(o,v);
}

inline void OPTISGui::cb_LEDSave2_i(Fl_Button*, void*) {
  char *stuff, st[256], *fn, *xlstxt, tabOk, filename[256], tst[256];
int len, anz, i, j, k;
FILE *writefile;
time_t t;

if (scnfile != NULL)
{
   sprintf(st, "%s/", scnfile->scandir);
   fn = fl_file_chooser("Save  Relative Values: Enter Directory and File Name", "*.xls", &st[0]);
}
else
   fn = fl_file_chooser("Save Relative Values: Enter Directory and File Name", "*.xls", NULL);
if (fn == NULL)
   return;

len = 0;
anz = LEDControl2Browser->size();

stuff = new char[anz*256];
for (i=0; i<(anz*256); i++)
   stuff[i] = '\0';
for (i=1; i<=anz; i++)
{
   sprintf(&stuff[(i-1)*256], "%s\r\n", LEDControl2Browser->text(i));
}

xlstxt = new char[anz*256];
for (i=0; i<(anz*256); i++)
   xlstxt[i] = '\0';
for (k=0; k<anz; k++)
{
   tabOk = 0;
   i = 256*k;
   j = 256*k;
   while((stuff[i] != '=') && (stuff[i] != '\0'))
   {
      xlstxt[j] = stuff[i];
      j++;
      i++;
   }
   j--;
   while((j >= 0) && (xlstxt[j] == ' '))
   {
      xlstxt[j] = '\0';
      j--;
   }
   j++;
   while(stuff[i] != '\0')
   {
      if ((stuff[i] == ' ') || (stuff[i] == '=') || 
          (stuff[i] == ',') || (stuff[i] == '(') || (stuff[i] == ')'))
      {
         if (tabOk == 0)
         {
            xlstxt[j] = '\t';
            j++;
            tabOk = 1;
         }
      }
      else
      {
         xlstxt[j] = stuff[i];
         j++;
         tabOk = 0;
      }
      i++;
   }
}

sprintf(st, fn);
i = strlen(st) - 1;
while ((i >= 0) && (st[i] != '.') && (st[i] != '/'))
   i--;
if (st[i] == '.')
   st[i] = '\0';
sprintf(filename, "%s.xls", st);
t = time(NULL);
strftime(&tst[0], 256, "date\t%d.%m.%Y\ttime\t%H:%M:%S", localtime(&t));
sprintf(st, "Ref LED values\t%s\r\n\r\n", tst);
if((writefile = fopen(filename, "wb")) == NULL)
   fl_message("Could not open file\n%s", filename);
else
{
   len = strlen(&st[0]);
   fwrite(&st[0], len, 1, writefile);
   for (k=0; k<anz; k++)
   {
      len = strlen(&xlstxt[256*k]);
      fwrite(&xlstxt[256*k], len, 1, writefile);
   }
   fclose(writefile);
}

delete[] stuff;
delete[] xlstxt;
}
void OPTISGui::cb_LEDSave2(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->parent()->user_data()))->cb_LEDSave2_i(o,v);
}

inline void OPTISGui::cb_MvmNameWindow_i(Fl_Double_Window*, void*) {
  MvmNameWinOkBtn->do_callback();
}
void OPTISGui::cb_MvmNameWindow(Fl_Double_Window* o, void* v) {
  ((OPTISGui*)(o->user_data()))->cb_MvmNameWindow_i(o,v);
}
//select the comment
inline void OPTISGui::cb_MvmNameListChoice_i(Fl_Choice*, void*) {
setCommentList();
}
void OPTISGui::cb_MvmNameListChoice(Fl_Choice* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MvmNameListChoice_i(o,v);
}

inline void OPTISGui::cb_MvmNameWinOkBtn_i(Fl_Return_Button*, void*) {
  char c, message[260];
int i;

/*if (csoc.connected == 0)
{
   RecMotionBtn->value(0);
   cameraConnect->do_callback(MenuBarLEDViewer);
   return;
}*/

sprintf(mvmHeaderText, "%s", MvmNameWinInput->value());
for (i=0; i<260; i++)
   message[i] = '\0';
//sprintf(message, "h%s", mvmHeaderText);	//original
//changing part
sprintf(message, "h%s/%s/%s", pref->datapath, scnfile->scanmov.path, scnfile->scanmov.base);
sprintf((message+130), "h%s", mvmHeaderText);	//add 051128

if ((socketStopped == 0)&&(csoc.connected>0))
{
   do
   {
      c = csoc.SendMsg(&message[0], 260);
      if (c < 0)
          socketStopped = 1;
      Fl::check();
   } while ((c < 1)&&(socketStopped == 0)&&(csoc.connected>0));
}

MvmNameWindow->hide();
}
void OPTISGui::cb_MvmNameWinOkBtn(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_MvmNameWinOkBtn_i(o,v);
}

inline void OPTISGui::cb_lccsc0_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 0;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc0(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc0_i(o,v);
}

inline void OPTISGui::cb_lccsc1_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 1;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc1(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc1_i(o,v);
}

inline void OPTISGui::cb_lccsc2_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 2;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc2(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc2_i(o,v);
}

inline void OPTISGui::cb_lccsc3_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 3;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc3(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc3_i(o,v);
}

inline void OPTISGui::cb_lccsc4_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 4;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc4(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc4_i(o,v);
}

inline void OPTISGui::cb_lccsc5_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 5;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc5(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc5_i(o,v);
}

inline void OPTISGui::cb_lccsc6_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 6;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc6(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc6_i(o,v);
}

inline void OPTISGui::cb_lccsc7_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 7;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc7(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc7_i(o,v);
}

inline void OPTISGui::cb_lccsc8_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 8;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc8(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc8_i(o,v);
}

inline void OPTISGui::cb_lccsc9_i(Fl_Menu_*, void*) {
  setLEDCharValues(LEDCharActualCamSys);
LEDCharActualCamSys = 9;
getLEDCharValues(LEDCharActualCamSys);
}
void OPTISGui::cb_lccsc9(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_lccsc9_i(o,v);
}

Fl_Menu_Item OPTISGui::menu_LEDCharCamSysChoice[] = {
 {"main", 0,  (Fl_Callback*)OPTISGui::cb_lccsc0, 0, 0, 0, 0, 14, 56},
 {"1", 0,  (Fl_Callback*)OPTISGui::cb_lccsc1, 0, 0, 0, 0, 14, 56},
 {"2", 0,  (Fl_Callback*)OPTISGui::cb_lccsc2, 0, 0, 0, 0, 14, 56},
 {"3", 0,  (Fl_Callback*)OPTISGui::cb_lccsc3, 0, 0, 0, 0, 14, 56},
 {"4", 0,  (Fl_Callback*)OPTISGui::cb_lccsc4, 0, 0, 0, 0, 14, 56},
 {"5", 0,  (Fl_Callback*)OPTISGui::cb_lccsc5, 0, 0, 0, 0, 14, 56},
 {"6", 0,  (Fl_Callback*)OPTISGui::cb_lccsc6, 0, 0, 0, 0, 14, 56},
 {"7", 0,  (Fl_Callback*)OPTISGui::cb_lccsc7, 0, 0, 0, 0, 14, 56},
 {"8", 0,  (Fl_Callback*)OPTISGui::cb_lccsc8, 0, 0, 0, 0, 14, 56},
 {"9", 0,  (Fl_Callback*)OPTISGui::cb_lccsc9, 0, 0, 0, 0, 14, 56},
 {0}
};
Fl_Menu_Item* OPTISGui::lccsc0 = OPTISGui::menu_LEDCharCamSysChoice + 0;
Fl_Menu_Item* OPTISGui::lccsc1 = OPTISGui::menu_LEDCharCamSysChoice + 1;
Fl_Menu_Item* OPTISGui::lccsc2 = OPTISGui::menu_LEDCharCamSysChoice + 2;
Fl_Menu_Item* OPTISGui::lccsc3 = OPTISGui::menu_LEDCharCamSysChoice + 3;
Fl_Menu_Item* OPTISGui::lccsc4 = OPTISGui::menu_LEDCharCamSysChoice + 4;
Fl_Menu_Item* OPTISGui::lccsc5 = OPTISGui::menu_LEDCharCamSysChoice + 5;
Fl_Menu_Item* OPTISGui::lccsc6 = OPTISGui::menu_LEDCharCamSysChoice + 6;
Fl_Menu_Item* OPTISGui::lccsc7 = OPTISGui::menu_LEDCharCamSysChoice + 7;
Fl_Menu_Item* OPTISGui::lccsc8 = OPTISGui::menu_LEDCharCamSysChoice + 8;
Fl_Menu_Item* OPTISGui::lccsc9 = OPTISGui::menu_LEDCharCamSysChoice + 9;

inline void OPTISGui::cb_F200Hz_i(Fl_Menu_*, void*) {
  int i, j;

if (LEDGroups == NULL)
   return;

for (i=0; i<18; i++)
{
   LEDGroups[i]->activate();
   for(j=0; j<6; j++)
   {
      LEDGroupsBtn[i][j]->activate();
      if ((i/3) == j)
         LEDGroupsBtn[i][j]->setonly();
   }
}

for (i=0; i<6; i++)
{
   ObjGroups[i]->activate();
   for(j=0; j<7; j++)
   {
      if ((i+1) == j)
         ObjGroupsBtn[i][j]->deactivate();
      else
         ObjGroupsBtn[i][j]->activate();
   }
   if ((i%2) == 0)
      ObjGroupsBtn[i][0]->setonly();
   else
      ObjGroupsBtn[i][i]->setonly();
};
}
void OPTISGui::cb_F200Hz(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_F200Hz_i(o,v);
}

inline void OPTISGui::cb_F400Hz_i(Fl_Menu_*, void*) {
  int i, j;

if (LEDGroups == NULL)
   return;

for (i=0; i<9; i++)
{
   LEDGroups[i]->activate();
   for(j=0; j<3; j++)
   {
      LEDGroupsBtn[i][j]->activate();
      if ((i/3) == j)
         LEDGroupsBtn[i][j]->setonly();
   }
   for(j=3; j<6; j++)
   {
      LEDGroupsBtn[i][j]->deactivate();
   }
}
for (i=9; i<18; i++)
{
   LEDGroups[i]->deactivate();
}

for (i=0; i<3; i++)
{
   ObjGroups[i]->activate();
   for(j=0; j<4; j++)
   {
      if ((i+1) == j)
         ObjGroupsBtn[i][j]->deactivate();
      else
         ObjGroupsBtn[i][j]->activate();
   }
   for(j=4; j<7; j++)
   {
      ObjGroupsBtn[i][j]->deactivate();
   }
   if ((i%2) == 0)
      ObjGroupsBtn[i][0]->setonly();
   else
      ObjGroupsBtn[i][i]->setonly();
}
for (i=3; i<6; i++)
{
   ObjGroups[i]->deactivate();
};
}
void OPTISGui::cb_F400Hz(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_F400Hz_i(o,v);
}

inline void OPTISGui::cb_F600Hz_i(Fl_Menu_*, void*) {
  int i, j;

if (LEDGroups == NULL)
   return;

for (i=0; i<6; i++)
{
   LEDGroups[i]->activate();
   for(j=0; j<2; j++)
   {
      LEDGroupsBtn[i][j]->activate();
      if ((i/3) == j)
         LEDGroupsBtn[i][j]->setonly();
   }
   for(j=2; j<6; j++)
   {
      LEDGroupsBtn[i][j]->deactivate();
   }
}
for (i=6; i<18; i++)
{
   LEDGroups[i]->deactivate();
}

for (i=0; i<2; i++)
{
   ObjGroups[i]->activate();
   for(j=0; j<3; j++)
   {
      if ((i+1) == j)
         ObjGroupsBtn[i][j]->deactivate();
      else
         ObjGroupsBtn[i][j]->activate();
   }
   for(j=3; j<7; j++)
   {
      ObjGroupsBtn[i][j]->deactivate();
   }
   if ((i%2) == 0)
      ObjGroupsBtn[i][0]->setonly();
   else
      ObjGroupsBtn[i][i]->setonly();
}
for (i=2; i<6; i++)
{
   ObjGroups[i]->deactivate();
};
}
void OPTISGui::cb_F600Hz(Fl_Menu_* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_F600Hz_i(o,v);
}

Fl_Menu_Item OPTISGui::menu_LedCharSpeedFrequency[] = {
 {"200 Hz (18 LEDs)", 0,  (Fl_Callback*)OPTISGui::cb_F200Hz, 0, 0, 0, 0, 14, 56},
 {"400 Hz (9 LEDs)", 0,  (Fl_Callback*)OPTISGui::cb_F400Hz, 0, 0, 0, 0, 14, 56},
 {"600 Hz (6 LEDs)", 0,  (Fl_Callback*)OPTISGui::cb_F600Hz, 0, 0, 0, 0, 14, 56},
 {0}
};
Fl_Menu_Item* OPTISGui::F200Hz = OPTISGui::menu_LedCharSpeedFrequency + 0;
Fl_Menu_Item* OPTISGui::F400Hz = OPTISGui::menu_LedCharSpeedFrequency + 1;
Fl_Menu_Item* OPTISGui::F600Hz = OPTISGui::menu_LedCharSpeedFrequency + 2;

inline void OPTISGui::cb_LEDChar_Cancel_i(Fl_Button*, void*) {
  int i, j;

for (i=0; i<10; i++)
{
   for (j=0; j<18; j++)
      mainAnimation->LEDofObject[i][j] = mainAnimation->oldLEDofObject[i][j];
   for (j=0; j<6; j++)
      mainAnimation->ObjectsAndReferences[i][j] = mainAnimation->oldObjectsAndReferences[i][j];
   mainAnimation->Speed[i] = mainAnimation->oldSpeed[i];
}

LEDCharWindow->hide();
}
void OPTISGui::cb_LEDChar_Cancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_LEDChar_Cancel_i(o,v);
}

inline void OPTISGui::cb_LEDChar_Ok_i(Fl_Return_Button*, void*) {
	int inum,i,j;
	int cnum;
	int einfuegen2; //insert??
	char st2[256];
	SbVec3d testxyz;
	ObjectData *tmplist;
	testxyz.setValue(-120.0, -120.0, -120.0);
	
	setLEDCharValues(LEDCharActualCamSys);
//relationship between leds and objects
   for (j=0; j<18; j++)
		pref->LEDofObjectP[j] = mainAnimation->LEDofObject[0][j];
   for (j=0; j<6; j++)
		pref->ObjectsAndReferencesP[j] = mainAnimation->ObjectsAndReferences[0][j];
pref->write_inifile();

LEDCharWindow->hide();
if (mainAnimation != NULL)
   mainAnimation->RSchanged = 1;

for (j=0; j<6; j++)
{
   inum = 0;
   cnum = 0;
   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[0][i] == j)
      {
         if (mainAnimation->led[i][mainAnimation->animation_step] != testxyz)
            inum++;

      tmplist = objview->objlist;
		 while (tmplist != NULL)
		 {
//			printf("tmplist->type =%d\n", tmplist->type);
			if(tmplist->type==(100+i) && (tmplist->drawstyle->style.getValue() == SoDrawStyle::INVISIBLE))
			{
			cnum++;
//			printf("tmplist->type =%d\n", tmplist->type);
			}
		 tmplist = tmplist->next;
		 }

      }
   }
   if (inum < 3)
   {
      tmplist = objview->objlist;
      while (tmplist != NULL)
	  {
         if (tmplist->type == (j+2))
		 {
            objview->clearObject(tmplist);
		 }
         tmplist = tmplist->next;
	  }
   }
   else if(inum == 3)
   {
      einfuegen2 = 1;
      tmplist = objview->objlist;
      while (tmplist != NULL)
	  {
         if (tmplist->type == (j+2))
         {
            einfuegen2--;
            tmplist = NULL;
         }else{
            tmplist = tmplist->next;
		 }
      }
      if (einfuegen2 > 0)
	  {
	  sprintf(st2,"Axis Lines obj %d",j+1);
      objview->addLineObject2(&st2[0]);
      objview->objlist->type = j+2;
      if(cnum==3) objview->objlist->drawstyle->style = SoDrawStyle::INVISIBLE;
      objview->redraw();
	  }

   
   }
}
setObjectEditorObjects2();
applyMotion(0);

}
void OPTISGui::cb_LEDChar_Ok(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_LEDChar_Ok_i(o,v);
}

inline void OPTISGui::cb_ct_Cancel_i(Fl_Button*, void*) {
  ctStopped = 1;
camTestWin->hide();
}
void OPTISGui::cb_ct_Cancel(Fl_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_ct_Cancel_i(o,v);
}

inline void OPTISGui::cb_ct_Ok_i(Fl_Return_Button*, void*) {
  char *fn, startst[256], stopst[256], cmd[256], tst[256], filename[256], *xlstxt;
char st[256];
int startX, stopX, startY, stopY, steps, stepsX, stepsY;
clock_t goal;
int i, len;
FILE *writefile;
time_t t;
int posX, posY, wait;
double valueX, valueY, valueZ;
double diffX, diffY, diff;

if (mainAnimation == NULL)
   return;
if (mainAnimation->led == NULL)
   return;

ctStopped = 0;

if (scnfile != NULL)
{
   sprintf(st, "%s/", scnfile->scandir);
   fn = fl_file_chooser("Save Values: Enter Directory and File Name", "*.xls", &st[0]);
}
else
   fn = fl_file_chooser("Save Values: Enter Directory and File Name", "*.xls", NULL);
if (fn == NULL)
   return;

ct_Ok->deactivate();
sprintf(st, fn);
i = strlen(st) - 1;
while ((i >= 0) && (st[i] != '.') && (st[i] != '/'))
   i--;
if (st[i] == '.')
   st[i] = '\0';
sprintf(filename, "%s.xls", st);
t = time(NULL);
strftime(&tst[0], 256, "date\t%d.%m.%Y\ttime\t%H:%M:%S", localtime(&t));
sprintf(startst, "LED values\tbegin\t%s\r\n", tst);
if((writefile = fopen(filename, "wb")) == NULL)
{
   fl_message("Could not open file\n%s", filename);
   ct_Ok->activate();
   return;
}
else
   fclose(writefile);

startX = ctInitX->value();
startY = ctInitY->value();
stopX = ctFinalX->value();
stopY = ctFinalY->value();
steps = ctSteps->value();
wait = ctDelay->value();
stepsX = stopX-startX;
if (stepsX < 0)
   stepsX *= -1;
stepsX++;
stepsY = stopY-startY;
if (stepsY < 0)
   stepsY *= -1;
stepsY++;
if ((steps > stepsX) && (steps > stepsY))
{
   if (stepsX > stepsY)
      steps = stepsX;
   else
      steps = stepsY;
}

diffX = double(stopX - startX) / double(steps - 1);
diffY = double(stopY - startY) / double(steps - 1);

xlstxt = new char[steps*50];

for (i=0; i<steps; i++)
{
   diff = (diffX*i)-floor(diffX*i);
   if (diff >= 0.5)
      posX = startX+ceil(diffX*i);
   else
      posX = startX+floor(diffX*i);
   diff = (diffY*i)-floor(diffY*i);
   if (diff >= 0.5)
      posY = startY+ceil(diffY*i);
   else
      posY = startY+floor(diffY*i);
   sprintf(cmd, "plottercommand.exe PA %d, %d;", posX, posY);
   printf("%s\n", cmd);
   system(cmd);
   goal = wait + clock();
   while(goal > clock())
   {
      receiveOnceSocketData();
      Fl::check();
      if (ctStopped > 0)
      {
         delete[] xlstxt;
         ct_Ok->activate();
         return;
      }
   }
   valueX = mainAnimation->led[0][mainAnimation->animation_step][0];
   valueY = mainAnimation->led[0][mainAnimation->animation_step][1];
   valueZ = mainAnimation->led[0][mainAnimation->animation_step][2];
   sprintf(&xlstxt[50*i], "%d\t%d\t\t%.3f\t%.3f\t%.3f\r\n",
      posX, posY, valueX, valueY, valueZ);
}


t = time(NULL);
strftime(&tst[0], 256, "date\t%d.%m.%Y\ttime\t%H:%M:%S", localtime(&t));
sprintf(stopst, "LED values\tend\t%s\r\n\r\n", tst);
if((writefile = fopen(filename, "wb")) == NULL)
   fl_message("Could not open file\n%s", filename);
else
{
   len = strlen(&startst[0]);
   fwrite(&startst[0], len, 1, writefile);
   len = strlen(&stopst[0]);
   fwrite(&stopst[0], len, 1, writefile);
   for (i=0; i<steps; i++)
   {
      len = strlen(&xlstxt[50*i]);
      fwrite(&xlstxt[50*i], len, 1, writefile);
   }
   fclose(writefile);
}

delete[] xlstxt;

ct_Ok->activate();

camTestWin->hide();
}
void OPTISGui::cb_ct_Ok(Fl_Return_Button* o, void* v) {
  ((OPTISGui*)(o->parent()->parent()->user_data()))->cb_ct_Ok_i(o,v);
}

OPTISGui::OPTISGui() {
  Fl_Double_Window* w;
  oldRotX = 0.0;
  oldRotY = 0.0;
  oldRotZ = 0.0;
  oldTransX = 0.0;
  oldTransY = 0.0;
  oldZoom = 0.0;
  objdata = NULL;
  mainAnimation = NULL;
  secondAnimation = NULL;
  recStep = 1;
  RecTimeflag = 0; //Recording flag
  filecount = 0;
  oldRSsysnr = -1;
  oldrefcoord = 0;
  oldobjcoord = 2;
  comList = new Commentlist; //import comment list
  trajStep = 0;
  trajOk = 0;
  recBase = NULL;
  pref = NULL;
scnfile = NULL;
  sprintf(WindowTitle, "OPTIS");
  sprintf(imgFormat, "tif");
  sprintf(nomotiontxt, "no motion loaded");
  filmxbm = NULL;
film_bitmap = NULL;
photoxbm = NULL;
photo_bitmap = NULL;
stopxbm = NULL;
stop_bitmap = NULL;
resetxbm = NULL;
reset_bitmap = NULL;
 numLEDs = 6;
numCams = 3;
ledRadius = 3.0;
numCamSys = 1;//default =1
  patientGeladen = 0;
  oldTrajChoice = 0;
  help_dialog = new Fl_Help_Dialog;
  socketStopped = 0;
  tmpTransform = new SoTransform;
tmpTransform->ref();
  LEDNextValue = 0;
  iMean100 = 0;
vMean100.setValue(0.0, 0.0, 0.0);
jMean100.setValue(0.0, 0.0, 0.0);
  sprintf(mvmHeaderText, "No entry");
  LEDGroups = NULL; ObjGroups = NULL;
  for (LEDnum=0; LEDnum<18; LEDnum++)
{
   LEDmin[LEDnum].setValue(0.0, 0.0, 0.0);
   LEDmax[LEDnum].setValue(0.0, 0.0, 0.0);
   LEDmean[LEDnum].setValue(0.0, 0.0, 0.0);
   LEDimin[LEDnum].setValue(0.0, 0.0, 0.0);
   LEDimax[LEDnum].setValue(0.0, 0.0, 0.0);
   LEDimean[LEDnum].setValue(0.0, 0.0, 0.0);
}

LEDnum = 20;
  { Fl_Double_Window* o = LEDViewer = new Fl_Double_Window(576, 621, "OPTIS");
    w = o;
    o->callback((Fl_Callback*)cb_LEDViewer, (void*)(this));
    { Fl_Menu_Bar* o = MenuBarLEDViewer = new Fl_Menu_Bar(0, 0, 576, 25);
      o->menu(menu_MenuBarLEDViewer);
    }
    { Fl_Group* o = ControllerTop = new Fl_Group(0, 25, 576, 50);
      { Fl_Group* o = ControllerTopLeft = new Fl_Group(0, 50, 200, 25);
        { Fl_Button* o = RecMotionBtn = new Fl_Button(0, 51, 24, 24, "@circle");
          o->type(1);
          o->selection_color(3);
          o->labelcolor(1);
          o->callback((Fl_Callback*)cb_RecMotionBtn);
        }
        { Fl_Button* o = LoadMotionBtn = new Fl_Button(25, 51, 24, 24, "@menu");
          o->type(1);
          o->callback((Fl_Callback*)cb_LoadMotionBtn);
        }
        { Fl_Button* o = ResetMotionBtn = new Fl_Button(50, 51, 24, 24);
          o->callback((Fl_Callback*)cb_ResetMotionBtn);
        }
        { Fl_Button* o = PlayBackwardMotionBtn = new Fl_Button(75, 51, 24, 24, "@<");
          o->type(1);
          o->callback((Fl_Callback*)cb_PlayBackwardMotionBtn);
        }
        { Fl_Repeat_Button* o = RwdMotionBtn = new Fl_Repeat_Button(100, 51, 24, 24, "@|<");
          o->callback((Fl_Callback*)cb_RwdMotionBtn);
        }
        { Fl_Button* o = StopMotionBtn = new Fl_Button(125, 51, 24, 24);
          o->callback((Fl_Callback*)cb_StopMotionBtn);
          o->when(FL_WHEN_CHANGED);
        }
        { Fl_Repeat_Button* o = FwdMotionBtn = new Fl_Repeat_Button(150, 51, 24, 24, "@>|");
          o->callback((Fl_Callback*)cb_FwdMotionBtn);
        }
        { Fl_Button* o = StartMotionBtn = new Fl_Button(175, 51, 24, 24, "@>");
          o->type(1);
          o->callback((Fl_Callback*)cb_StartMotionBtn);
        }
        o->end();
      }
      { Fl_Group* o = ControllerTopMiddle = new Fl_Group(200, 50, 120, 25);
        { Fl_Slider* o = StepSlider = new Fl_Slider(200, 50, 120, 25);
          o->type(5);
          o->selection_color(0);
          o->step(0.01);
          o->callback((Fl_Callback*)cb_StepSlider);
          Fl_Group::current()->resizable(o);
        }
        o->end();
        Fl_Group::current()->resizable(o);
      }
      { Fl_Group* o = ControllerTopRight = new Fl_Group(320, 25, 256, 50);
        { Fl_Value_Input* o = StepNrOutput = new Fl_Value_Input(356, 25, 100, 24, "Step");
          o->maximum(1e+010);
          o->callback((Fl_Callback*)cb_StepNrOutput);
        }
        { Fl_Value_Output* o = NumberOfStepsOutput = new Fl_Value_Output(475, 25, 100, 24, "of");
          o->color(7);
          o->maximum(100000);
        }
        { Fl_Value_Output* o = TimeOutput = new Fl_Value_Output(475, 50, 100, 24, "Time [sec]");
          o->color(7);
          o->step(0.001);
        }
        { Fl_Box* o = CameraOkBox = new Fl_Box(383, 55, 16, 16);
          o->box(FL_DOWN_BOX);
          o->color(1);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Box* o = CameraOkText = new Fl_Box(321, 50, 64, 24, "Cameras");
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        }
        o->end();
      }
      { Fl_Group* o = ControllerTopNameBox = new Fl_Group(0, 25, 320, 25);
        { Fl_Output* o = MotionNameOutput = new Fl_Output(0, 25, 320, 25);
          Fl_Group::current()->resizable(o);
        }
        o->end();
      }
      o->end();
    }
    { Fl_Group* o = ObjectArea = new Fl_Group(30, 75, 516, 516);
      o->box(FL_DOWN_BOX);
      { Fl_Group* o = ObjectArea2 = new Fl_Group(31, 76, 514, 514);
        o->box(FL_DOWN_BOX);
        { ObjectViewer* o = objview = new ObjectViewer(32, 76, 512, 512);
          o->box(FL_FLAT_BOX);
          o->color(0);
          o->selection_color(10);
          o->labeltype(FL_NORMAL_LABEL);
          o->labelfont(0);
          o->labelsize(14);
          o->labelcolor(56);
          o->callback((Fl_Callback*)cb_objview);
          o->align(FL_ALIGN_CENTER);
          o->when(FL_WHEN_CHANGED);
          Fl_Group::current()->resizable(o);
        }
        o->end();
      }
      o->end();
      Fl_Group::current()->resizable(o);
    }
    { Fl_Group* o = ControllerLeft = new Fl_Group(0, 75, 30, 516);
      { Fl_Group* o = ControllerLeftTopGroup = new Fl_Group(0, 75, 30, 230);
        { Fl_Button* o = FilmButton = new Fl_Button(3, 75, 24, 24);
          o->type(1);
          o->selection_color(3);
          o->callback((Fl_Callback*)cb_FilmButton);
        }
        { Fl_Button* o = PhotoButton = new Fl_Button(3, 100, 24, 24);
          o->selection_color(3);
          o->callback((Fl_Callback*)cb_PhotoButton);
        }
/*        { Fl_Button* o = LoadRefMotionBtn = new Fl_Button(3, 140, 24, 24, "Ref");
          o->type(1);
          o->callback((Fl_Callback*)cb_LoadRefMotionBtn);
        }*/
      /*  { Fl_Button* o = AppAxisBtn = new Fl_Button(0, 180, 27, 19, "Axs");
          o->type(1);
          o->callback((Fl_Callback*)cb_AppAxisBtn);
        }
        { Fl_Button* o = AppTF1Btn = new Fl_Button(0, 200, 27, 19, "TF1");
          o->type(1);
          o->callback((Fl_Callback*)cb_AppTF1Btn);
        }
        { Fl_Button* o = AppTF2Btn = new Fl_Button(0, 220, 27, 19, "TF2");
          o->type(1);
          o->callback((Fl_Callback*)cb_AppTF2Btn);
        }
        { Fl_Button* o = AppTF3Btn = new Fl_Button(0, 240, 27, 19, "TF3");
          o->type(1);
          o->callback((Fl_Callback*)cb_AppTF3Btn);
        }
        { Fl_Button* o = AppCOSBtn = new Fl_Button(0, 260, 27, 19, "TFC");
          o->type(1);
          o->callback((Fl_Callback*)cb_AppCOSBtn);
        }
        { Fl_Button* o = AppledBtn = new Fl_Button(0, 280, 27, 19, "ALL");
          o->type(1);
          o->callback((Fl_Callback*)cb_AppledBtn);
        }
		*/
       o->end();
      }
      { Fl_Box* o = ControllerLeftMiddleBox = new Fl_Box(0, 305, 30, 39);
        Fl_Group::current()->resizable(o);
      }
      { Fl_Group* o = ControllerLeftBottom = new Fl_Group(0, 344, 30, 247);
        { Fl_Box* o = RotXBox = new Fl_Box(4, 493, 21, 96);
          o->box(FL_DOWN_BOX);
        }
        { Fl_Roller* o = RotX = new Fl_Roller(7, 496, 15, 90);
          o->box(FL_ENGRAVED_FRAME);
          o->minimum(-359);
          o->maximum(360);
          o->step(0.5);
          o->callback((Fl_Callback*)cb_RotX);
          o->align(FL_ALIGN_BOTTOM_LEFT);
        }
        { Fl_Box* o = TransYBox = new Fl_Box(4, 372, 21, 96, "Pan");
          o->box(FL_DOWN_BOX);
          o->align(FL_ALIGN_BOTTOM);
        }
        { Fl_Roller* o = TransY = new Fl_Roller(7, 375, 15, 90);
          o->box(FL_ENGRAVED_FRAME);
          o->minimum(-10000);
          o->maximum(10000);
          o->step(1);
          o->callback((Fl_Callback*)cb_TransY);
          o->align(FL_ALIGN_BOTTOM_LEFT);
        }
        o->end();
      }
      o->end();
    }
    { Fl_Group* o = ControllerBottom = new Fl_Group(0, 591, 577, 30);
      { Fl_Group* o = ControllerBottomLeft = new Fl_Group(0, 591, 499, 30);
        { Fl_Box* o = RotYBox = new Fl_Box(90, 595, 96, 21, "Pitch      Yaw");
          o->box(FL_DOWN_BOX);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Roller* o = RotY = new Fl_Roller(93, 598, 90, 15);
          o->type(1);
          o->box(FL_ENGRAVED_FRAME);
          o->minimum(-359);
          o->maximum(360);
          o->step(0.5);
          o->callback((Fl_Callback*)cb_RotY);
        }
        { Fl_Box* o = TransXBox = new Fl_Box(221, 595, 96, 21, "Pan");
          o->box(FL_DOWN_BOX);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Roller* o = TransX = new Fl_Roller(224, 598, 90, 15);
          o->type(1);
          o->box(FL_ENGRAVED_FRAME);
          o->minimum(-10000);
          o->maximum(10000);
          o->step(1);
          o->callback((Fl_Callback*)cb_TransX);
        }
        { Fl_Button* o = XView = new Fl_Button(340, 594, 24, 24, "X");//Change the label 20130207
          o->callback((Fl_Callback*)cb_XView);
        }
        { Fl_Button* o = YView = new Fl_Button(365, 594, 24, 24, "Y");
          o->callback((Fl_Callback*)cb_YView);
        }
        { Fl_Button* o = ZView = new Fl_Button(390, 594, 24, 24, "Z");
          o->callback((Fl_Callback*)cb_ZView);
        }
       /* { Fl_Button* o = FView = new Fl_Button(415, 606, 55, 15, "Frontal");
          o->callback((Fl_Callback*)cb_FView);
        }
        { Fl_Button* o = HView = new Fl_Button(415, 591, 65, 15, "Horizontal");
          o->callback((Fl_Callback*)cb_HView);
        }
        { Fl_Button* o = SView = new Fl_Button(472, 606, 50, 15, "Sagittal");
          o->callback((Fl_Callback*)cb_SView);
        }*/
		{ Fl_Value_Slider* o = transparency_slider2 = new Fl_Value_Slider(418, 594, 80, 24);
          o->type(5);
          o->selection_color(7);
          o->callback((Fl_Callback*)cb_transparency_slider2);
          o->align(FL_ALIGN_LEFT);
        }
        o->end();
      }
      { Fl_Group* o = ControllerBottomMiddle = new Fl_Group(499, 591, 36, 30);

		{ Fl_Choice* o = ObjWindow = new Fl_Choice(500, 594, 30, 24, "");
          o->down_box(FL_BORDER_BOX);
          o->callback((Fl_Callback*)cb_ObjWindow);
          Fl_Group::current()->resizable(o);
		}

	  o->end();
        Fl_Group::current()->resizable(o);
      }
      { Fl_Group* o = ControllerBottomRight = new Fl_Group(535, 591, 42, 30);
        { Fl_Group* o = ZoomText = new Fl_Group(542, 596, 35, 15, "Zoom");
          o->align(FL_ALIGN_TOP_RIGHT|FL_ALIGN_INSIDE);
          o->end();
        }
        o->end();
      }
      o->end();
    }
    { Fl_Group* o = ControllerRight = new Fl_Group(546, 75, 30, 516);
      { Fl_Group* o = ControllerRightTop = new Fl_Group(546, 75, 30, 230);
        { Fl_Value_Slider* o = SpeedSlider = new Fl_Value_Slider(548, 100, 24, 200, "V =");
          o->type(4);
          o->selection_color(0);
          o->minimum(0.1);
          o->maximum(4);
          o->step(0.1);
          o->value(1);
          o->align(FL_ALIGN_TOP);
        }
        o->end();
      }
      { Fl_Group* o = ControllerRightMiddle = new Fl_Group(546, 305, 30, 39);
        o->end();
        Fl_Group::current()->resizable(o);
      }
      { Fl_Group* o = ControllerRightBottom = new Fl_Group(546, 344, 30, 247);
        { Fl_Box* o = RotZBox = new Fl_Box(550, 372, 21, 96, "Roll");
          o->box(FL_DOWN_BOX);
          o->align(FL_ALIGN_BOTTOM);
        }
        { Fl_Roller* o = RotZ = new Fl_Roller(553, 375, 15, 90);
          o->box(FL_ENGRAVED_FRAME);
          o->minimum(-359);
          o->maximum(360);
          o->step(0.5);
          o->callback((Fl_Callback*)cb_RotZ);
        }
        { Fl_Box* o = ZoomBox = new Fl_Box(550, 493, 21, 96);
          o->box(FL_DOWN_BOX);
        }
        { Fl_Roller* o = Zoom = new Fl_Roller(553, 496, 15, 90);
          o->box(FL_ENGRAVED_FRAME);
          o->minimum(-10000);
          o->maximum(10000);
          o->step(1);
          o->callback((Fl_Callback*)cb_Zoom);
          o->align(FL_ALIGN_BOTTOM_LEFT);
        }
        o->end();
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = EditLEDViewer = new Fl_Double_Window(614, 443, "Object Editor");
    w = o;
    o->user_data((void*)(this));
    { Fl_Group* o = OTextPart = new Fl_Group(5, 5, 606, 55);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Choice* o = ObjectChoice = new Fl_Choice(123, 20, 378, 25, "Object               ");
        o->down_box(FL_BORDER_BOX);
        o->labelfont(1);
        o->callback((Fl_Callback*)cb_ObjectChoice);
      }
      { Fl_Button* o = EditObjectNameBtn = new Fl_Button(511, 20, 85, 25, "Edit Name");
        o->callback((Fl_Callback*)cb_EditObjectNameBtn);
      }
      o->end();
    }
    { Fl_Group* o = DrawStyleGroup = new Fl_Group(5, 63, 605, 90);
      o->box(FL_ENGRAVED_FRAME);
      o->labelfont(1);
      o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      { Fl_Check_Button* o = SolidRadio = new Fl_Check_Button(124, 68, 71, 30, "Solid");
        o->type(102);
        o->down_box(FL_DIAMOND_DOWN_BOX);
        o->value(1);
        o->selection_color(1);
        o->callback((Fl_Callback*)cb_SolidRadio);
      }
      { Fl_Check_Button* o = LineRadio = new Fl_Check_Button(228, 68, 67, 30, "Line");
        o->type(102);
        o->down_box(FL_DIAMOND_DOWN_BOX);
        o->selection_color(1);
        o->callback((Fl_Callback*)cb_LineRadio);
      }
      { Fl_Check_Button* o = PointRadio = new Fl_Check_Button(332, 68, 63, 30, "Point");
        o->type(102);
        o->down_box(FL_DIAMOND_DOWN_BOX);
        o->selection_color(1);
        o->callback((Fl_Callback*)cb_PointRadio);
      }
      { Fl_Check_Button* o = HideRadio = new Fl_Check_Button(436, 68, 69, 30, "Hide");
        o->type(102);
        o->down_box(FL_DIAMOND_DOWN_BOX);
        o->selection_color(1);
        o->callback((Fl_Callback*)cb_HideRadio);
      }
      { Fl_Value_Slider* o = PointSizeSlider = new Fl_Value_Slider(448, 115, 153, 25, "Point Size");
        o->type(5);
        o->selection_color(0);
        o->maximum(50);
        o->step(1);
        o->callback((Fl_Callback*)cb_PointSizeSlider);
        o->align(FL_ALIGN_TOP_LEFT);
        o->deactivate();
      }
      { Fl_Value_Slider* o = LineWidthSlider = new Fl_Value_Slider(128, 115, 153, 25, "Line Width");
        o->type(5);
        o->selection_color(0);
        o->maximum(50);
        o->step(1);
        o->callback((Fl_Callback*)cb_LineWidthSlider);
        o->align(FL_ALIGN_TOP_LEFT);
        o->deactivate();
      }
      { Fl_Value_Slider* o = LinePatternSlider = new Fl_Value_Slider(288, 115, 153, 25, "Line Pattern");
        o->type(5);
        o->selection_color(0);
        o->maximum(100);
        o->step(1);
        o->value(100);
        o->callback((Fl_Callback*)cb_LinePatternSlider);
        o->align(FL_ALIGN_TOP_LEFT);
        o->deactivate();
      }
      { Fl_Box* o = DrawStyleTxtBox = new Fl_Box(11, 68, 105, 30, "Drawing Style");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }
      o->end();
    }
    { Fl_Group* o = OColorPart = new Fl_Group(4, 156, 606, 240);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = colorgrp = new Fl_Group(12, 161, 565, 35, "Colors");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Group* o = PlainColorGroup = new Fl_Group(5, 191, 605, 200);
        { Fl_Value_Slider* o = ambient_red = new Fl_Value_Slider(127, 279, 154, 25);
          o->type(5);
          o->selection_color(1);
          o->value(1.0);
          o->callback((Fl_Callback*)cb_ambient_red);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = diffuse_red = new Fl_Value_Slider(127, 305, 154, 25);
          o->type(5);
          o->selection_color(1);
          o->value(0.8);
          o->callback((Fl_Callback*)cb_diffuse_red);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = emission_red = new Fl_Value_Slider(127, 331, 154, 25);
          o->type(5);
          o->selection_color(1);
          o->callback((Fl_Callback*)cb_emission_red);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = specular_red = new Fl_Value_Slider(127, 357, 154, 25);
          o->type(5);
          o->selection_color(1);
          o->value(1);
          o->callback((Fl_Callback*)cb_specular_red);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = ambient_green = new Fl_Value_Slider(287, 279, 154, 25);
          o->type(5);
          o->selection_color(59);
	  o->value(1.0);
          o->callback((Fl_Callback*)cb_ambient_green);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = diffuse_green = new Fl_Value_Slider(287, 305, 154, 25);
          o->type(5);
          o->selection_color(59);
          o->value(0.8);
          o->callback((Fl_Callback*)cb_diffuse_green);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = emission_green = new Fl_Value_Slider(287, 331, 154, 25);
          o->type(5);
          o->selection_color(59);
          o->callback((Fl_Callback*)cb_emission_green);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = specular_green = new Fl_Value_Slider(287, 357, 154, 25);
          o->type(5);
          o->selection_color(59);
          o->value(1);
          o->callback((Fl_Callback*)cb_specular_green);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = ambient_blue = new Fl_Value_Slider(447, 279, 154, 25);
          o->type(5);
          o->selection_color(4);
          o->value(1.0);
          o->callback((Fl_Callback*)cb_ambient_blue);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = diffuse_blue = new Fl_Value_Slider(447, 305, 154, 25);
          o->type(5);
          o->selection_color(4);
          o->value(0.8);
          o->callback((Fl_Callback*)cb_diffuse_blue);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = emission_blue = new Fl_Value_Slider(447, 331, 154, 25);
          o->type(5);
          o->selection_color(4);
          o->callback((Fl_Callback*)cb_emission_blue);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Value_Slider* o = specular_blue = new Fl_Value_Slider(447, 357, 154, 25);
          o->type(5);
          o->selection_color(4);
          o->value(1);
          o->callback((Fl_Callback*)cb_specular_blue);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Group* o = ambgrp = new Fl_Group(12, 279, 110, 25, "Ambient");
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
          o->end();
        }
        { Fl_Group* o = diffgrp = new Fl_Group(12, 305, 110, 25, "Diffuse");
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
          o->end();
        }
        { Fl_Group* o = emigrp = new Fl_Group(12, 331, 110, 25, "Emission");
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
          o->end();
        }
        { Fl_Group* o = specgrp = new Fl_Group(12, 357, 110, 25, "Specular");
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
          o->end();
        }
        { Fl_Group* o = redgrp = new Fl_Group(127, 255, 110, 25, "Red");
          o->labelcolor(1);
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
          o->end();
        }
        { Fl_Group* o = greengrp = new Fl_Group(287, 255, 110, 25, "Green");
          o->labelcolor(59);
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
          o->end();
        }
        { Fl_Group* o = bluegrp = new Fl_Group(447, 255, 110, 25, "Blue");
          o->labelcolor(4);
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
          o->end();
        }
        { Fl_Value_Slider* o = shininess_slider = new Fl_Value_Slider(127, 223, 300, 25);
          o->type(5);
          o->selection_color(3);
          o->value(1);
          o->callback((Fl_Callback*)cb_shininess_slider);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Group* o = shingrp = new Fl_Group(12, 223, 110, 25, "Shininess");
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
          o->end();
        }
        { Fl_Value_Slider* o = transparency_slider = new Fl_Value_Slider(127, 197, 300, 25);
          o->type(5);
          o->selection_color(7);
          o->callback((Fl_Callback*)cb_transparency_slider);
          o->align(FL_ALIGN_LEFT);
        }
        { Fl_Group* o = transgrp = new Fl_Group(12, 197, 110, 25, "Transparency");
          o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
          o->end();
        }
        { Fl_Button* o = defaultcolorsbtn = new Fl_Button(510, 211, 85, 25, "Default");
          o->callback((Fl_Callback*)cb_defaultcolorsbtn);
        }
        o->end();
      }
      o->end();
    }
    { Fl_Group* o = OButtonPart = new Fl_Group(4, 399, 606, 40);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Button* o = Obtn_cancel = new Fl_Button(390, 407, 85, 25, "Cancel");
        o->callback((Fl_Callback*)cb_Obtn_cancel);
      }
      { Fl_Return_Button* o = Obtn_ok = new Fl_Return_Button(510, 407, 85, 25, "Ok");
        o->callback((Fl_Callback*)cb_Obtn_ok);
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = MotionWindow = new Fl_Double_Window(712, 367, "Load Motion");
    w = o;
    o->user_data((void*)(this));
    { Fl_Browser* o = MotionBrowser = new Fl_Browser(0, 0, 710, 325);
      o->type(2);
      o->textfont(4);
      Fl_Group::current()->resizable(o);
    }
    { Fl_Group* o = MWBtnGroup = new Fl_Group(0, 330, 710, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = MWBtnLeftGrp = new Fl_Group(0, 335, 490, 25);
        o->end();
        Fl_Group::current()->resizable(o);
      }
      { Fl_Group* o = MWBtnRightGrp = new Fl_Group(490, 335, 215, 25);
        { Fl_Return_Button* o = LoadMotionOk = new Fl_Return_Button(620, 335, 85, 25, "OK");
          o->callback((Fl_Callback*)cb_LoadMotionOk);
        }
        { Fl_Button* o = LoadMotionCancel = new Fl_Button(510, 335, 85, 25, "Cancel");
          o->callback((Fl_Callback*)cb_LoadMotionCancel);
        }
        o->end();
      }
      o->end();
    }
    o->end();
  }

    { Fl_Double_Window* o = ImpTrajWindow = new Fl_Double_Window(712, 367, "Import Trajectory");
    w = o;
    o->user_data((void*)(this));
    { Fl_Browser* o = ImpTrajBrowser = new Fl_Browser(0, 0, 710, 325);
      o->type(2);
      o->textfont(4);
      Fl_Group::current()->resizable(o);
    }
    { Fl_Group* o = ITBtnGroup = new Fl_Group(0, 330, 710, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = ITBtnLeftGrp = new Fl_Group(0, 335, 490, 25);
        o->end();
        Fl_Group::current()->resizable(o);
      }
      { Fl_Group* o = ITBtnRightGrp = new Fl_Group(490, 335, 215, 25);
        { Fl_Return_Button* o = ImpTrajOk = new Fl_Return_Button(620, 335, 85, 25, "OK");
          o->callback((Fl_Callback*)cb_ImpTrajOk);
        }
        { Fl_Button* o = ImpTrajCancel = new Fl_Button(510, 335, 85, 25, "Cancel");
          o->callback((Fl_Callback*)cb_ImpTrajCancel);
        }
        o->end();
      }
      o->end();
    }
    o->end();
  }

    { Fl_Double_Window* o = ChsTrajWindow = new Fl_Double_Window(612, 267, "Choose Trajectory");
    w = o;
    o->user_data((void*)(this));
    { Fl_Browser* o = ChsTrajBrowser = new Fl_Browser(0, 0, 610, 225);
      o->type(2);
      o->textfont(4);
      Fl_Group::current()->resizable(o);
    }
    { Fl_Group* o = CTBtnGroup = new Fl_Group(0, 230, 610, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = CTBtnLeftGrp = new Fl_Group(0, 235, 390, 25);
        o->end();
        Fl_Group::current()->resizable(o);
      }
      { Fl_Group* o = CTBtnRightGrp = new Fl_Group(390, 235, 215, 25);
        { Fl_Return_Button* o = ChsTrajOk = new Fl_Return_Button(520, 235, 85, 25, "OK");
          o->callback((Fl_Callback*)cb_ChsTrajOk);
        }
        { Fl_Button* o = ChsTrajCancel = new Fl_Button(410, 235, 85, 25, "Cancel");
          o->callback((Fl_Callback*)cb_ChsTrajCancel);
        }
        o->end();
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = WindowSizeWindow = new Fl_Double_Window(197, 126, "Window Size");
    w = o;
    o->user_data((void*)(this));
    { Fl_Group* o = WSWTextGroup = new Fl_Group(0, 0, 195, 85);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Value_Input* o = inputWindowWidth = new Fl_Value_Input(55, 29, 55, 25, "Width");
        o->minimum(512);
        o->maximum(5000);
        o->step(1);
        o->value(512);
      }
      { Fl_Value_Input* o = inputWindowHeight = new Fl_Value_Input(55, 54, 55, 25, "Height");
        o->minimum(480);
        o->maximum(5000);
        o->step(1);
        o->value(512);
      }
      { Fl_Group* o = WSWTGTitle = new Fl_Group(5, 4, 140, 25, "Enter New  Size");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Group* o = WSWTGText1 = new Fl_Group(110, 54, 70, 25, "(min. 480)");
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Group* o = WSWTGText2 = new Fl_Group(110, 29, 75, 25, "(min. 512)");
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      o->end();
    }
    { Fl_Group* o = WSWBtnGroup = new Fl_Group(0, 88, 195, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Button* o = WSW_Cancel = new Fl_Button(5, 93, 85, 25, "Cancel");
        o->callback((Fl_Callback*)cb_WSW_Cancel);
      }
      { Fl_Return_Button* o = WSW_Ok = new Fl_Return_Button(105, 93, 85, 25, "Ok");
        o->callback((Fl_Callback*)cb_WSW_Ok);
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = PrefWindow = new Fl_Double_Window(685, 603, "Preferences");
    w = o;
    o->user_data((void*)(this));
    { Fl_Group* o = PathInputGroup = new Fl_Group(5, 5, 675, 200);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = txtgrpPath = new Fl_Group(14, 10, 180, 25, "Path of the Database");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      inputScanPath = new Fl_Input(125, 35, 480, 25, "Scan Files");
      { Fl_Button* o = PrefScnDirBrowser = new Fl_Button(610, 35, 60, 25, "Browse");
        o->callback((Fl_Callback*)cb_PrefScnDirBrowser);
      }
      inputDataPath = new Fl_Input(125, 60, 480, 25, "Data Files");
      { Fl_Button* o = PrefDataDirBrowser = new Fl_Button(610, 60, 60, 25, "Browse");
        o->callback((Fl_Callback*)cb_PrefDataDirBrowser);
      }
      { Fl_Group* o = txtgrpImgCopy = new Fl_Group(14, 95, 230, 25, "Image Conversion Program");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Input* o = inputImgCopy = new Fl_Input(125, 120, 480, 25, "Path & Name");
        o->callback((Fl_Callback*)cb_inputImgCopy);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Button* o = PrefImgCopyBrowser = new Fl_Button(610, 120, 60, 25, "Browse");
        o->callback((Fl_Callback*)cb_PrefImgCopyBrowser);
      }
      { Fl_Input* o = inputExtraCode = new Fl_Input(125, 146, 480, 25, "Extra Code");
        o->callback((Fl_Callback*)cb_inputExtraCode);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Output* o = outputImgCopy = new Fl_Output(125, 170, 545, 25, "Command Line");
        o->color(49);
      }
      o->end();
    }
    { Fl_Group* o = WindowInputGroup = new Fl_Group(5, 208, 675, 143);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = txtgrpWindow = new Fl_Group(14, 213, 180, 25, "Window");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Value_Input* o = wigWidth = new Fl_Value_Input(125, 238, 60, 25, "Size:  Width");
        o->minimum(512);
        o->maximum(5000);
        o->step(1);
        o->value(512);
      }
      { Fl_Value_Input* o = wigHeight = new Fl_Value_Input(275, 238, 60, 25, "Height");
        o->minimum(480);
        o->maximum(5000);
        o->step(1);
        o->value(480);
      }
      { Fl_Value_Input* o = wigXPos = new Fl_Value_Input(125, 263, 60, 25, "Position:         X");
        o->maximum(5000);
        o->step(1);
        o->value(512);
      }
      { Fl_Value_Input* o = wigYPos = new Fl_Value_Input(275, 263, 60, 25, "Y");
        o->maximum(5000);
        o->step(1);
        o->value(512);
      }
      { Fl_Group* o = txtgrpBckgrdColor = new Fl_Group(10, 296, 230, 25, "Background Color");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Button* o = BgCChangeBtn = new Fl_Button(350, 321, 85, 25, "Change");
        o->callback((Fl_Callback*)cb_BgCChangeBtn);
      }
      { Fl_Group* o = ColorArea = new Fl_Group(85, 321, 275, 30);
        { TmjColorChip* o = NewColorBox = new TmjColorChip(275, 321, 60, 25, "New");
          o->box(FL_ENGRAVED_FRAME);
          o->color(4);
          o->selection_color(49);
          o->labeltype(FL_NORMAL_LABEL);
          o->labelfont(0);
          o->labelsize(14);
          o->labelcolor(56);
          o->align(FL_ALIGN_LEFT);
          o->when(FL_WHEN_CHANGED);
        }
        { TmjColorChip* o = OldColorBox = new TmjColorChip(125, 321, 60, 25, "Old");
          o->box(FL_ENGRAVED_FRAME);
          o->color(1);
          o->selection_color(49);
          o->labeltype(FL_NORMAL_LABEL);
          o->labelfont(0);
          o->labelsize(14);
          o->labelcolor(56);
          o->align(FL_ALIGN_LEFT);
          o->when(FL_WHEN_CHANGED);
        }
        o->end();
      }
      { Fl_Group* o = wigDrawingAreaGroup = new Fl_Group(350, 238, 270, 25, "(drawing area)");
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      o->end();
    }
    { Fl_Group* o = PrefThresholdValuesGroup = new Fl_Group(5, 354, 675, 65);
      o->box(FL_ENGRAVED_BOX);
      { Fl_Group* o = txtgrpThresVal = new Fl_Group(15, 359, 240, 25, "LED Intensity Threshold Values");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Value_Input* o = LEDOkay = new Fl_Value_Input(125, 384, 35, 25, "Clearly Visible");
        o->maximum(255);
        o->step(1);
        o->value(180);
      }
      { Fl_Value_Input* o = LEDVisible = new Fl_Value_Input(295, 384, 35, 25, "Visible");
        o->color(11);
        o->labelcolor(0);
        o->maximum(255);
        o->step(1);
        o->value(150);
      }
      { Fl_Value_Input* o = LEDWeakly = new Fl_Value_Input(465, 384, 35, 25, "Weakly Visible");
        o->color(3);
        o->maximum(255);
        o->step(1);
        o->value(120);
      }
      { Fl_Value_Output* o = LEDError = new Fl_Value_Output(635, 384, 35, 25, "Invisible");
        o->box(FL_DOWN_BOX);
        o->color(1);
        o->textcolor(7);
      }
      LEDOkayTxtBox = new Fl_Box(240, 359, 60, 25, "[0..255]");
      o->end();
    }
    { Fl_Group* o = PrefSocketGroup = new Fl_Group(5, 422, 675, 128);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = txtgrpSocket = new Fl_Group(15, 432, 180, 25, "Camera Socket");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      inputSocketPort = new Fl_Input(135, 457, 60, 25, "Port");
      inputSocketHost = new Fl_Input(275, 457, 395, 25, "Host");
      inputOPTISController = new Fl_Input(135, 482, 470, 25, "OPTIS Controller");
      { Fl_Button* o = OPTISContrBrowse = new Fl_Button(610, 482, 60, 25, "Browse");
        o->callback((Fl_Callback*)cb_OPTISContrBrowse);
      }
      inputTempDir = new Fl_Input(135, 507, 470, 25, "Temp Directory");
      { Fl_Button* o = TempDirBrowse = new Fl_Button(610, 507, 60, 25, "Browse");
        o->callback((Fl_Callback*)cb_TempDirBrowse);
      }
      o->end();
    }
    { Fl_Group* o = PathButtonGroup = new Fl_Group(5, 553, 675, 45);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Button* o = PrefCancel = new Fl_Button(475, 563, 85, 25, "Cancel");
        o->callback((Fl_Callback*)cb_PrefCancel);
      }
      { Fl_Return_Button* o = PrefOk = new Fl_Return_Button(585, 563, 85, 25, "Ok");
        o->callback((Fl_Callback*)cb_PrefOk);
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = PatientWindow = new Fl_Double_Window(676, 533, "OPTIS: Database");
    w = o;
    o->user_data((void*)(this));
    { Fl_Group* o = PatientDataGroup = new Fl_Group(0, 0, 675, 190);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Box* o = PatientText = new Fl_Box(5, 6, 80, 25, "Subject");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }
      { Fl_Group* o = PatientRadioGroup = new Fl_Group(86, 5, 340, 31);
        { Fl_Check_Button* o = NewPatientBtn = new Fl_Check_Button(110, 6, 70, 25, "New");
          o->type(102);
          o->down_box(FL_DIAMOND_DOWN_BOX);
          o->value(1);
          o->selection_color(1);
          o->callback((Fl_Callback*)cb_NewPatientBtn);
        }
        { Fl_Check_Button* o = ExistingPatientBtn = new Fl_Check_Button(280, 5, 75, 25, "Existing");
          o->type(102);
          o->down_box(FL_DIAMOND_DOWN_BOX);
          o->selection_color(1);
          o->callback((Fl_Callback*)cb_ExistingPatientBtn);
        }
        o->end();
      }
      { Fl_Input* o = PatientName = new Fl_Input(110, 31, 555, 25, "Name");
        o->callback((Fl_Callback*)cb_PatientName);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Input* o = PatientFirstName = new Fl_Input(110, 56, 555, 25, "First Name");
        o->callback((Fl_Callback*)cb_PatientFirstName);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Input* o = PatientAnatomy = new Fl_Input(110, 81, 555, 25, "Anatomy");
        o->callback((Fl_Callback*)cb_PatientAnatomy);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Input* o = PatientRecordingDate = new Fl_Input(110, 106, 170, 25, "Recording Date");
        o->callback((Fl_Callback*)cb_PatientRecordingDate);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Input* o = PatientRemarks = new Fl_Input(110, 131, 555, 25, "Remarks");
        o->callback((Fl_Callback*)cb_PatientRemarks);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Input* o = PatientScanFileName = new Fl_Input(110, 156, 555, 25, "Scan Filename");
        o->callback((Fl_Callback*)cb_PatientScanFileName);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Button* o = PatientHelp = new Fl_Button(480, 5, 75, 25, "Help");
        o->labelfont(1);
        o->callback((Fl_Callback*)cb_PatientHelp);
      }
      { Fl_Group* o = dateGrp = new Fl_Group(280, 100, 390, 35);
        { Fl_Round_Button* o = iPatDMY = new Fl_Round_Button(300, 106, 110, 25, "DD.MM.YYYY");
          o->type(102);
          o->down_box(FL_ROUND_DOWN_BOX);
          o->value(1);
          o->callback((Fl_Callback*)cb_iPatDMY);
        }
        { Fl_Round_Button* o = iPatYMD = new Fl_Round_Button(430, 106, 110, 25, "YYYY.MM.DD");
          o->type(102);
          o->down_box(FL_ROUND_DOWN_BOX);
          o->callback((Fl_Callback*)cb_iPatYMD);
        }
        { Fl_Round_Button* o = iPatMDY = new Fl_Round_Button(560, 106, 105, 25, "MM.DD.YYYY");
          o->type(102);
          o->down_box(FL_ROUND_DOWN_BOX);
          o->callback((Fl_Callback*)cb_iPatMDY);
        }
        o->end();
      }
      o->end();
    }
    { Fl_Group* o = FileBaseInputGroup = new Fl_Group(0, 192, 675, 60);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = pattxtgrpFileBase = new Fl_Group(5, 197, 235, 25, "Prefix of the Movement Files");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Input* o = patInputFileBase = new Fl_Input(110, 222, 555, 25, "Name");
        o->callback((Fl_Callback*)cb_patInputFileBase);
        o->when(FL_WHEN_CHANGED);
      }
      o->end();
    }
    { Fl_Group* o = PatientDirGroup = new Fl_Group(0, 254, 675, 141);
      o->box(FL_ENGRAVED_FRAME);
      o->labelfont(1);
      o->callback((Fl_Callback*)cb_PatientDirGroup);
      o->align(FL_ALIGN_TOP_LEFT|FL_ALIGN_INSIDE);
      { Fl_Check_Button* o = PatDirAutoBtn = new Fl_Check_Button(110, 260, 155, 25, "Build Automatically");
        o->type(102);
        o->down_box(FL_DIAMOND_DOWN_BOX);
        o->value(1);
        o->selection_color(1);
        o->callback((Fl_Callback*)cb_PatDirAutoBtn);
      }
      { Fl_Check_Button* o = PatDirExistBtn = new Fl_Check_Button(280, 260, 120, 25, "Use Existing");
        o->type(102);
        o->down_box(FL_DIAMOND_DOWN_BOX);
        o->selection_color(1);
        o->callback((Fl_Callback*)cb_PatDirExistBtn);
      }
      { Fl_Box* o = PatientDirText = new Fl_Box(5, 261, 100, 25, "Directories");
        o->labelfont(1);
        o->callback((Fl_Callback*)cb_PatientDirText);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }
      { Fl_Input* o = PatientScanDirectory = new Fl_Input(110, 285, 270, 25, "Scan Directory");
        o->callback((Fl_Callback*)cb_PatientScanDirectory);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Input* o = PatientScanPath = new Fl_Input(110, 310, 490, 25, "Scan Path");
        o->callback((Fl_Callback*)cb_PatientScanPath);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Input* o = PatientDataDirectory = new Fl_Input(110, 335, 270, 25, "Data Directory");
        o->callback((Fl_Callback*)cb_PatientDataDirectory);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Input* o = PatientDataPath = new Fl_Input(110, 360, 490, 25, "Data Path");
        o->callback((Fl_Callback*)cb_PatientDataPath);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Button* o = PatScnDirBrowser = new Fl_Button(605, 310, 60, 25, "Browse");
        o->callback((Fl_Callback*)cb_PatScnDirBrowser);
        o->deactivate();
      }
      { Fl_Button* o = PatDataDirBrowser = new Fl_Button(605, 360, 60, 25, "Browse");
        o->callback((Fl_Callback*)cb_PatDataDirBrowser);
        o->deactivate();
      }
      o->end();
    }
    { Fl_Group* o = PatientPathInputGroup = new Fl_Group(0, 397, 675, 88);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = pattxtgrpPath = new Fl_Group(5, 402, 180, 25, "Path of the Database");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Input* o = patInputScanPath = new Fl_Input(110, 427, 490, 25, "Scan Database");
        o->callback((Fl_Callback*)cb_patInputScanPath);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Input* o = patInputDataPath = new Fl_Input(110, 452, 490, 25, "Data Database");
        o->callback((Fl_Callback*)cb_patInputDataPath);
        o->when(FL_WHEN_CHANGED);
      }
      { Fl_Button* o = DatabaseScnDirBrowser = new Fl_Button(605, 427, 60, 25, "Browse");
        o->callback((Fl_Callback*)cb_DatabaseScnDirBrowser);
      }
      { Fl_Button* o = DatabaseDataDirBrowser = new Fl_Button(605, 452, 60, 25, "Browse");
        o->callback((Fl_Callback*)cb_DatabaseDataDirBrowser);
      }
      o->end();
    }
    { Fl_Group* o = PatientButtonGroup = new Fl_Group(0, 487, 675, 45);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Button* o = PatientCancel = new Fl_Button(470, 497, 85, 25, "Cancel");
        o->callback((Fl_Callback*)cb_PatientCancel);
      }
      { Fl_Return_Button* o = PatientOk = new Fl_Return_Button(580, 497, 85, 25, "OK");
        o->callback((Fl_Callback*)cb_PatientOk);
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = TrajectoryWindow = new Fl_Double_Window(390, 286, "Trajectory");
    w = o;
    o->user_data((void*)(this));
    { Fl_Group* o = TextTPart = new Fl_Group(5, 5, 380, 225);
      o->box(FL_ENGRAVED_FRAME);
      TrajectoryName = new Fl_Input(65, 15, 300, 25, "Name:");
      { Fl_Choice* o = TrajNameChoice = new Fl_Choice(65, 15, 300, 25, "Name:");
        o->down_box(FL_BORDER_BOX);
        o->callback((Fl_Callback*)cb_TrajNameChoice);
        o->hide();
      }
      { Fl_Choice* o = LEDNameChoice = new Fl_Choice(65, 15, 300, 25, "Name:");
        o->down_box(FL_BORDER_BOX);
        o->callback((Fl_Callback*)cb_LEDNameChoice);
        o->hide();
      }
      { Fl_Choice* o = TrajCamSysChoice = new Fl_Choice(129, 52, 61, 25, "Camera System:");
        o->down_box(FL_BORDER_BOX);
        o->menu(menu_TrajCamSysChoice);
      }
//add 060630
/*	  { Fl_Choice* o = LEDRefChoice = new Fl_Choice(285, 52, 80, 25, "Ref LED");
        o->down_box(FL_BORDER_BOX);
        o->menu(menu_LEDRefChoice);
        o->callback((Fl_Callback*)cb_LEDRefChoice);
      }*/
//add 060630
	  //labeling the insert tranjectory by coordinate label
      { Fl_Choice* o = TrajObjChoice = new Fl_Choice(105, 80, 85, 25, "Motion of");
        o->down_box(FL_BORDER_BOX);
        o->menu(menu_TrajObjChoice);
      }
      { Fl_Choice* o = TrajRefChoice = new Fl_Choice(280, 80, 85, 25, "Reference:");
        o->down_box(FL_BORDER_BOX);
        o->menu(menu_TrajRefChoice);
        o->callback((Fl_Callback*)cb_RefCoordChoice);
      }
      { Fl_Group* o = coordgrp = new Fl_Group(19, 112, 180, 25, "Coordinates of the Point:");
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Value_Input* o = XCoord = new Fl_Value_Input(38, 137, 72, 25, "X:");
        o->minimum(-100);
        o->maximum(100);
        o->step(0.001);
      }
      { Fl_Value_Input* o = YCoord = new Fl_Value_Input(164, 137, 70, 25, "Y:");
        o->minimum(-100);
        o->maximum(100);
        o->step(0.001);
      }
      { Fl_Value_Input* o = ZCoord = new Fl_Value_Input(295, 137, 70, 25, "Z:");
        o->minimum(-100);
        o->maximum(100);
        o->step(0.001);
      }
      { Fl_Value_Input* o = FirstStep = new Fl_Value_Input(164, 195, 70, 25, "Trajectory:   from Step");
        o->minimum(1);
        o->maximum(2);
        o->step(1);
        o->value(1);
      }
      { Fl_Value_Input* o = LastStep = new Fl_Value_Input(295, 195, 70, 25, "to Step");
        o->minimum(1);
        o->maximum(2);
        o->step(1);
        o->value(1);
      }
      TotalSteps = new Fl_Value_Output(164, 170, 70, 25);
      { Fl_Box* o = NoSBox = new Fl_Box(19, 170, 125, 25, "Number of Steps:");
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }
      o->end();
    }
    { Fl_Group* o = ButtonTPart = new Fl_Group(5, 237, 380, 43);
      o->box(FL_ENGRAVED_FRAME);
//      { Fl_Button* o = Tbtn_cancel = new Fl_Button(165, 245, 80, 25, "Cancel");
      { Fl_Button* o = Tbtn_cancel = new Fl_Button(165, 245, 70, 25, "Close");
        o->callback((Fl_Callback*)cb_Tbtn_cancel);
      }
      { Fl_Return_Button* o = Tbtn_ok = new Fl_Return_Button(285, 245, 80, 25, "Ok");
        o->callback((Fl_Callback*)cb_Tbtn_ok);
      }
      { Fl_Button* o = Tbtn_del = new Fl_Button(19, 245, 80, 25, "Delete");
        o->callback((Fl_Callback*)cb_Tbtn_del);
        o->hide();
      }
      { Fl_Return_Button* o = Tbtn_ok2 = new Fl_Return_Button(285, 245, 80, 25, "OK");
        o->callback((Fl_Callback*)cb_Tbtn_ok2);
        o->hide();
      }
      { Fl_Button* o = Tbtn_cancel2 = new Fl_Button(165, 245, 80, 25, "Cancel");
        o->callback((Fl_Callback*)cb_Tbtn_cancel2);
        o->hide();
      }
//      { Fl_Return_Button* o = Tbtn_ok3 = new Fl_Return_Button(285, 245, 80, 25, "Ok");
      { Fl_Return_Button* o = Tbtn_ok3 = new Fl_Return_Button(245, 245, 120, 25, "Add trajectory");
        o->callback((Fl_Callback*)cb_Tbtn_ok3);
        o->hide();
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = AboutWindow = new Fl_Double_Window(435, 352, "About OPTIS");
    w = o;
    o->user_data((void*)(this));
    { Fl_Box* o = AboutTitle = new Fl_Box(0, 0, 435, 50, "OPTIS");
      o->box(FL_ENGRAVED_FRAME);
      o->labelfont(1);
      o->labelsize(24);
    }
    { Fl_Group* o = AboutTxtGroup = new Fl_Group(0, 52, 435, 248);
      o->box(FL_ENGRAVED_FRAME);
      AboutCopyright = new Fl_Box(0, 72, 435, 25, "Copyright     University of Zurich");
      AboutCBox = new Fl_Box(174, 72, 25, 25, "(c)");
      AboutKlinik = new Fl_Box(0, 122, 435, 25, "Clinic for Masticatory Disorders and Complete Dentures");
      AboutStreet = new Fl_Box(0, 147, 435, 25, "Plattenstrasse 11");
      AboutPLZ = new Fl_Box(0, 172, 435, 25, "CH-8028 Zurich, Switzerland");
      AboutWWW = new Fl_Box(0, 227, 435, 25, "www.dent.unizh.ch/kfs");
      AboutSupport = new Fl_Box(0, 252, 430, 25, "Support: kfs.support    zzmk.unizh.ch");
      AboutAtBox = new Fl_Box(224, 252, 25, 25, "@");
      o->end();
    }
    { Fl_Group* o = AboutBtnGroup = new Fl_Group(0, 303, 435, 47);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Return_Button* o = AboutOKBtn = new Fl_Return_Button(175, 314, 95, 25, "OK");
        o->callback((Fl_Callback*)cb_AboutOKBtn);
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = MatrixWindow = new Fl_Double_Window(425, 232, "Camera System Dependencies");
    w = o;
    o->user_data((void*)(this));
    { Fl_Group* o = MatrixMainGroup = new Fl_Group(0, 0, 425, 195);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = MatrixTitle = new Fl_Group(5, 4, 354, 25, "Indicate the spatial position of the camera system");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Group* o = MatrixTitle2 = new Fl_Group(5, 25, 312, 25, "relative to the main system");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
        o->end();
      }
      { Fl_Choice* o = MatrixChoice = new Fl_Choice(365, 5, 50, 25);
        o->down_box(FL_BORDER_BOX);
        o->menu(menu_MatrixChoice);
      }
      { Fl_Check_Button* o = MatOverlap = new Fl_Check_Button(5, 165, 25, 25, "FOV of this system overlaps the main FOV");
        o->down_box(FL_DOWN_BOX);
      }
      { Fl_Group* o = MatRotGroup = new Fl_Group(5, 60, 410, 60, "Rotation [deg]");
        o->align(FL_ALIGN_TOP_LEFT|FL_ALIGN_INSIDE);
        { Fl_Value_Input* o = MatRotX = new Fl_Value_Input(60, 80, 80, 25, "Pitch");
          o->minimum(-9999);
          o->maximum(9999);
          o->step(0.001);
        }
        { Fl_Value_Input* o = MatRotY = new Fl_Value_Input(195, 80, 80, 25, "Yaw");
          o->minimum(-9999);
          o->maximum(9999);
          o->step(0.001);
        }
        { Fl_Value_Input* o = MatRotZ = new Fl_Value_Input(330, 80, 80, 25, "Roll");
          o->minimum(-9999);
          o->maximum(9999);
          o->step(0.001);
        }
        o->end();
      }
      { Fl_Group* o = MatTransGroup = new Fl_Group(5, 115, 410, 55, "Translation [mm]");
        o->align(FL_ALIGN_TOP_LEFT|FL_ALIGN_INSIDE);
        { Fl_Value_Input* o = MatTransX = new Fl_Value_Input(60, 135, 80, 25, "X");
          o->minimum(-9999);
          o->maximum(9999);
          o->step(0.001);
        }
        { Fl_Value_Input* o = MatTransY = new Fl_Value_Input(195, 135, 80, 25, "Y");
          o->minimum(-9999);
          o->maximum(9999);
          o->step(0.001);
        }
        { Fl_Value_Input* o = MatTransZ = new Fl_Value_Input(330, 135, 80, 25, "Z");
          o->minimum(-9999);
          o->maximum(9999);
          o->step(0.001);
        }
        o->end();
      }
      o->end();
    }
    { Fl_Group* o = MatrixBtnGroup = new Fl_Group(0, 197, 425, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Button* o = Matrix_Cancel = new Fl_Button(235, 202, 85, 25, "Cancel");
        o->callback((Fl_Callback*)cb_Matrix_Cancel);
      }
      { Fl_Return_Button* o = Matrix_Ok = new Fl_Return_Button(335, 202, 85, 25, "Ok");
        o->callback((Fl_Callback*)cb_Matrix_Ok);
      }
      { Fl_Button* o = Matrix_Default = new Fl_Button(5, 202, 115, 25, "Save as Default");
        o->callback((Fl_Callback*)cb_Matrix_Default);
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = LEDControlWindow = new Fl_Double_Window(500, 367, "LED Control");
    w = o;
    o->user_data((void*)(this));
    { Fl_Browser* o = LEDControlBrowser = new Fl_Browser(0, 0, 500, 325);
      o->type(2);
      o->textfont(4);
      Fl_Group::current()->resizable(o);
    }
    { Fl_Group* o = LEDCtrlBtnGroup = new Fl_Group(0, 330, 500, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = LEDCtrlMiddleGrp = new Fl_Group(340, 335, 50, 25);
        o->end();
        Fl_Group::current()->resizable(o);
      }
      { Fl_Group* o = LEDCtrlBtnLeftGrp = new Fl_Group(0, 335, 345, 25);
        LEDCtrlUpdate = new Fl_Box(5, 335, 60, 25, "Update:");
        { Fl_Round_Button* o = LEDCtrlConinuous = new Fl_Round_Button(75, 335, 100, 25, "Continuous");
          o->type(102);
          o->down_box(FL_ROUND_DOWN_BOX);
          o->value(1);
          o->callback((Fl_Callback*)cb_LEDCtrlConinuous);
        }
        { Fl_Round_Button* o = LEDCtrlManual = new Fl_Round_Button(190, 335, 75, 25, "Manual");
          o->type(102);
          o->down_box(FL_ROUND_DOWN_BOX);
          o->callback((Fl_Callback*)cb_LEDCtrlManual);
        }
        { Fl_Button* o = LEDCtrlNext = new Fl_Button(265, 335, 60, 25, "Next");
          o->callback((Fl_Callback*)cb_LEDCtrlNext);
          o->deactivate();
        }
        { Fl_Group* o = LEDCtrlNextResGrp = new Fl_Group(325, 335, 20, 25);
          o->end();
          Fl_Group::current()->resizable(o);
        }
        o->end();
      }
      { Fl_Group* o = LEDCtrlBtnRightGrp = new Fl_Group(390, 335, 110, 25);
        { Fl_Button* o = LEDSave = new Fl_Button(400, 335, 85, 25, "Save");
          o->callback((Fl_Callback*)cb_LEDSave);
        }
        o->end();
      }
      o->end();
    }
    o->end();
  }
//
  { Fl_Double_Window* o = LEDControl2Window = new Fl_Double_Window(600, 367, " Reference LED Control");
    w = o;
    o->user_data((void*)(this));
    { Fl_Browser* o = LEDControl2Browser = new Fl_Browser(0, 0, 350, 325);
      o->type(2);
      o->textfont(4);
      Fl_Group::current()->resizable(o);
    }
    { Fl_Group* o = LEDCtrl2BtnGroup = new Fl_Group(0, 330, 600, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Group* o = LEDCtrl2MiddleGrp = new Fl_Group(340, 335, 50, 25);
        o->end();
        Fl_Group::current()->resizable(o);
      }
      { Fl_Group* o = LEDCtrl2BtnLeftGrp = new Fl_Group(0, 335, 345, 25);
        LEDCtrl2Update = new Fl_Box(5, 335, 60, 25, "Update:");
        { Fl_Round_Button* o = LEDCtrl2Coninuous = new Fl_Round_Button(75, 335, 100, 25, "Continuous");
          o->type(102);
          o->down_box(FL_ROUND_DOWN_BOX);
          o->value(1);
          o->callback((Fl_Callback*)cb_LEDCtrl2Coninuous);
        }
        { Fl_Round_Button* o = LEDCtrl2Manual = new Fl_Round_Button(190, 335, 75, 25, "Manual");
          o->type(102);
          o->down_box(FL_ROUND_DOWN_BOX);
          o->callback((Fl_Callback*)cb_LEDCtrl2Manual);
        }
        { Fl_Button* o = LEDCtrl2Next = new Fl_Button(265, 335, 60, 25, "Next");
          o->callback((Fl_Callback*)cb_LEDCtrl2Next);
          o->deactivate();
        }
        { Fl_Group* o = LEDCtrl2NextResGrp = new Fl_Group(325, 335, 20, 25);
          o->end();
          Fl_Group::current()->resizable(o);
        }
        o->end();
      }
      { Fl_Group* o = LEDCtrl2BtnRightGrp = new Fl_Group(390, 335, 110, 25);
        { Fl_Button* o = LEDSave2 = new Fl_Button(400, 335, 85, 25, "Save");
          o->callback((Fl_Callback*)cb_LEDSave2);
        }
        o->end();
      }
      o->end();
    }
	{ Fl_Group* o = LEDCtrl2RightGroup = new Fl_Group(350, 0, 250, 325);
      o->box(FL_ENGRAVED_FRAME);
	  { Fl_Choice* o = LED1Choice = new Fl_Choice(360, 10, 75, 25);
        o->down_box(FL_BORDER_BOX);
        o->menu(menu_LED1Choice);
      }
	  { Fl_Choice* o = LED2Choice = new Fl_Choice(510, 10, 75, 25, "relative to");
        o->down_box(FL_BORDER_BOX);
        o->menu(menu_LED2Choice);
      }
      { Fl_Group* o = LEDCtrl2RightNGrp = new Fl_Group(350, 300, 250, 25);
        o->end();
        Fl_Group::current()->resizable(o);
      }
      o->end();
    }
    o->end();
  }
  
  /*{ Fl_Double_Window* o = MvmNameWindow = new Fl_Double_Window(479, 115, "Name of the next movement");
    w = o;
    o->callback((Fl_Callback*)cb_MvmNameWindow, (void*)(this));
    { Fl_Group* o = MvmNameWinGroup = new Fl_Group(5, 5, 470, 105);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Box* o = MvmNameWinText = new Fl_Box(15, 10, 450, 25, "Please enter the name of the next movement:");
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }
      MvmNameWinInput = new Fl_Input(17, 40, 450, 25);
      { Fl_Return_Button* o = MvmNameWinOkBtn = new Fl_Return_Button(380, 75, 85, 25, "OK");
        o->callback((Fl_Callback*)cb_MvmNameWinOkBtn);
      }
      o->end();
    }
    o->end();
  }*/
  { Fl_Double_Window* o = MvmNameWindow = new Fl_Double_Window(479, 145, "Name of the next movement");
    w = o;
    o->callback((Fl_Callback*)cb_MvmNameWindow, (void*)(this));
    { Fl_Group* o = MvmNameWinGroup = new Fl_Group(5, 5, 470, 135);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Box* o = MvmNameWinText = new Fl_Box(15, 10, 450, 25, "Please select the name of the next movement:");
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }	  
	  
      { Fl_Choice* o = MvmNameList = new Fl_Choice(15, 40, 450, 25);
        o->down_box(FL_BORDER_BOX);
        o->callback((Fl_Callback*)cb_MvmNameListChoice);
      }	  
      MvmNameWinInput = new Fl_Input(77, 70, 390, 25, "Comment");
      { Fl_Return_Button* o = MvmNameWinOkBtn = new Fl_Return_Button(380, 105, 85, 25, "OK");
        o->callback((Fl_Callback*)cb_MvmNameWinOkBtn);
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = LEDCharWindow = new Fl_Double_Window(629, 644, "LED Characteristics");
    w = o;
    o->user_data((void*)(this));
    { Fl_Group* o = LedCharWinSpeed = new Fl_Group(5, 5, 620, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Choice* o = LEDCharCamSysChoice = new Fl_Choice(123, 10, 72, 25, "Camera System");
        o->down_box(FL_BORDER_BOX);
        o->labelfont(1);
        o->menu(menu_LEDCharCamSysChoice);
      }
      { Fl_Choice* o = LedCharSpeedFrequency = new Fl_Choice(435, 10, 180, 25, "Frequency");
        o->down_box(FL_BORDER_BOX);
        o->labelfont(1);
        o->menu(menu_LedCharSpeedFrequency);
      }
      o->end();
    }
    { Fl_Group* o = LedCharWinLEDObj = new Fl_Group(5, 45, 620, 265);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Box* o = LEDTxtLED = new Fl_Box(100, 75, 40, 25, "LED");
        o->labelfont(1);
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = LEDTxtObject = new Fl_Box(20, 100, 55, 25, "Object");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }
      LEDTxtObject1 = new Fl_Box(20, 125, 55, 25, "1");
      LEDTxtObject2 = new Fl_Box(20, 150, 55, 25, "2");
      LEDTxtObject3 = new Fl_Box(20, 175, 55, 25, "3");
      LEDTxtObject4 = new Fl_Box(20, 200, 55, 25, "4");
      LEDTxtObject5 = new Fl_Box(20, 225, 55, 25, "5");
      LEDTxtObject6 = new Fl_Box(20, 250, 55, 25, "6");
      LEDTxtObjectOff = new Fl_Box(20, 275, 55, 25, "Off");
      { Fl_Box* o = LEDline1h = new Fl_Box(20, 199, 590, 1);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = LEDline2h = new Fl_Box(20, 274, 590, 1);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = LEDline3h = new Fl_Box(20, 124, 590, 1);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = LEDline0 = new Fl_Box(75, 95, 1, 210);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = LEDline1 = new Fl_Box(165, 95, 1, 210);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = LEDline2 = new Fl_Box(255, 95, 1, 210);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = LEDline3 = new Fl_Box(345, 95, 1, 210);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = LEDline4 = new Fl_Box(435, 95, 1, 210);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = LEDline5 = new Fl_Box(525, 95, 1, 210);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = LEDTxtTxt = new Fl_Box(10, 50, 255, 25, "Which LED belongs to which object?");
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }
      o->end();
    }
    { Fl_Group* o = LedCharWinObjObj = new Fl_Group(5, 315, 620, 285);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Box* o = ObjTxtRef = new Fl_Box(20, 370, 85, 25, "Reference");
        o->labelfont(1);
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObject = new Fl_Box(135, 345, 55, 25, "Object");
        o->labelfont(1);
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObject0 = new Fl_Box(20, 395, 85, 25, "is Reference");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObject1 = new Fl_Box(20, 420, 85, 25, "Object 1");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObject2 = new Fl_Box(20, 445, 85, 25, "Object 2");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObject3 = new Fl_Box(20, 470, 85, 25, "Object 3");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObject4 = new Fl_Box(20, 495, 85, 25, "Object 4");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObject5 = new Fl_Box(20, 520, 85, 25, "Object 5");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObject6 = new Fl_Box(20, 545, 85, 25, "Object 6");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObjectOff = new Fl_Box(20, 570, 85, 25, "Off");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = Objline1h = new Fl_Box(20, 494, 590, 1);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = Objline2h = new Fl_Box(20, 569, 590, 1);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = Objline1 = new Fl_Box(125, 365, 1, 230);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = Objline2 = new Fl_Box(205, 365, 1, 230);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = Objline3 = new Fl_Box(285, 365, 1, 230);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = Objline4 = new Fl_Box(365, 365, 1, 230);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = Objline5 = new Fl_Box(445, 365, 1, 230);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = Objline3h = new Fl_Box(20, 419, 590, 1);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = Objline4h = new Fl_Box(20, 394, 590, 1);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = Objline6 = new Fl_Box(525, 365, 1, 230);
        o->box(FL_BORDER_BOX);
      }
      { Fl_Box* o = ObjTxtTxt = new Fl_Box(10, 320, 420, 25, "Which object moves relatively to which other object (reference)?");
        o->align(FL_ALIGN_LEFT|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObj1 = new Fl_Box(125, 370, 80, 25, "1");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObj2 = new Fl_Box(205, 370, 80, 25, "2");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObj3 = new Fl_Box(285, 370, 80, 25, "3");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObj4 = new Fl_Box(365, 370, 80, 25, "4");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObj5 = new Fl_Box(445, 370, 80, 25, "5");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      { Fl_Box* o = ObjTxtObj6 = new Fl_Box(525, 370, 80, 25, "6");
        o->align(FL_ALIGN_CENTER|FL_ALIGN_INSIDE);
      }
      o->end();
    }
    { Fl_Group* o = LedCharWinBtnGrp = new Fl_Group(5, 605, 620, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Button* o = LEDChar_Cancel = new Fl_Button(365, 610, 80, 25, "Cancel");
        o->callback((Fl_Callback*)cb_LEDChar_Cancel);
      }
      { Fl_Return_Button* o = LEDChar_Ok = new Fl_Return_Button(530, 610, 80, 25, "Ok");
        o->callback((Fl_Callback*)cb_LEDChar_Ok);
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = camTestWin = new Fl_Double_Window(295, 175, "Camera Test");
    w = o;
    o->user_data((void*)(this));
    { Fl_Group* o = camTestGrp = new Fl_Group(5, 5, 285, 125);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Value_Input* o = ctInitX = new Fl_Value_Input(130, 15, 55, 25, "Initial Point:   X");
        o->maximum(12000);
        o->step(1);
        o->value(4900);
      }
      { Fl_Value_Input* o = ctInitY = new Fl_Value_Input(210, 15, 55, 25, "Y");
        o->maximum(12000);
        o->step(1);
        o->value(10000);
      }
      { Fl_Value_Input* o = ctFinalX = new Fl_Value_Input(130, 40, 55, 25, "Final Point:   X");
        o->maximum(12000);
        o->step(1);
        o->value(4900);
      }
      { Fl_Value_Input* o = ctFinalY = new Fl_Value_Input(210, 40, 55, 25, "Y");
        o->maximum(12000);
        o->step(1);
        o->value(6000);
      }
      { Fl_Value_Input* o = ctSteps = new Fl_Value_Input(130, 70, 55, 25, "Number of Steps");
        o->maximum(12000);
        o->step(1);
        o->value(4001);
      }
      { Fl_Value_Input* o = ctDelay = new Fl_Value_Input(130, 95, 55, 25, "Delay [ms]");
        o->maximum(12000);
        o->step(1);
        o->value(1000);
      }
      o->end();
    }
    { Fl_Group* o = ctWinBtnGrp = new Fl_Group(5, 135, 285, 35);
      o->box(FL_ENGRAVED_FRAME);
      { Fl_Button* o = ct_Cancel = new Fl_Button(15, 140, 85, 25, "Cancel");
        o->callback((Fl_Callback*)cb_ct_Cancel);
      }
      { Fl_Return_Button* o = ct_Ok = new Fl_Return_Button(195, 140, 85, 25, "Ok");
        o->callback((Fl_Callback*)cb_ct_Ok);
      }
      o->end();
    }
    o->end();
  }
  { Fl_Double_Window* o = ConnectInfoWin = new Fl_Double_Window(234, 100);
    w = o;
    o->user_data((void*)(this));
    { Fl_Group* o = ConInfoWinTxt1 = new Fl_Group(5, 25, 225, 20, "Starting OPTIS Controller.");
      o->align(FL_ALIGN_TOP|FL_ALIGN_INSIDE);
      o->end();
    }
    { Fl_Group* o = ConInfoWinTxt2 = new Fl_Group(5, 50, 225, 20, "Please wait...");
      o->align(FL_ALIGN_TOP|FL_ALIGN_INSIDE);
      o->end();
    }
    o->end();
  }
}

void OPTISGui::show() {
  int i;

LEDViewer->size_range(576, 589, 0, 0, 0, 0, 0);
if (pref != NULL)
{
   LEDViewer->size(pref->LEDViewerWidth+64, pref->LEDViewerHeight+109);
   if (pref->LEDViewerX >= 0)
      LEDViewer->position(pref->LEDViewerX, pref->LEDViewerY);
   else
      LEDViewer->position((Fl::w()-LEDViewer->w())/2, (Fl::h()-LEDViewer->h())/2); 
   objview->backgroundcolor[0] = pref->LEDViewerColor[0];
   objview->backgroundcolor[1] = pref->LEDViewerColor[1];
   objview->backgroundcolor[2] = pref->LEDViewerColor[2];
   objview->scenemanager->setBackgroundColor(
      SbColor(objview->backgroundcolor[0],
      objview->backgroundcolor[1], objview->backgroundcolor[2]));
//   numLEDs = 6;//initialized LED number
   numLEDs = 1;//20060615
   numCams = pref->numCameras;
}
else
{
   LEDViewer->size(576, 621);
}
AnimStart->deactivate();
AnimStop->deactivate();
AnimOneFwd->deactivate();
AnimOneBwd->deactivate();
AnimPlayBwd->deactivate();
AnimReset->deactivate();
AnimStoreAnim->deactivate();
MotionNameOutput->value(&nomotiontxt[0]);

if (filmxbm != NULL)
   delete filmxbm;
filmxbm = new unsigned char[32];
for (i=0; i<32; i++)
   filmxbm[i] = 255;
for (i=0; i<16; i++)
{
   if (!((i%3)==0))
   {
      filmxbm[2*i] = 249;
      filmxbm[2*i+1] = 159;
   }
   if (!((i%7)==0))
   {
      filmxbm[2*i] = filmxbm[2*i] & 0x1f;
      filmxbm[2*i+1] = filmxbm[2*i+1] & 0xf8;
   }
}
if (film_bitmap != NULL)
   delete film_bitmap;
film_bitmap = new Fl_Bitmap(filmxbm, 16, 16);
film_bitmap->label(FilmButton); 

if (photoxbm != NULL)
   delete photoxbm;
photoxbm = new unsigned char[32];
photoxbm[0] = 0; photoxbm[1] = 0;
photoxbm[2] = 224; photoxbm[3] = 7;
photoxbm[4] = 230; photoxbm[5] = 103;
photoxbm[6] = 255; photoxbm[7] = 255;
photoxbm[8] = 127; photoxbm[9] = 254;
photoxbm[10] = 31; photoxbm[11] = 248;
photoxbm[12] = 143; photoxbm[13] = 241;
photoxbm[14] = 207; photoxbm[15] = 243;
photoxbm[16] = 231; photoxbm[17] = 231;
photoxbm[18] = 231; photoxbm[19] = 231;
photoxbm[20] = 207; photoxbm[21] = 243;
photoxbm[22] = 143; photoxbm[23] = 241;
photoxbm[24] = 31; photoxbm[25] = 248;
photoxbm[26] = 127; photoxbm[27] = 254;
photoxbm[28] = 255; photoxbm[29] = 255;
photoxbm[30] = 0; photoxbm[31] = 0;
if (photo_bitmap != NULL)
   delete photo_bitmap;
photo_bitmap = new Fl_Bitmap(photoxbm, 16, 16);
photo_bitmap->label(PhotoButton); 

if (stopxbm != NULL)
   delete stopxbm;
stopxbm = new unsigned char[32];
stopxbm[0] = 0; stopxbm[1] = 0;
stopxbm[2] = 0; stopxbm[3] = 0;
for (i=2; i<14; i++)
{
   stopxbm[2*i] = 252;
   stopxbm[2*i+1] = 63;
}
stopxbm[28] = 0; stopxbm[29] = 0;
stopxbm[30] = 0; stopxbm[31] = 0;
if (stop_bitmap != NULL)
    delete stop_bitmap;
stop_bitmap = new Fl_Bitmap(stopxbm, 16, 16);
stop_bitmap->label(StopMotionBtn); 

if (resetxbm != NULL)
   delete resetxbm;
resetxbm = new unsigned char[32];
resetxbm[0] = 0; resetxbm[1] = 0;
resetxbm[2] = 15; resetxbm[3] = 130;
resetxbm[4] = 15; resetxbm[5] = 195;
resetxbm[6] = 143; resetxbm[7] = 227;
resetxbm[8] = 207; resetxbm[9] = 243;
resetxbm[10] = 239; resetxbm[11] = 251;
resetxbm[12] = 255; resetxbm[13] = 255;
resetxbm[14] = 255; resetxbm[15] = 255;
resetxbm[16] = 255; resetxbm[17] = 255;
resetxbm[18] = 239; resetxbm[19] = 251;
resetxbm[20] = 207; resetxbm[21] = 243;
resetxbm[22] = 143; resetxbm[23] = 227;
resetxbm[24] = 15; resetxbm[25] = 195;
resetxbm[26] = 15; resetxbm[27] = 130;
resetxbm[28] = 0; resetxbm[29] = 0;
resetxbm[30] = 0; resetxbm[31] = 0;
if (reset_bitmap != NULL)
    delete reset_bitmap;
reset_bitmap = new Fl_Bitmap(resetxbm, 16, 16);
reset_bitmap->label(ResetMotionBtn); 

LEDViewer->show();
objview->show();

insertFOV();

oldW = LEDViewer->w();
oldH = LEDViewer->h();

for (i=0; i<10; i++)
{
   mCamSysTrafo[i].makeIdentity();
   guiFixedXYZ(mCamSysTrafo[i],
      pref->camSysRot[i][0]/180.0*3.14159,
      pref->camSysRot[i][1]/180.0*3.14159,
      pref->camSysRot[i][2]/180.0*3.14159);
   mCamSysTrafo[i][0][3] = pref->camSysTrans[i][0];
   mCamSysTrafo[i][1][3] = pref->camSysTrans[i][1];
   mCamSysTrafo[i][2][3] = pref->camSysTrans[i][2];
}

initLEDCharWindow();
setObjectEditorObjects2();
}

void OPTISGui::setObjectEditorValuesCB2() {
  int       i;
//  printf("ObjWindow->value()=%d\n",ObjWindow->value());

objdata = objview->objlist;
   for (i=0; i<ObjWindow->value(); i++)
      objdata = objdata->next;
      transparency_slider2->value(objdata->material->transparency[0]);
      objview->redraw();
}

void OPTISGui::setObjectEditorObjects2() {
  int  i = -1;
char st[256];

ObjWindow->clear();
objdata = objview->objlist;
while(objdata != NULL)
{
   objview->getLabel(objdata, &st[0]);
   ObjWindow->add(&st[0], 0, 0, 0, 0);
   objdata = objdata->next;
   i++;
}
if (i >= 0)
   ObjWindow->value(0);
setObjectEditorValuesCB2();
}

void OPTISGui::setObjectEditorValuesCB() {
  int       i;
SoMFColor mfcolor;
SbColor   color;

objdata = objview->objlist;
for (i=0; i<ObjectChoice->value(); i++)
   objdata = objdata->next;

mfcolor = objdata->material->ambientColor;
color = mfcolor[0];
ambient_red->value(color[0]);
ambient_green->value(color[1]);
ambient_blue->value(color[2]);

mfcolor = objdata->material->diffuseColor;
color = mfcolor[0];
diffuse_red->value(color[0]);
diffuse_green->value(color[1]);
diffuse_blue->value(color[2]);

mfcolor = objdata->material->specularColor;
color = mfcolor[0];
specular_red->value(color[0]);
specular_green->value(color[1]);
specular_blue->value(color[2]);

mfcolor = objdata->material->emissiveColor;
color = mfcolor[0];
emission_red->value(color[0]);
emission_green->value(color[1]);
emission_blue->value(color[2]);

shininess_slider->value(objdata->material->shininess[0]);
transparency_slider->value(objdata->material->transparency[0]);

PointSizeSlider->deactivate();
LineWidthSlider->deactivate();
LinePatternSlider->deactivate();
PointSizeSlider->value((int)objdata->drawstyle->pointSize.getValue());
LineWidthSlider->value((int)objdata->drawstyle->lineWidth.getValue());
LinePatternSlider->value((int)(100.0/65535.0*objdata->drawstyle->linePattern.getValue()));

if (objdata->drawstyle->style.getValue() == SoDrawStyle::FILLED)
   SolidRadio->setonly();
if (objdata->drawstyle->style.getValue() == SoDrawStyle::LINES)
{
   LineRadio->setonly();
   LineWidthSlider->activate();
   LinePatternSlider->activate();
}
if (objdata->drawstyle->style.getValue() == SoDrawStyle::POINTS)
{
   PointRadio->setonly();
   PointSizeSlider->activate();
}
if (objdata->drawstyle->style.getValue() == SoDrawStyle::INVISIBLE)
   HideRadio->setonly();
}

void OPTISGui::close() {
  reset();
LEDViewer->hide();
delete help_dialog;
tmpTransform->unref();
}

void OPTISGui::setObjectEditorObjects() {
  int  i = -1;
char st[256];

ObjectChoice->clear();
objdata = objview->objlist;
while(objdata != NULL)
{
   objview->getLabel(objdata, &st[0]);
   ObjectChoice->add(&st[0], 0, 0, 0, 0);
   objdata = objdata->next;
   i++;
}
if (i >= 0)
   ObjectChoice->value(0);
setObjectEditorValuesCB();
}

void OPTISGui::setPointer(Preferences *p, Scanfile *s) {
  pref = p;
scnfile = s;
if (s != NULL)
{
   sprintf(WindowTitle, "OPTIS: %s %s, %s", s->name, s->firstname, s->anatomy);
   LEDViewer->label(&WindowTitle[0]);
}
}

void OPTISGui::applyMotion(char up) {
  SbMatrix m, n;//4*4 matrix
SbVec3f t;
SbRotation r;//SbMatrix
SbString s;
ObjectData *tmpdata;
SbVec3d v, w, testvec, tmp1,tmp2[18];
int type, camnr, minIntens;
SdMatrix md;
float minVal;
int nr, ival;
double dFloor;
long step;
int oldRSnr;
SdMatrix m1,m2;
SdMatrix mo1,mo2;
int ledobj;

if (mainAnimation->num_steps == 0)//number of step =0
   return;

m1.identity();

step = floor(mainAnimation->animation_step);
dFloor = mainAnimation->animation_step - step;
if (dFloor > 0.99) // runden (round up value)
{
   step++;
   dFloor = 0.0;
}

testvec.setValue(-120.0, -120.0, -120.0);

if (csoc.connected == 0)
{
   StepNrOutput->value(mainAnimation->animation_step+1);
//   TimeOutput->value(0.005*mainAnimation->animation_step);
   TimeOutput->value(mainAnimation->freq*mainAnimation->animation_step);
}
StepSlider->value(mainAnimation->animation_step);

checkLEDs();

m = mainAnimation->getActualMatrix(RSFOV->value(), -1, 0);
t.setValue(m[0][3], m[1][3], m[2][3]);
m[0][3] = 0.0;
m[1][3] = 0.0;
m[2][3] = 0.0;
n = m.transpose();
r.setValue(n);
objview->animation->rotation.setValue(r);
objview->animation->translation.setValue(t);

if (LEDControlWindow->visible())
   setLEDControlValues();
if (LEDControl2Window->visible())
   setLEDControl2Values();

tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camnr = tmpdata->type/1000;
   tmpdata->transform->setToDefaults();
   if ((type > 99) && (type < 118))
   {
      minVal = mainAnimation->intensity[(camnr*18)+(type-100)][step][0];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][step][1] < minVal)
         minVal = mainAnimation->intensity[(camnr*18)+(type-100)][step][1];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][step][2] < minVal)
         minVal = mainAnimation->intensity[(camnr*18)+(type-100)][step][2];
      minIntens = int(minVal);
//1124      if (minIntens <= pref->LEDerror)
      if ((minIntens > pref->LEDerror) &&
          (minIntens <= pref->LEDwarningRedRed))
      {
         tmpdata->material->diffuseColor.setValue(1.0, 0.0, 0.0);
         tmpdata->material->emissiveColor.setValue(0.2, 0.0, 0.0);
      }
//1124      if ((minIntens > pref->LEDerror) &&
//          (minIntens <= pref->LEDwarningRed))
      if ((minIntens > pref->LEDwarningRedRed) &&
          (minIntens <= pref->LEDwarningRed))
      {
         tmpdata->material->diffuseColor.setValue(1.0, 1.0, 0.0);
         tmpdata->material->emissiveColor.setValue(0.0, 0.0, 0.0);
      }
      if ((minIntens > pref->LEDwarningRed) &&
          (minIntens <= pref->LEDwarningYellow))
      {
         tmpdata->material->diffuseColor.setValue(0.0, 0.4, 0.0);
         tmpdata->material->emissiveColor.setValue(0.0, 0.2, 0.0);
      }
//      if (minIntens > pref->LEDwarningYellow)
      if (up==0 && minIntens > pref->LEDwarningYellow)//test1201
      {
         tmpdata->material->ambientColor.setValue(1.0, 1.0, 1.0);
         tmpdata->material->diffuseColor.setValue(0.8, 0.8, 0.8);
         tmpdata->material->emissiveColor.setValue(0.0, 0.0, 0.0);
      }
/*      if (mainAnimation->led[(camnr*18)+(type-100)][step] == testvec)
         tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;*/  //original comment

      if (mainAnimation->Speed[camnr] == 1)
      {
//1123		  tmpdata->drawstyle->style = SoDrawStyle::FILLED;
//add
	if(tmpdata->drawstyle->style.getValue() == SoDrawStyle::FILLED)
    pref->LEDdrawstyle[type-100] = 0;
	if(tmpdata->drawstyle->style.getValue() == SoDrawStyle::LINES)
    pref->LEDdrawstyle[type-100] = 1;
	if(tmpdata->drawstyle->style.getValue() == SoDrawStyle::POINTS)
    pref->LEDdrawstyle[type-100] = 2;
	if(tmpdata->drawstyle->style.getValue() == SoDrawStyle::INVISIBLE)
    pref->LEDdrawstyle[type-100] = 3;
//add
      }
      if (mainAnimation->Speed[camnr] == 2)
      {
         if ((dFloor < 0.499))
         {
            if ((type-100) > 8)
               tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
            else
               tmpdata->drawstyle->style = SoDrawStyle::FILLED;
         }
         else
         {
            if ((type-100) < 9)
               tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
            else
               tmpdata->drawstyle->style = SoDrawStyle::FILLED;
         }
      }
      if (mainAnimation->Speed[camnr] == 3)
      {
         if ((dFloor < (1.0/3.0-0.001)))
         {
            if ((type-100) > 5)
               tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
            else
               tmpdata->drawstyle->style = SoDrawStyle::FILLED;
         }
         if ((dFloor >= (1.0/3.0-0.001)) && (dFloor < (2.0/3.0-0.001)))
         {
            if (((type-100) > 5) && ((type-100) < 12))
               tmpdata->drawstyle->style = SoDrawStyle::FILLED;
            else
               tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
         }
         if ((dFloor >= (2.0/3.0-0.001)))
         {
            if ((type-100) < 12)
               tmpdata->drawstyle->style = SoDrawStyle::INVISIBLE;
            else
               tmpdata->drawstyle->style = SoDrawStyle::FILLED;
         }
      }
         
      ival = tmpdata->drawstyle->style.getValue();
      if (tmpdata->errorStyle[0] != NULL)
      {
          for (nr=0; nr<3; nr++)
          {
             if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][nr] > pref->LEDwarningYellow)
                tmpdata->errorStyle[nr]->style = SoDrawStyle::INVISIBLE;
              else
             {
                if (ival == 0) 
                  tmpdata->errorStyle[nr]->style = SoDrawStyle::FILLED;
                else
                  tmpdata->errorStyle[nr]->style = SoDrawStyle::INVISIBLE;
            }
          }
      }
   }
   if ((type > 99) && (type < 118))
   {
      if (RSFOV->value() > 0)
      {
         tmpdata->transform->translation.setValue(
            mainAnimation->led[(camnr*18)+(type-100)][step][0],
            mainAnimation->led[(camnr*18)+(type-100)][step][1],
            mainAnimation->led[(camnr*18)+(type-100)][step][2]);
      }
	  else
      {
//      if (type < 103)
//         tmpdata->transform->translation.setValue(
//            mainAnimation->led[(camnr*18)+(type-100)][0][0],
//            mainAnimation->led[(camnr*18)+(type-100)][0][1],
//            mainAnimation->led[(camnr*18)+(type-100)][0][2]);
//      else
//      {
         if (((mainAnimation->Speed[camnr] == 2) && (type >= 109) && (type < 112)) ||
             ((mainAnimation->Speed[camnr] == 3) && (type >= 106) && (type < 109)) ||
             ((mainAnimation->Speed[camnr] == 3) && (type >= 112) && (type < 115)))
         {
            tmpdata->transform->translation.setValue(
               mainAnimation->led[(camnr*18)+((type-100)%3)][0][0],
               mainAnimation->led[(camnr*18)+((type-100)%3)][0][1],
               mainAnimation->led[(camnr*18)+((type-100)%3)][0][2]);
         }
         else
         {
            v = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step];
            mainAnimation->fov_trafo[camnr].multMatrixVec(v, w);
            tmpdata->transform->translation.setValue(w[0], w[1], w[2]);
         }
//      }
      }
   }
   if (type == 221) //actual data of extra point
   {
	   /*if((LEDRefChoice->value(5))){
		   tmpdata->material->diffuseColor.setValue(1.0, 0.0, 1.0); //060821 wein red color
           tmpdata->material->emissiveColor.setValue(0.0, 0.0, 0.0);//060821
	   }*/
      if (mainAnimation->RSnr != tmpdata->motionOfObject)
      {
         oldRSnr = mainAnimation->RSnr;
         if (tmpdata->reference == -1){//the point is defined in the FOV coordinate system

         if (RSFOV->value() > 0)
         {
            mainAnimation->setRSnr(tmpdata->reference);
            mainAnimation->calc_animationTrafo(mainAnimation->animation_step, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camnr].multMatrixVec(tmpdata->point, v);
            md = mainAnimation->fov_trafo[camnr].inverse();
            md.multMatrixVec(v, w);
         }
         else
         {
            mainAnimation->RSchanged = 1;
            mainAnimation->calc_animationTrafo(mainAnimation->animation_step, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camnr].multMatrixVec(tmpdata->point, v);
            w = v;
         }
		 mainAnimation->setRSnr(oldRSnr);
         mainAnimation->calc_animationTrafo(mainAnimation->animation_step);

		 }else if(tmpdata->reference > -1){//the point is defined in the object coordinate system
			 
			 mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
              m1 = mainAnimation->mRefRefSys[0].inverse();
              m1.multMatrixVec(tmpdata->point, tmp1);

         if (RSFOV->value() > 0)
         {
            mainAnimation->setRSnr(tmpdata->reference);
            mainAnimation->calc_animationTrafo(mainAnimation->animation_step, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camnr].multMatrixVec(tmp1, v);
            md = mainAnimation->fov_trafo[camnr].inverse();
            md.multMatrixVec(v, w);
         }
         else
         {
            mainAnimation->RSchanged = 1;
            mainAnimation->calc_animationTrafo(mainAnimation->animation_step, tmpdata->motionOfObject);
            mainAnimation->animation_trafo[camnr].multMatrixVec(tmp1, v);
            w = v;
         }
		 mainAnimation->setRSnr(oldRSnr);
         mainAnimation->calc_animationTrafo(mainAnimation->animation_step);

		 }
			 
      }
      else
         if (tmpdata->reference == -1){//the point is defined in the FOV coordinate system
         w = tmpdata->point;
		 }else if(tmpdata->reference > -1){//the point is defined in the object coordinate system
		 	  mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
              m1 = mainAnimation->mRefRefSys[0].inverse();
              m1.multMatrixVec(tmpdata->point, tmp1);
         w = tmp1;
		 }
      tmpdata->transform->translation.setValue(w[0], w[1], w[2]);
   }
   if ((camnr > 0) && (pref->camSysOverlap[camnr] > 0))
   {
      tmpTransform->setToDefaults();
      mCamSysTrafo[camnr].setSbMatrix(m);
      t.setValue(m[0][3], m[1][3], m[2][3]);
      m[0][3] = 0.0;
      m[1][3] = 0.0;
      m[2][3] = 0.0;
      n = m.transpose();
      r.setValue(n);
      tmpTransform->rotation.setValue(r);
      tmpTransform->translation.setValue(t);
      tmpdata->transform->combineRight(tmpTransform);
   }
//appearance of the axis of target frame
	if (type ==2 || type ==3 || type ==4 || type ==5 || type ==6 || type ==7)
   {
	  ledobj=type-2;
      mainAnimation->calc_animationTrafoObj(mainAnimation->animation_step, ledobj);
      if (mainAnimation->RSnr == -1)
	  {
	     mo1 = mainAnimation->mObj[0];
         mo1 = mainAnimation->mObj[0].inverse();
	  }else{
         mo2 = mainAnimation->mObj[0].inverse();
         mo1 = mainAnimation->fov_trafo[0];
	     mo1 *= mo2;
	  }
      tmpTransform->setToDefaults();
      mo1.setSbMatrix(m);
      t.setValue(m[0][3], m[1][3], m[2][3]);
      m[0][3] = 0.0;
      m[1][3] = 0.0;
      m[2][3] = 0.0;
      n = m.transpose();
      r.setValue(n);
      tmpTransform->rotation.setValue(r);
      tmpTransform->translation.setValue(t);
      tmpdata->transform->combineRight(tmpTransform);
   }

   if ((mainAnimation->RSnr >= 0)&&(type ==1))
   {
      tmpTransform->setToDefaults();
      if (pref->camSysOverlap[camnr] > 0) // abhaengig vom main system
         mainAnimation->fov_trafo[0].setSbMatrix(m);
      else
         mainAnimation->fov_trafo[camnr].setSbMatrix(m);
      t.setValue(m[0][3], m[1][3], m[2][3]);
      m[0][3] = 0.0;
      m[1][3] = 0.0;
      m[2][3] = 0.0;
      n = m.transpose();
      r.setValue(n);
      tmpTransform->rotation.setValue(r);
      tmpTransform->translation.setValue(t);
      tmpdata->transform->combineRight(tmpTransform);
   }
   if ((camnr > 0) && (pref->camSysOverlap[camnr] == 0))
   {
      tmpTransform->setToDefaults();
      mCamSysTrafo[camnr].setSbMatrix(m);
      t.setValue(m[0][3], m[1][3], m[2][3]);
      m[0][3] = 0.0;
      m[1][3] = 0.0;
      m[2][3] = 0.0;
      n = m.transpose();
      r.setValue(n);
      tmpTransform->rotation.setValue(r);
      tmpTransform->translation.setValue(t);
      tmpdata->transform->combineRight(tmpTransform);
   }
   tmpdata = tmpdata->next;
}

/*if (up != 0)
{
   if (mainAnimation->getClick(up))
   {
//      printf("\007");
//      fflush(stdout);
        objview->scenemanager->setBackgroundColor(SbColor(1.0,
        1.0, 0.0));
   }
   else
      objview->scenemanager->setBackgroundColor(SbColor(objview->backgroundcolor[0],
        objview->backgroundcolor[1], objview->backgroundcolor[2]));
}*/

objview->redraw();
}

void OPTISGui::reset() {
  clearMainAnimation();

EditLEDViewer->hide();
MotionWindow->hide();
//RefMotionWindow->hide();
WindowSizeWindow->hide();
PrefWindow->hide();
TrajectoryWindow->hide();
AboutWindow->hide();
help_dialog->hide();
LEDControlWindow->hide();
MvmNameWindow->hide();

if (secondAnimation != NULL)
{
   delete secondAnimation;
   secondAnimation = NULL;
}
objview->delAll();
}

void OPTISGui::clearMainAnimation() {
  PlayBackwardMotionBtn->value(0);
StartMotionBtn->value(0);

if (mainAnimation != NULL)
{
   delete mainAnimation;
   mainAnimation = NULL;
   objview->animation->setToDefaults();
}

LoadMotionBtn->value(0);
MotionNameOutput->value(&nomotiontxt[0]);
StepNrOutput->value(0);
StepNrOutput->minimum(0);
StepNrOutput->maximum(1);
NumberOfStepsOutput->value(0);
TimeOutput->value(0);
StepSlider->value(0);
StepSlider->minimum(0);
StepSlider->maximum(1);
ControllerTop->redraw();
AnimStart->deactivate();
AnimStop->deactivate();
AnimOneFwd->deactivate();
AnimOneBwd->deactivate();
AnimPlayBwd->deactivate();
AnimReset->deactivate();
AnimStoreAnim->deactivate();
ImpTraj->activate();//060822
//AppRefBtn->value(0);
//	objview->appRefflag = 0;
	objview->refflag = 0;
}

void OPTISGui::resetLEDs() {
  SoPath  *path;
SoSearchAction searchAction;
ObjectData *tmpdata;
SoSphere *sphere;
int type;

tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   if (((type > 99) && (type < 118)) ||
       (type == 221))
   {
      searchAction.setType(SoSphere::getClassTypeId());
      searchAction.setInterest(SoSearchAction::FIRST);
      searchAction.apply(tmpdata->separator);
      path = searchAction.getPath();
      if (path != NULL)
      {
         sphere = (SoSphere*)path->getTail();
         sphere->radius.setValue(ledRadius);
      }
   }
   tmpdata = tmpdata->next;
}
if (mainAnimation != NULL)
   applyMotion(1);
else
   objview->redraw();
}

void OPTISGui::initPatient() {
  patInputScanPath->value(pref->scanpath);
patInputDataPath->value(pref->datapath);
NewPatientBtn->setonly();
PatDirAutoBtn->setonly();
PatScnDirBrowser->deactivate();
PatDataDirBrowser->deactivate();
PatientWindow->show();
}

void OPTISGui::buildDirectoryNames() {
  unsigned int i;
char tst[256], namest[256], fnamest[256], datest[256], anatomyst[256];
char scanst[256], datast[256];

sprintf(namest, "%s", PatientName->value());
i = 0;
while ((i<strlen(namest)) && (i<256))
{
   if ((namest[i] == ' ') || (namest[i] == '.') || (namest[i] == '-') || (namest[i] == ','))
      namest[i] = '_';  
   i++;
}
sprintf(fnamest, "%s", PatientFirstName->value());
i = 0;
while ((i<strlen(fnamest)) && (i<256))
{
   if ((fnamest[i] == ' ') || (fnamest[i] == '.') || (fnamest[i] == '-') || (namest[i] == ','))
      fnamest[i] = '_';  
   i++;
}
sprintf(datest, "%s", PatientRecordingDate->value());
i = 0;
while ((i<strlen(datest)) && (i<256))
{
   if ((datest[i] == ' ') || (datest[i] == '.') || (datest[i] == '-') || (namest[i] == ','))
      datest[i] = '_';  
   i++;
}
sprintf(anatomyst, "%s", PatientAnatomy->value());
i = 0;
while ((i<strlen(anatomyst)) && (i<256))
{
   if ((anatomyst[i] == ' ') || (anatomyst[i] == '.') || (anatomyst[i] == '-') || (namest[i] == ','))
      anatomyst[i] = '_';  
   i++;
}
sprintf(scanst, "%s", PatientScanDirectory->value());
i = 0;
while ((i<strlen(scanst)) && (i<256))
{
   if ((scanst[i] == ' ') || (scanst[i] == '.') || (scanst[i] == '-') || (namest[i] == ','))
      scanst[i] = '_';  
   i++;
}
sprintf(datast, "%s", PatientDataDirectory->value());
i = 0;
while ((i<strlen(datast)) && (i<256))
{
   if ((datast[i] == ' ') || (datast[i] == '.') || (datast[i] == '-') || (namest[i] == ','))
      datast[i] = '_';  
   i++;
}
if (strlen(PatientScanDirectory->value()) > 0)
   sprintf(tst, "%s_%s/%s/%s/%s", namest, fnamest, datest, anatomyst,
      scanst);
else
   sprintf(tst, "%s_%s/%s/%s", namest, fnamest, datest, anatomyst);
PatientScanPath->value(&tst[0]);
if (strlen(PatientDataDirectory->value()) > 0)
   sprintf(tst, "%s_%s/%s/%s/%s", namest, fnamest, datest, anatomyst,
      datast);
else
   sprintf(tst, "%s_%s/%s/%s", namest, fnamest, datest, anatomyst);
PatientDataPath->value(&tst[0]);
}

void OPTISGui::insertValues() //insert patient information
{
PatientName->value(scnfile->name);
PatientFirstName->value(scnfile->firstname);
PatientRecordingDate->value(scnfile->date);
PatientRemarks->value(scnfile->remarks);
PatientAnatomy->value(scnfile->anatomy);
PatientScanPath->value(scnfile->shortScandir);
PatientDataPath->value(scnfile->scanmov.path);
patInputFileBase->value(scnfile->scanmov.base);
PatientScanFileName->value(scnfile->scanfilename);
PatientScanDirectory->value("");
PatientDataDirectory->value("");
}

void OPTISGui::makeDir(char *path, char *name) //making default path
{
  char     cmd[256];

sprintf(cmd, "%s/%s", path, name);
if (!fl_filename_isdir(&cmd[0]))
{
#ifndef WIN32
   sprintf(cmd, "/sbin/mkdir %s/%s", path, name);
#else
   sprintf(cmd, "mkdir %s/%s", path, name);
   unsigned int i = 0;
   while ((i<256) && (i<strlen(cmd)))
   {
      if (cmd[i] == '/')
         cmd[i] = '\\';
      i++;
   }
#endif
   system(cmd);
   printf("%s\n", cmd);
}
}

void OPTISGui::setTrajEditorChoice() {
  ObjectData *tmpdata;
int i, type;

if ((FirstStep->value() < 1) || (FirstStep->value() > mainAnimation->num_steps))
   FirstStep->value(1);
if ((LastStep->value() < FirstStep->value()) || (LastStep->value() > mainAnimation->num_steps))
   LastStep->value(mainAnimation->num_steps);

i = -1;
tmpdata = objview->objlist;
while ((tmpdata != NULL) && (i < oldTrajChoice))
{
   type = tmpdata->type%1000;
//   if ((type >= 200) && (type <= 220))
//   if ((type >= 200) && (type <= 222)) //060817
   if ((type >= 200) && (type <= 220) || (type == 222)) //060817
      i++;
   if (i < oldTrajChoice)
      tmpdata = tmpdata->next;
}
tmpdata->point.setValue(XCoord->value(), YCoord->value(), ZCoord->value());
tmpdata->startStep = FirstStep->value()-1;
tmpdata->stopStep = LastStep->value()-1;
tmpdata->camSys = TrajCamSysChoice->value();
tmpdata->type = (tmpdata->type%1000)+1000*tmpdata->camSys;

i = -1;
tmpdata = objview->objlist;
while ((tmpdata != NULL) && (i < TrajNameChoice->value()))
{
   type = tmpdata->type%1000;
//   if ((type >= 200) && (type <= 220))
   if ((type >= 200) && (type <= 220) || (type == 222)) //060817
      i++;
   if (i < TrajNameChoice->value())
      tmpdata = tmpdata->next;
}
//LEDRefChoice->value(5);//add 060630
//LEDRefChoice->activate();//add 060630
XCoord->value(tmpdata->point[0]);
YCoord->value(tmpdata->point[1]);
ZCoord->value(tmpdata->point[2]);
FirstStep->value(tmpdata->startStep+1);
LastStep->value(tmpdata->stopStep+1);
TrajCamSysChoice->value(tmpdata->camSys);
if (((tmpdata->type%1000)>199)&&((tmpdata->type%1000)<218))//if Trajectory
   {
      TrajObjChoice->deactivate();
      TrajRefChoice->deactivate();
   }
else
   {
      TrajObjChoice->activate();
      TrajRefChoice->activate();
   }
TrajObjChoice->value(tmpdata->motionOfObject+1);
TrajRefChoice->value(tmpdata->reference+1);

oldTrajChoice = TrajNameChoice->value();
TrajectoryWindow->redraw();
}

void OPTISGui::setLEDEditorChoice() {
  ObjectData *tmpdata;
int i, type, j;

if ((FirstStep->value() < 1) || (FirstStep->value() > mainAnimation->num_steps))
   FirstStep->value(1);
if ((LastStep->value() < FirstStep->value()) || (LastStep->value() > mainAnimation->num_steps))
   LastStep->value(mainAnimation->num_steps);

i = -1;
tmpdata = objview->objlist;
while ((tmpdata != NULL) && (i < LEDNameChoice->value()))
{
   type = tmpdata->type%1000;
   if ((type >= 100) && (type <= 117))
      i++;
   if (i < LEDNameChoice->value())
      tmpdata = tmpdata->next;
}
XCoord->value(tmpdata->point[0]);
YCoord->value(tmpdata->point[1]);
ZCoord->value(tmpdata->point[2]);
TrajCamSysChoice->value(tmpdata->camSys);
// Objekt- und Referenznummern suchen
//search object and reference number
j = 0;
TrajObjChoice->value(j+1);
for (i=0; i<6; i++)
   if (LEDGroupsBtn[tmpdata->type%100][i]->value() > 0)
   {
      TrajObjChoice->value(i+1);
      j = i;
   }
TrajRefChoice->value(0);
for (i=0; i<7; i++)
   if (ObjGroupsBtn[j][i]->value() > 0)
      TrajRefChoice->value(i);

TrajectoryWindow->redraw();
}
//070104
void OPTISGui::setRefCoordChoice() {
  ObjectData *tmpdata;
int refcoord;
SdMatrix mo1,mo2;
SbVec3d src, src2, dst;
   tmpdata = objview->objlist;
   refcoord = TrajRefChoice->value();
   printf("you choose  %d reference object (old %d) \r\n",(refcoord+1),oldrefcoord );
   if(oldrefcoord > 0){
      mainAnimation->calc_animationTrafoObj(mainAnimation->animation_step, (oldrefcoord-1));
      mo2 = mainAnimation->mObj[0].inverse();
      src2.setValue(XCoord->value(), YCoord->value(), ZCoord->value());
      mo2.multMatrixVec(src2, src);
    XCoord->value(src[0]);
    YCoord->value(src[1]);
    ZCoord->value(src[2]);
   }else{
      src.setValue(XCoord->value(), YCoord->value(), ZCoord->value());
   }

   if(refcoord >0){
      mainAnimation->calc_animationTrafoObj(mainAnimation->animation_step, (refcoord-1));
      mo1 = mainAnimation->mObj[0];
      mo1.multMatrixVec(src, dst);
    XCoord->value(dst[0]);
    YCoord->value(dst[1]);
    ZCoord->value(dst[2]);
   }
   oldrefcoord = refcoord;
}


char OPTISGui::connectSocket(char message ) {
  char c;

socketStopped = 0;

do
{
   c = csoc.InitSocket(&pref->socketHost[0], &pref->socketPort[0]);
   if (c < 0)
      socketStopped = 1;
   Fl::check();
} while ((c < 1)&&(socketStopped == 0));
if(socketStopped > 0)
   return 0;

do
{
   c = csoc.ConnectServer(message);
   if (c < 0)
      socketStopped = 1;
   Fl::check();
} while ((c < 1)&&(socketStopped == 0));
if(socketStopped > 0)
   return 0;

CameraOkBox->color(2);
CameraOkBox->redraw();
return 1;
}

void OPTISGui::disconnectSocket() {
  socketStopped = 1;
csoc.CloseSocket();
CameraOkBox->color(1);
CameraOkBox->redraw();
}

void OPTISGui::receiveSocketData() {
  int i, j, firstValues, buflen;
  int objValues;
SbVec3d xyz[18];//3*18
SbVec3f intens[18];//3*18
unsigned char s1, s2;
char c, message[260];
unsigned long camstep;
unsigned long firstcamstep;
char *buffer;

for (i=0; i<260; i++)//clear message
   message[i] = '\0';
message[0] = 'c';
message[1] = (unsigned char) numCams;
buflen = numCams*62; // buffer length
buffer = new char[buflen];

firstValues = 0;
objValues = 0;
while ((socketStopped == 0)&&(csoc.connected>0))
{
   do
   {
      c = csoc.SendMsg(&message[0], 260);
      if (c < 0)
         socketStopped = 1;
      Fl::check();
   } while ((c < 1)&&(socketStopped == 0)&&(csoc.connected>0));
   if(socketStopped > 0)
   {
      csoc.CloseSocket();
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }
   if (csoc.connected == 0)
   {
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }

   do
   {
      c = csoc.ReceiveMsg((char*)buffer, buflen);
      if (c < 0)
         socketStopped = 1;
      Fl::check();
   } while ((c < 1)&&(socketStopped == 0)&&(csoc.connected>0));
   if(socketStopped > 0)
   {
      csoc.CloseSocket();
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }
   if (csoc.connected == 0)
   {
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }

   LEDclock = clock();

   memcpy(&s1, &buffer[2], 1);
   camstep =  256*256*256*s1;
   memcpy(&s1, &buffer[3], 1);
   camstep += 256*256*s1;
   memcpy(&s1, &buffer[4], 1);
   camstep += 256*s1;
   memcpy(&s1, &buffer[5], 1);
   camstep += s1;
   StepNrOutput->value(camstep+1);
   if (RecMotionBtn->value() > 0)
   {
	   if(RecTimeflag==0){
		   firstcamstep=camstep;
		   TimeOutput->value(0.000);
		   RecTimeflag=1;
		   memcpy(&s1, &buffer[1], 1);
		   filecount = s1;
		   memcpy(&s1, &buffer[6], 1);
		   timecount = s1;
	   }else{
		   TimeOutput->value(double(0.005*(camstep-firstcamstep)));
		   if(int(camstep-firstcamstep)>int(200*timecount+100))
//		   if(TimeOutput->value()>timecount)
		   { 
			   StopMotionBtn->do_callback();
		   }
	   }
//      TimeOutput->value(double(0.005*camstep));
   }else{
      TimeOutput->value(0.000);
		   RecTimeflag=0;
   }
   if ((mainAnimation->num_steps == 0)||(trajOk > 0))
   {
      for (i=0; i<(numCams/3); i++)
      {
         mainAnimation->click[i].insertSpace(mainAnimation->num_steps, 1);
         mainAnimation->click[i].set1Value(mainAnimation->num_steps, 0);
      }
      mainAnimation->num_steps++;
      mainAnimation->animation_step = mainAnimation->num_steps-1;
      StepSlider->maximum(mainAnimation->num_steps);
   }
   for (j=0; j<numCams; j++)
   {
       for (i=0; i<18; i++)
       {
          if ((j%3)==0)
          {
             xyz[i].setValue(-120.0, -120.0, -120.0);
             intens[i].setValue(0.0, 0.0, 0.0);
          }
          memcpy(&s1, &buffer[(j*62)+(i*2)+8], 1);
          memcpy(&s2, &buffer[(j*62)+(i*2)+9], 1);
          if ((s1>0)||(s2>0))
          {
             xyz[i][j%3] = 256.0*s1;
             xyz[i][j%3] += s2;
             xyz[i][j%3] /= 200.0;
			 xyz[i][j%3] -= 163.840;

 //            xyz[i][j%3] /= 320.0;
  //           xyz[i][j%3] -= 102.4;
          }
          if ((firstValues == 0)||(trajOk > 0))
             if ((j%3)==0)
             {
                mainAnimation->led[((j/3)*18)+i].insertSpace(mainAnimation->num_steps-1, 1);
                mainAnimation->intensity[((j/3)*18)+i].insertSpace(mainAnimation->num_steps-1, 1);
             }
          memcpy(&s1, &buffer[(j*62)+i+44], 1);
          intens[i][j%3] = float(s1);
       }
       if (firstValues == 0)
          firstValues++;
       if ((j%3)==2)
       {
          for (i=0; i<18; i++)
          {
             mainAnimation->led[((j/3)*18)+i].set1Value(mainAnimation->num_steps-1, xyz[i]);
             mainAnimation->intensity[((j/3)*18)+i].set1Value(mainAnimation->num_steps-1, intens[i]);
          }
       }
   }
// change source leds data of the extra point (type=220(traj) and 221(actual point)) 070105
   if (mainAnimation->animation_step==0) //070108
   {
	ObjectData *tmpdata;
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   if(tmpdata->type==220 || tmpdata->type==221 )
   {
      for (int k=0; k<18; k++)
		  tmpdata->point_leds[k] = mainAnimation->led[k][0];
/*for (j=0; j<18; j+=2)
printf("point(%2d): %9.3f\t%9.3f\t%9.3f\n",(j+1),tmpdata->point_leds[j][0]
	   ,tmpdata->point_leds[j][1],tmpdata->point_leds[j][2]);*/
   }
   tmpdata = tmpdata->next;
}
   }
//070108
   if ((trajOk > 0)&&(mainAnimation->animation_step>0))
   {
      mainAnimation->calc_animationTrafo(mainAnimation->animation_step-1);
      calcTrajValues();
   }
	   objValues++;
   if (objValues == 2)
   {
	   setObjectEditorObjects2();//add
   }

   if (mainAnimation != NULL)
      applyMotion(0);
   else
      objview->redraw();
}

RecMotionBtn->value(0);
delete[] buffer;
}

void OPTISGui::resetTrajectories() {
  SbVec3d vd1, vd2, vd3, vd4, testvec;
ObjectData *tmpdata;
int i, *numVertices, camnr, type, num, oldnum, lednr;
SdMatrix md;

testvec.setValue(-120.0, -120.0, -120.0);

if (mainAnimation->num_steps > 0)
   numVertices = new int[(mainAnimation->num_steps-1)];
else
   numVertices = NULL;
for (i=0; i<(mainAnimation->num_steps-1); i++)
   numVertices[i] = 2;
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camnr = tmpdata->type/1000;
   if ((type >= 200)&&(type <= 220))
   {
      tmpdata->startStep = 0;
      if ((RecMotionBtn->value() > 0) || (mainAnimation->num_steps == 0))
         tmpdata->stopStep = 0;
      else
         tmpdata->stopStep = mainAnimation->num_steps-1;
      num = 2*(tmpdata->stopStep);
      oldnum = tmpdata->vertexproperty->vertex.getNum();
      if (oldnum > num)
      {
         tmpdata->vertexproperty->vertex.deleteValues(num, -1);
      }
      if (oldnum < num)
      {
         tmpdata->vertexproperty->vertex.insertSpace(oldnum, num-oldnum);
      }
      tmpdata->lineset->numVertices.deleteValues(0 , -1);
      if (tmpdata->stopStep>0)
         tmpdata->lineset->numVertices.setValues(0, tmpdata->stopStep, numVertices);
      if ((type < 220)&&(numVertices > 0))
         tmpdata->point = mainAnimation->led[type-200+(18*camnr)][0];
      if (RecMotionBtn->value() < 1)
      {
         if (type < 220)
         {
            lednr = type%200;
            for(i=0; i<(mainAnimation->num_steps-1); i++)
            {
               vd1 = mainAnimation->led[18*camnr+lednr][i];
               vd2 = mainAnimation->led[18*camnr+lednr][i+1];
               if ((vd1 == testvec) || (vd2 == testvec))
               {
                  vd1 = vd2 = testvec;
               }
               else
               {
                  if (mainAnimation->RSnr >= 0)
                  {
                     mainAnimation->calc_animationTrafo(i);
                     mainAnimation->fov_trafo[camnr].multMatrixVec(mainAnimation->led[(18*camnr)+lednr][i], vd1);
                     mainAnimation->calc_animationTrafo(i+1);
                     mainAnimation->fov_trafo[camnr].multMatrixVec(mainAnimation->led[(18*camnr)+lednr][i+1], vd2);
                  }
               }
               tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
               tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
            }
         }
         else
         {
            for (i=0; i<(mainAnimation->num_steps-1); i++)
            {
               mainAnimation->calc_animationTrafo(i);
               mainAnimation->animation_trafo[camnr].multMatrixVec(tmpdata->point, vd1);
               md = mainAnimation->fov_trafo[camnr].inverse();
               md.multMatrixVec(vd1, vd3);
               mainAnimation->calc_animationTrafo(i+1);
               mainAnimation->animation_trafo[camnr].multMatrixVec(tmpdata->point, vd2);
               md = mainAnimation->fov_trafo[camnr].inverse();
               md.multMatrixVec(vd2, vd4);
               if (RSFOV->value() > 0)
               {
                  vd1 = vd3;
                  vd2 = vd4;
               }
               tmpdata->vertexproperty->vertex.set1Value(2*i, vd1[0], vd1[1], vd1[2]);
               tmpdata->vertexproperty->vertex.set1Value(2*i+1, vd2[0], vd2[1], vd2[2]);
            }
         }
      }
   }
   tmpdata = tmpdata->next;
}
delete[] numVertices;
}

void OPTISGui::calcTrajValues() {
  SbVec3d vd1, vd2, vd3, vd4, testvec;
  SbVec3d vd5, vd6;
  SbVec3d tmp1;
int numVertices, type, camnr, i, lednr;
SdMatrix md;
ObjectData *tmpdata;
SdMatrix m1;

testvec.setValue(-120.0, -120.0, -120.0);
tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camnr = tmpdata->type/1000;
   if ((type >= 200)&&(type <= 220))
   {
      if ((trajStep == 0)&&(type < 220))
      {
         tmpdata->point = mainAnimation->led[type-200][0];
         tmpdata->startStep = 0;
         tmpdata->stopStep = 0;
      }
      if ((trajStep == 0)&&(type == 220)) // 070108 extra trajectory
      {
      for (int k=0; k<18; k++)
		  tmpdata->point_leds[k] = mainAnimation->led[k][0];
      }

      if (trajStep > 0)
      {
         if (type < 220)//LED trajectory
         {
            tmpdata->stopStep++;
            lednr = type%200;
            vd1 = mainAnimation->led[18*camnr+lednr][trajStep-1];
            vd2 = mainAnimation->led[18*camnr+lednr][trajStep];
            if ((vd1 == testvec) || (vd2 == testvec))
            {
               vd1 = vd2 = testvec;
            }
            else
            {
               if (mainAnimation->RSnr >= 0)
               {
                  mainAnimation->calc_animationTrafo(trajStep-1);
                  mainAnimation->fov_trafo[camnr].multMatrixVec(mainAnimation->led[(18*camnr)+lednr][trajStep-1], vd1);
                  mainAnimation->calc_animationTrafo(trajStep);
                  mainAnimation->fov_trafo[camnr].multMatrixVec(mainAnimation->led[(18*camnr)+lednr][trajStep], vd2);
               }
            }
            numVertices = tmpdata->vertexproperty->vertex.getNum();
            tmpdata->vertexproperty->vertex.insertSpace(numVertices, 2);
            numVertices = tmpdata->lineset->numVertices.getNum();
            tmpdata->vertexproperty->vertex.set1Value(2*(trajStep-1), vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*(trajStep-1)+1, vd2[0], vd2[1], vd2[2]);
            i = 2;
            tmpdata->lineset->numVertices.setValues(numVertices ,1 , &i);
         }
         else if (type == 220)//insert extra trajectory
         {
            tmpdata->stopStep++;
         if(tmpdata->reference == -1) //070108
		 {
            mainAnimation->calc_animationTrafoReal(trajStep-1, tmpdata->motionOfObject);
//            mainAnimation->calc_animationTrafo(trajStep-1);
            mainAnimation->animation_trafoR[camnr].multMatrixVec(tmpdata->point, vd1);
            md = mainAnimation->fov_trafoR[camnr].inverse();
            md.multMatrixVec(vd1, vd3);

            mainAnimation->calc_animationTrafoReal(trajStep, tmpdata->motionOfObject);
//            mainAnimation->calc_animationTrafo(trajStep);
            mainAnimation->animation_trafoR[camnr].multMatrixVec(tmpdata->point, vd2);
            md = mainAnimation->fov_trafoR[camnr].inverse();
            md.multMatrixVec(vd2, vd4);
            if (mainAnimation->RSnr == -1)
            {
                vd1 = vd3;
                vd2 = vd4;
            }
			else if (mainAnimation->RSnr == tmpdata->motionOfObject)
			{
                vd1 = tmpdata->point;
                vd2 = tmpdata->point;
			}

            tmpdata->vertexproperty->vertex.set1Value(2*(trajStep-1), vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*(trajStep-1)+1, vd2[0], vd2[1], vd2[2]);

            numVertices = tmpdata->vertexproperty->vertex.getNum();
            tmpdata->vertexproperty->vertex.insertSpace(numVertices, 2);
            numVertices = tmpdata->lineset->numVertices.getNum();
            i = 2;
            tmpdata->lineset->numVertices.setValues(numVertices ,1 , &i);
		 }
		 else if(tmpdata->reference > -1) //070108
		 {
         mainAnimation->calc_animationTrafoRefSys(&tmpdata->point_leds[0], 0, 1,tmpdata->reference);
         m1 = mainAnimation->mRefRefSys[0].inverse();
         m1.multMatrixVec(tmpdata->point, tmp1);
            mainAnimation->calc_animationTrafoReal(trajStep-1, tmpdata->motionOfObject);
//            mainAnimation->calc_animationTrafo(trajStep-1);
            mainAnimation->animation_trafoR[camnr].multMatrixVec(tmp1, vd1);
            md = mainAnimation->fov_trafoR[camnr].inverse();
            md.multMatrixVec(vd1, vd3);

            mainAnimation->calc_animationTrafoReal(trajStep, tmpdata->motionOfObject);
//            mainAnimation->calc_animationTrafo(trajStep);
            mainAnimation->animation_trafoR[camnr].multMatrixVec(tmp1, vd2);
            md = mainAnimation->fov_trafoR[camnr].inverse();
            md.multMatrixVec(vd2, vd4);
            if (mainAnimation->RSnr == -1)
            {
                vd1 = vd3;
                vd2 = vd4;
            }
			else if (mainAnimation->RSnr == tmpdata->motionOfObject)
			{
                vd1 = tmp1;
                vd2 = tmp1;
			}

            tmpdata->vertexproperty->vertex.set1Value(2*(trajStep-1), vd1[0], vd1[1], vd1[2]);
            tmpdata->vertexproperty->vertex.set1Value(2*(trajStep-1)+1, vd2[0], vd2[1], vd2[2]);

            numVertices = tmpdata->vertexproperty->vertex.getNum();
            tmpdata->vertexproperty->vertex.insertSpace(numVertices, 2);
            numVertices = tmpdata->lineset->numVertices.getNum();
            i = 2;
            tmpdata->lineset->numVertices.setValues(numVertices ,1 , &i);
		 }
         }
      }
   }
   tmpdata = tmpdata->next;
}
trajStep++;
}

void OPTISGui::clearLEDs()//clear LEDs
{
  ObjectData *tmplist;

tmplist = objview->objlist;
while (tmplist != NULL)      
{
   if (((tmplist->type%1000) > 99)&&((tmplist->type%1000) <118))
   {
      objview->clearObject(tmplist);
      tmplist = objview->objlist;
   }
   else
      tmplist = tmplist->next;
}
}

void OPTISGui::checkLEDs() {
int i, csys, einfuegen; //einfuegen=insert
SbVec3f xyz;
char st[10];
ObjectData *tmplist;
SbVec3d testxyz;
int num;
int drawstyle;
int j,inum, einfuegen2;
int cnum;
char st2[256];

xyz.setValue(0.0, 0.0, 0.0);
testxyz.setValue(-120.0, -120.0, -120.0);

if (mainAnimation->numCamSystems <= numCamSys)
   num = mainAnimation->numCamSystems;
else
   num = numCamSys;
for (csys=0; csys<num; csys++)
{
   for (i=0; i<18; i++)
   {
      if (mainAnimation->led[csys*18+i][mainAnimation->animation_step] != testxyz)
         einfuegen = 1;  // Objekt behalten bzw. einfuegen( object retain or paste?)
      else
         einfuegen = 0;  // delete object (Objekt loeschen)
      tmplist = objview->objlist;
      while (tmplist != NULL)
      {
         if (tmplist->type == (i+100+(csys*1000)))
         {
            einfuegen--;//insert?
            tmplist = NULL;
         }
         else
            tmplist = tmplist->next;
      }
      if (einfuegen > 0)
      {
         sprintf(st, "LED %d", i+1+(csys*100));
         objview->addSphereObject(&st[0], &xyz, 1, ledRadius, 1);
         objview->objlist->transform->translation.setValue((-ledRadius*(numLEDs-1))+(2.0*ledRadius*i), 20.0, 0.0);
         objview->objlist->type = 100+i+(csys*1000);
//appearance of LEDs
    drawstyle = pref->LEDdrawstyle[i];
	switch (drawstyle)
	{
	   case 0: objview->objlist->drawstyle->style = SoDrawStyle::FILLED; break;
	   case 1: objview->objlist->drawstyle->style = SoDrawStyle::LINES; break;
	   case 2: objview->objlist->drawstyle->style = SoDrawStyle::POINTS; break;
	   case 3: objview->objlist->drawstyle->style = SoDrawStyle::INVISIBLE; break;
	}      

	  }
   }
//add the coordinate of each target frame
for (j=0; j<6; j++)
{
   inum = 0;
   cnum=0;
   for (i=0; i<18; i++)
   {
      if (mainAnimation->LEDofObject[csys][i] == j)
      {
         if (mainAnimation->led[csys*18+i][mainAnimation->animation_step] != testxyz)
            inum++;

		 tmplist = objview->objlist;
		 while (tmplist != NULL)
		 {
			if(tmplist->type==(100+i) && (tmplist->drawstyle->style.getValue() == SoDrawStyle::INVISIBLE))
			{
			cnum++;
//			printf("tmplist->type =%d\n", tmplist->type);
			}
		 tmplist = tmplist->next;
		 }
      
	  }
   }
   if (inum == 3)
         einfuegen2 = 1;
   else
         einfuegen2 = 0;

   tmplist = objview->objlist;
   while (tmplist != NULL)
   {
      if (tmplist->type == (j+2+(csys*1000)))
      {
         einfuegen2--;
         tmplist = NULL;
      }
      else
         tmplist = tmplist->next;
   }

   if (einfuegen2 > 0)
   {
   sprintf(st2,"Axis Lines obj %d",j+1);
   objview->addLineObject2(&st2[0]);
   objview->objlist->type = j+2+(csys*1000);
   if(cnum==3) objview->objlist->drawstyle->style = SoDrawStyle::INVISIBLE;
   objview->redraw();
//   printf("objview->objlist->type =%d\n",objview->objlist->type);
   }	   
}

}
}

void OPTISGui::resetCamSysTrafo() 
{
  ObjectData *tmpdata;
int i, j;
SbVec3f xyz;
SbMatrix m, n;
SbVec3f t;
SbRotation r;
SbVec3f viewpos, viewaxis, lightdir;
float viewangle, focaldist;

tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   if ((tmpdata->type/1000)>=numCamSys)
   {
      objview->clearObject(tmpdata);
      tmpdata = objview->objlist;
   }
   else
      tmpdata = tmpdata->next;
}

for (i=1; i<numCamSys; i++)
{
   j = 0;
   tmpdata = objview->objlist;
   while (tmpdata != NULL)
   {
      if (tmpdata->type == (i*1000+1))
      {
         j++;
      }
      tmpdata = tmpdata->next;
   }
   if (j == 0)
   {
      xyz.setValue(0.0, 0.0, 0.0);
      objview->addCubeObject("FOV", &xyz, 1, 200.0, 200.0, 200.0);
      objview->objlist->material->diffuseColor.setValue(1.0, 1.0, 0.0);
      objview->objlist->material->emissiveColor.setValue(1.0, 1.0, 0.0);
      objview->objlist->type = i*1000+1;
      objview->addScaleLines();
      objview->objlist->material->diffuseColor.setValue(1.0, 1.0, 0.0);
      objview->objlist->material->emissiveColor.setValue(1.0, 1.0, 0.0);
      objview->objlist->type = i*1000+1;
      objview->addScaleValues();
      objview->objlist->material->diffuseColor.setValue(1.0, 1.0, 0.0);
      objview->objlist->material->emissiveColor.setValue(1.0, 1.0, 0.0);
      objview->objlist->type = i*1000+1;
      objview->addAllAxis(i*1000+1);
   }
}

tmpdata = objview->objlist;
while (tmpdata != NULL)
{
   i = tmpdata->type/1000;
   if (i>0)
   {
      tmpdata->transform->setToDefaults();
      tmpTransform->setToDefaults();
      mCamSysTrafo[i].setSbMatrix(m);
      t.setValue(m[0][3], m[1][3], m[2][3]);
      m[0][3] = 0.0;
      m[1][3] = 0.0;
      m[2][3] = 0.0;
      n = m.transpose();
      r.setValue(n);
      tmpTransform->rotation.setValue(r);
      tmpTransform->translation.setValue(t);
      tmpdata->transform->combineRight(tmpTransform);
   }
   tmpdata = tmpdata->next;
}

viewpos = objview->perspCamera->position.getValue();
objview->perspCamera->orientation.getValue(viewaxis, viewangle);
focaldist = objview->perspCamera->focalDistance.getValue();
lightdir = objview->headlight->direction.getValue();

objview->setCenter();

objview->perspCamera->position.setValue(viewpos);
objview->perspCamera->orientation.setValue(viewaxis, viewangle);
objview->perspCamera->focalDistance.setValue(focaldist);
objview->headlight->direction.setValue(lightdir);
}

void OPTISGui::changeCamNumber(int nr) {
  numCams = nr;
numCamSys = nr/3;
setCamSystemsGui();
resetCamSysTrafo();
if (mainAnimation != NULL)
   applyMotion(0);
//ZView->do_callback();
}

void OPTISGui::SetMatrixWinValues(int nr) {
  if (oldCamSys>0)
{
   tmpCamSysRot[oldCamSys][0] = MatRotX->value();
   tmpCamSysRot[oldCamSys][1] = MatRotY->value();
   tmpCamSysRot[oldCamSys][2] = MatRotZ->value();
   tmpCamSysTrans[oldCamSys][0] = MatTransX->value();
   tmpCamSysTrans[oldCamSys][1] = MatTransY->value();
   tmpCamSysTrans[oldCamSys][2] = MatTransZ->value();
   tmpCamSysOverlap[oldCamSys] = MatOverlap->value();
}
MatRotX->value(tmpCamSysRot[nr][0]);
MatRotY->value(tmpCamSysRot[nr][1]);
MatRotZ->value(tmpCamSysRot[nr][2]);
MatTransX->value(tmpCamSysTrans[nr][0]);
MatTransY->value(tmpCamSysTrans[nr][1]);
MatTransZ->value(tmpCamSysTrans[nr][2]);
MatOverlap->value(tmpCamSysOverlap[nr]);
MatrixWindow->redraw();
oldCamSys = nr;
}

void OPTISGui::guiFixedXYZ(SdMatrix &rot, double a, double b, double c) {
  rot[0][0] = cos(c)*cos(b);
rot[0][1] = cos(c)*sin(b)*sin(a) - sin(c)*cos(a);
rot[0][2] = cos(c)*sin(b)*cos(a) + sin(c)*sin(a);
rot[0][3] = 0.0;
rot[1][0] = sin(c)*cos(b);
rot[1][1] = sin(c)*sin(b)*sin(a) + cos(c)*cos(a);
rot[1][2] = sin(c)*sin(b)*cos(a) - cos(c)*sin(a);
rot[1][3] = 0.0;
rot[2][0] = - sin(b);
rot[2][1] = cos(b)*sin(a);
rot[2][2] = cos(b)*cos(a);
rot[2][3] = 0.0;
rot[3][0] = 0.0;
rot[3][1] = 0.0;
rot[3][2] = 0.0;
rot[3][3] = 1.0;
}

void OPTISGui::setCamSystemsGui() {
  switch (numCamSys)
{
   case 1: camNum03->setonly(); break;
   case 2: camNum06->setonly(); break;
   case 3: camNum09->setonly(); break;
   case 4: camNum12->setonly(); break;
   case 5: camNum15->setonly(); break;
   case 6: camNum18->setonly(); break;
   case 7: camNum21->setonly(); break;
   case 8: camNum24->setonly(); break;
   case 9: camNum27->setonly(); break;
   case 10: camNum30->setonly(); break;
}
}

void OPTISGui::insertLEDTrajectory(int lednr, int camnr) {
  SbVec3d vd1, vd2, testvec;
SbVec3f *xyz;
int i;
char st[256];
SdMatrix m1;

testvec.setValue(-120.0, -120.0, -120.0);
xyz = new SbVec3f[2*(mainAnimation->num_steps-1)];
for(i=0; i<(mainAnimation->num_steps-1); i++)
{
   vd1 = mainAnimation->led[18*camnr+lednr][i]; //Reference system is "FOV" (field of view)
   vd2 = mainAnimation->led[18*camnr+lednr][i+1];
   if ((vd1 == testvec) || (vd2 == testvec))
   {
      vd1 = vd2 = testvec;
   }
   else
   {
   if (mainAnimation->RSnr >= 0)//Reference system is "Object 1" to "Object 6" (RSnr = Reference system number)
      {
         mainAnimation->calc_animationTrafo(i);
         mainAnimation->fov_trafo[camnr].multMatrixVec(mainAnimation->led[(18*camnr)+lednr][i], vd1);
         mainAnimation->calc_animationTrafo(i+1);
         mainAnimation->fov_trafo[camnr].multMatrixVec(mainAnimation->led[(18*camnr)+lednr][i+1], vd2);
      }
   /*Object 1: LED 1.3.5, Object2: 7.9.11, Object3:13.15.17*/
   }
   xyz[2*i].setValue(vd1[0], vd1[1], vd1[2]);
   xyz[2*i+1].setValue(vd2[0], vd2[1], vd2[2]);
}
sprintf(st, "Trajectory of LED %d", camnr*100+lednr+1);
objview->addLineObject(&st[0], xyz, (mainAnimation->num_steps-1), 2*(mainAnimation->num_steps-1));
objview->objlist->type = 1000*camnr+200+lednr;
objview->objlist->startStep = 0;
objview->objlist->stopStep = mainAnimation->num_steps-1;
objview->objlist->camSys = camnr;
objview->objlist->motionOfObject = TrajObjChoice->value()-1;
objview->objlist->reference = TrajRefChoice->value()-1;
i = mainAnimation->led[camnr*18+lednr].getNum();
if (i>0)
   objview->objlist->point = mainAnimation->led[camnr*18+lednr][0];
else
   objview->objlist->point.setValue(0.0, 0.0, 0.0);
delete[] xyz;
}

void OPTISGui::deActivateCamSystemChoice(int nr) {
  MatChoice1->deactivate();
MatChoice2->deactivate();
MatChoice3->deactivate();
MatChoice4->deactivate();
MatChoice5->deactivate();
MatChoice6->deactivate();
MatChoice7->deactivate();
MatChoice8->deactivate();
MatChoice9->deactivate();
TrajCamSys1->deactivate();
TrajCamSys2->deactivate();
TrajCamSys3->deactivate();
TrajCamSys4->deactivate();
TrajCamSys5->deactivate();
TrajCamSys6->deactivate();
TrajCamSys7->deactivate();
TrajCamSys8->deactivate();
TrajCamSys9->deactivate();

if (nr == 1)
{
   MatChoice1->activate();
   TrajCamSys1->activate();
}
if (nr == 2)
{
   MatChoice1->activate();
   TrajCamSys1->activate();
   MatChoice2->activate();
   TrajCamSys2->activate();
}
if (nr == 3)
{
   MatChoice1->activate();
   TrajCamSys1->activate();
   MatChoice2->activate();
   TrajCamSys2->activate();
   MatChoice3->activate();
   TrajCamSys3->activate();
}
if (nr == 4)
{
   MatChoice1->activate();
   TrajCamSys1->activate();
   MatChoice2->activate();
   TrajCamSys2->activate();
   MatChoice3->activate();
   TrajCamSys3->activate();
   MatChoice4->activate();
   TrajCamSys4->activate();
}
if (nr == 5)
{
   MatChoice1->activate();
   TrajCamSys1->activate();
   MatChoice2->activate();
   TrajCamSys2->activate();
   MatChoice3->activate();
   TrajCamSys3->activate();
   MatChoice4->activate();
   TrajCamSys4->activate();
   MatChoice5->activate();
   TrajCamSys5->activate();
}
if (nr == 6)
{
   MatChoice1->activate();
   TrajCamSys1->activate();
   MatChoice2->activate();
   TrajCamSys2->activate();
   MatChoice3->activate();
   TrajCamSys3->activate();
   MatChoice4->activate();
   TrajCamSys4->activate();
   MatChoice5->activate();
   TrajCamSys5->activate();
   MatChoice6->activate();
   TrajCamSys6->activate();
}
if (nr == 7)
{
   MatChoice1->activate();
   TrajCamSys1->activate();
   MatChoice2->activate();
   TrajCamSys2->activate();
   MatChoice3->activate();
   TrajCamSys3->activate();
   MatChoice4->activate();
   TrajCamSys4->activate();
   MatChoice5->activate();
   TrajCamSys5->activate();
   MatChoice6->activate();
   TrajCamSys6->activate();
   MatChoice7->activate();
   TrajCamSys7->activate();
}
if (nr == 8)
{
   MatChoice1->activate();
   TrajCamSys1->activate();
   MatChoice2->activate();
   TrajCamSys2->activate();
   MatChoice3->activate();
   TrajCamSys3->activate();
   MatChoice4->activate();
   TrajCamSys4->activate();
   MatChoice5->activate();
   TrajCamSys5->activate();
   MatChoice6->activate();
   TrajCamSys6->activate();
   MatChoice7->activate();
   TrajCamSys7->activate();
   MatChoice8->activate();
   TrajCamSys8->activate();
}
if (nr == 9)
{
   MatChoice1->activate();
   TrajCamSys1->activate();
   MatChoice2->activate();
   TrajCamSys2->activate();
   MatChoice3->activate();
   TrajCamSys3->activate();
   MatChoice4->activate();
   TrajCamSys4->activate();
   MatChoice5->activate();
   TrajCamSys5->activate();
   MatChoice6->activate();
   TrajCamSys6->activate();
   MatChoice7->activate();
   TrajCamSys7->activate();
   MatChoice8->activate();
   TrajCamSys8->activate();
   MatChoice9->activate();
   TrajCamSys9->activate();
}
}
//initialise the field of view (object viewer?)
void OPTISGui::insertFOV() {
  SbVec3f  xyz;
char     st[256];
int      i;
int		damx,damy,damz;	


xyz.setValue(0.0, 0.0, 0.0);
for (i=0; i<numLEDs; i++)
{
   sprintf(st, "LED %d", i+1);
   objview->addSphereObject(&st[0], &xyz, 1, ledRadius, 1);
   objview->objlist->transform->translation.setValue((-ledRadius*(numLEDs-1))+(2.0*ledRadius*i), 0.0, 0.0);
   objview->objlist->type = 100+i;//100-117 is LED
}
/*
//edit 29/11/2013
// testing
//just the header, dont common it out "ObjectViewer::addSphereObject(char *labelstring, SbVec3f *xyz, int numSpheres, float radius, char coordSys)"
	damx = 50;
	damy = 50;
	damz = 50;

xyz.setValue(damx ,damy ,damz);//dummy variable
  sprintf(st, "point of MIPT");
 objview->addSphereObject(&st[0], &xyz, 1, ledRadius, 1);//adding object
 //objview->objlist->transform->translation.setValue((-ledRadius*(numLEDs-1))+(2.0*ledRadius*i), 0.0, 0.0);
 //  objview->objlist->type = 100+i;//100-117 is LED
 */
xyz.setValue(0.0, 0.0, 0.0);
objview->addCubeObject("FOV", &xyz, 1, 200.0, 200.0, 200.0);
objview->objlist->material->diffuseColor.setValue(1.0, 1.0, 0.0);
objview->objlist->material->emissiveColor.setValue(1.0, 1.0, 0.0);
objview->objlist->type = 1;
//objview->addScaleLines();//20130207( why common that out?
objview->objlist->material->diffuseColor.setValue(1.0, 1.0, 0.0);
objview->objlist->material->emissiveColor.setValue(1.0, 1.0, 0.0);
objview->objlist->type = 1;
//objview->addScaleValues();//20130207 same reason as above
objview->objlist->material->diffuseColor.setValue(1.0, 1.0, 0.0);
objview->objlist->material->emissiveColor.setValue(1.0, 1.0, 0.0);
objview->objlist->type = 1;
objview->addAllAxis(1);
objview->setCenter();
objview->RotateX(1.5708);
}

void OPTISGui::setLEDControlValues() {
  ObjectData *tmpdata;
int type, camnr, i, akt, anzled;
char st[256], stn[256];
SbVec3d max, min, mean, diff;
SbVec3f imax, imin, idiff, imean;
clock_t goal;

if (LEDCtrlManual->value() > 0)
{
   if (LEDNextValue == 0)
      return;
   else
      LEDNextValue = 0; // zuruecksetzen (reset? go back?)
}

if (LEDnum >= 20)
{
   for (i=0; i<18; i++)
   {
      sprintf(LEDControlTxt[i][0], "LED %d min = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )", i+1,
         LEDmin[i][0], LEDmin[i][1], LEDmin[i][2], int(LEDimin[i][0]), int(LEDimin[i][1]), int(LEDimin[i][2]));
      zahlenAnordnen(&LEDControlTxt[i][0][0]);
      sprintf(LEDControlTxt[i][1], "LED %d max = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )", i+1,
         LEDmax[i][0], LEDmax[i][1], LEDmax[i][2], int(LEDimax[i][0]), int(LEDimax[i][1]), int(LEDimax[i][2]));
      zahlenAnordnen(&LEDControlTxt[i][1][0]);
      diff = LEDmax[i] - LEDmin[i];
      idiff = LEDimax[i] - LEDimin[i];
      sprintf(LEDControlTxt[i][2], "LED %d diff = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )", i+1,
         diff[0], diff[1], diff[2], int(idiff[0]), int(idiff[1]), int(idiff[2]));
      zahlenAnordnen(&LEDControlTxt[i][2][0]);
      LEDmean[i] /= 20.0;
      LEDimean[i] /= 20.0;
      sprintf(LEDControlTxt[i][3], "LED %d mean = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )", i+1,
         LEDmean[i][0], LEDmean[i][1], LEDmean[i][2], int(LEDimean[i][0]), int(LEDimean[i][1]), int(LEDimean[i][2]));
      zahlenAnordnen(&LEDControlTxt[i][3][0]);
      LEDmax[i].setValue(-1000.0, -1000.0, -1000.0);
      LEDmin[i].setValue(1000.0, 1000.0, 1000.0);
      LEDmean[i].setValue(0.0, 0.0, 0.0);
      LEDimax[i].setValue(-1000.0, -1000.0, -1000.0);
      LEDimin[i].setValue(1000.0, 1000.0, 1000.0);
      LEDimean[i].setValue(0.0, 0.0, 0.0);
   }
   LEDnum = 0;
}

akt = 0;
anzled = 18;
LEDnum++;

if (LEDControlBrowser->size() < 115)
{
   LEDControlBrowser->clear();
   for (i=0; i<115; i++)
   {
      sprintf(st, "line %d", i+1);
      LEDControlBrowser->add(&st[0]);
   }
}

tmpdata = objview->objlist;
i = 0;
max.setValue(-1000.0, -1000.0, -1000.0);
min.setValue(1000.0, 1000.0, 1000.0);
mean.setValue(0.0, 0.0, 0.0);
imax.setValue(-1000.0, -1000.0, -1000.0);
imin.setValue(1000.0, 1000.0, 1000.0);
imean.setValue(0.0, 0.0, 0.0);
while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camnr = tmpdata->type/1000;
   if ((type > 99) && (type < 118) && (camnr == 0))
   {
      objview->getLabel(tmpdata, &stn[0]);
      sprintf(st, "%s actual = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )", &stn[0], 
         mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0],
         mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1],
         mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2],
         int(mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0]),
         int(mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1]),
         int(mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2]));
      zahlenAnordnen(&st[0]);

         LEDControlBrowser->text(6*(type-100)+1, &stn[0]);
         LEDControlBrowser->text(6*(type-100)+2, &st[0]);
         LEDControlBrowser->text(6*(type-100)+3, &LEDControlTxt[type-100][0][0]);
         LEDControlBrowser->text(6*(type-100)+4, &LEDControlTxt[type-100][1][0]);
         LEDControlBrowser->text(6*(type-100)+5, &LEDControlTxt[type-100][2][0]);
         LEDControlBrowser->text(6*(type-100)+6, &LEDControlTxt[type-100][3][0]);

/*      if ((type-99) > anzled)
         anzled = type-99;
      if ((anzled*6) <= LEDControlBrowser->size())
      {
      }
      else
      {
         LEDControlBrowser->insert(0, &LEDControlTxt[i][3][0]);
         LEDControlBrowser->insert(0, &LEDControlTxt[i][2][0]);
         LEDControlBrowser->insert(0, &LEDControlTxt[i][1][0]);
         LEDControlBrowser->insert(0, &LEDControlTxt[i][0][0]);
         LEDControlBrowser->insert(0, &st[0]);
         LEDControlBrowser->insert(0, &stn[0]);
      }*/
      akt += 6;

      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0] > LEDmax[type-100][0])
         LEDmax[type-100][0] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0];
      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1] > LEDmax[type-100][1])
         LEDmax[type-100][1] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1];
      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2] > LEDmax[type-100][2])
         LEDmax[type-100][2] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2];

      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0] < LEDmin[type-100][0])
         LEDmin[type-100][0] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0];
      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1] < LEDmin[type-100][1])
         LEDmin[type-100][1] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1];
      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2] < LEDmin[type-100][2])
         LEDmin[type-100][2] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2];

      LEDmean[type-100] += mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step];

      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0] > LEDimax[type-100][0])
         LEDimax[type-100][0] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1] > LEDimax[type-100][1])
         LEDimax[type-100][1] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2] > LEDimax[type-100][2])
         LEDimax[type-100][2] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2];

      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0] < LEDimin[type-100][0])
         LEDimin[type-100][0] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1] < LEDimin[type-100][1])
         LEDimin[type-100][1] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2] < LEDimin[type-100][2])
         LEDimin[type-100][2] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2];

      LEDimean[type-100] += mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step];      

      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0] > max[0])
         max[0] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0];
      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1] > max[1])
         max[1] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1];
      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2] > max[2])
         max[2] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2];

      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0] < min[0])
         min[0] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0];
      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1] < min[1])
         min[1] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1];
      if (mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2] < min[2])
         min[2] = mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2];

      mean += mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step];

      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0] > imax[0])
         imax[0] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1] > imax[1])
         imax[1] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2] > imax[2])
         imax[2] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2];

      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0] < imin[0])
         imin[0] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1] < imin[1])
         imin[1] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1];
      if (mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2] < imin[2])
         imin[2] = mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2];

      imean += mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step];      

      i++;
      if ((i%anzled) == 0)
      {
         if (akt < LEDControlBrowser->size())
            LEDControlBrowser->text(akt+1, "...");
         else
            LEDControlBrowser->add("...");
         akt++;

         mean /= double(anzled);
         imean /= double(anzled);
         sprintf(st, "min = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )",
            min[0], min[1], min[2], int(imin[0]), int(imin[1]), int(imin[2]));
         zahlenAnordnen(&st[0]);
         if (akt < LEDControlBrowser->size())
            LEDControlBrowser->text(akt+1, &st[0]);
         else
            LEDControlBrowser->add(&st[0]);
         akt++;

         sprintf(st, "max = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )",
            max[0], max[1], max[2], int(imax[0]), int(imax[1]), int(imax[2]));
         zahlenAnordnen(&st[0]);
         if (akt < LEDControlBrowser->size())
            LEDControlBrowser->text(akt+1, &st[0]);
         else
            LEDControlBrowser->add(&st[0]);
         akt++;

         diff = max - min;
         idiff = imax - imin;
         sprintf(st, "diff = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )",
            diff[0], diff[1], diff[2], int(idiff[0]), int(idiff[1]), int(idiff[2]));
         zahlenAnordnen(&st[0]);
         if (akt < LEDControlBrowser->size())
            LEDControlBrowser->text(akt+1, &st[0]);
         else
            LEDControlBrowser->add(&st[0]);
         akt++;

         sprintf(st, "mean = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )",
            mean[0], mean[1], mean[2], int(imean[0]), int(imean[1]), int(imean[2]));
         zahlenAnordnen(&st[0]);
         if (akt < LEDControlBrowser->size())
            LEDControlBrowser->text(akt+1, &st[0]);
         else
            LEDControlBrowser->add(&st[0]);
         akt++;

         vMean100 += diff;
         jMean100 += imean;
         iMean100++;

         if (iMean100 >= 20)
         {
            vMean100 /= double(iMean100);
            jMean100 /= float(iMean100);
            sprintf(st, "Diff[20] = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )",
               vMean100[0], vMean100[1], vMean100[2], int(jMean100[0]), int(jMean100[1]), int(jMean100[2]));
            zahlenAnordnen(&st[0]);
            if (akt < LEDControlBrowser->size())
               LEDControlBrowser->text(akt+1, "---");
            else
               LEDControlBrowser->add("---");
            akt++;
            if (akt < LEDControlBrowser->size())
               LEDControlBrowser->text(akt+1, &st[0]);
            else
               LEDControlBrowser->add(&st[0]);
            akt++;
  
            iMean100 = 0;
            vMean100.setValue(0.0, 0.0, 0.0);
            jMean100.setValue(0.0, 0.0, 0.0);
         }

         max.setValue(-1000.0, -1000.0, -1000.0);
         min.setValue(1000.0, 1000.0, 1000.0);
         mean.setValue(0.0, 0.0, 0.0);
         imax.setValue(-1000.0, -1000.0, -1000.0);
         imin.setValue(1000.0, 1000.0, 1000.0);
         imean.setValue(0.0, 0.0, 0.0);
      }
   }
   tmpdata = tmpdata->next;
}

   goal = LEDclock + 50;
   while(goal > clock())
   {
      Fl::check();
   }
}
//select target LED and reference LED
Fl_Menu_Item OPTISGui::menu_LED1Choice[] = {
 {"LED 1", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 2", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 3", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 4", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 5", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 6", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 7", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 8", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 9", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED10", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED11", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED12", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED13", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED14", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED15", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED16", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED17", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED18", 0,  0, 0, 0, 0, 0, 14, 56},
 {"none", 0,  0, 0, 0, 0, 0, 14, 56},
 {0}
};
Fl_Menu_Item* OPTISGui::LED1C1 = OPTISGui::menu_LED1Choice + 0;
Fl_Menu_Item* OPTISGui::LED1C2 = OPTISGui::menu_LED1Choice + 1;
Fl_Menu_Item* OPTISGui::LED1C3 = OPTISGui::menu_LED1Choice + 2;
Fl_Menu_Item* OPTISGui::LED1C4 = OPTISGui::menu_LED1Choice + 3;
Fl_Menu_Item* OPTISGui::LED1C5 = OPTISGui::menu_LED1Choice + 4;
Fl_Menu_Item* OPTISGui::LED1C6 = OPTISGui::menu_LED1Choice + 5;
Fl_Menu_Item* OPTISGui::LED1C7 = OPTISGui::menu_LED1Choice + 6;
Fl_Menu_Item* OPTISGui::LED1C8 = OPTISGui::menu_LED1Choice + 7;
Fl_Menu_Item* OPTISGui::LED1C9 = OPTISGui::menu_LED1Choice + 8;
Fl_Menu_Item* OPTISGui::LED1C10 = OPTISGui::menu_LED1Choice + 9;
Fl_Menu_Item* OPTISGui::LED1C11 = OPTISGui::menu_LED1Choice + 10;
Fl_Menu_Item* OPTISGui::LED1C12 = OPTISGui::menu_LED1Choice + 11;
Fl_Menu_Item* OPTISGui::LED1C13 = OPTISGui::menu_LED1Choice + 12;
Fl_Menu_Item* OPTISGui::LED1C14 = OPTISGui::menu_LED1Choice + 13;
Fl_Menu_Item* OPTISGui::LED1C15 = OPTISGui::menu_LED1Choice + 14;
Fl_Menu_Item* OPTISGui::LED1C16 = OPTISGui::menu_LED1Choice + 15;
Fl_Menu_Item* OPTISGui::LED1C17 = OPTISGui::menu_LED1Choice + 16;
Fl_Menu_Item* OPTISGui::LED1C18 = OPTISGui::menu_LED1Choice + 17;
Fl_Menu_Item* OPTISGui::LED1C19 = OPTISGui::menu_LED1Choice + 18;  

Fl_Menu_Item OPTISGui::menu_LED2Choice[] = {
 {"LED 1", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 2", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 3", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 4", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 5", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 6", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 7", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 8", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED 9", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED10", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED11", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED12", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED13", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED14", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED15", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED16", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED17", 0,  0, 0, 0, 0, 0, 14, 56},
 {"LED18", 0,  0, 0, 0, 0, 0, 14, 56},
 {"none", 0,  0, 0, 0, 0, 0, 14, 56},
 {0}
};
Fl_Menu_Item* OPTISGui::LED2C1 = OPTISGui::menu_LED2Choice + 0;
Fl_Menu_Item* OPTISGui::LED2C2 = OPTISGui::menu_LED2Choice + 1;
Fl_Menu_Item* OPTISGui::LED2C3 = OPTISGui::menu_LED2Choice + 2;
Fl_Menu_Item* OPTISGui::LED2C4 = OPTISGui::menu_LED2Choice + 3;
Fl_Menu_Item* OPTISGui::LED2C5 = OPTISGui::menu_LED2Choice + 4;
Fl_Menu_Item* OPTISGui::LED2C6 = OPTISGui::menu_LED2Choice + 5;
Fl_Menu_Item* OPTISGui::LED2C7 = OPTISGui::menu_LED2Choice + 6;
Fl_Menu_Item* OPTISGui::LED2C8 = OPTISGui::menu_LED2Choice + 7;
Fl_Menu_Item* OPTISGui::LED2C9 = OPTISGui::menu_LED2Choice + 8;
Fl_Menu_Item* OPTISGui::LED2C10 = OPTISGui::menu_LED2Choice + 9;
Fl_Menu_Item* OPTISGui::LED2C11 = OPTISGui::menu_LED2Choice + 10;
Fl_Menu_Item* OPTISGui::LED2C12 = OPTISGui::menu_LED2Choice + 11;
Fl_Menu_Item* OPTISGui::LED2C13 = OPTISGui::menu_LED2Choice + 12;
Fl_Menu_Item* OPTISGui::LED2C14 = OPTISGui::menu_LED2Choice + 13;
Fl_Menu_Item* OPTISGui::LED2C15 = OPTISGui::menu_LED2Choice + 14;
Fl_Menu_Item* OPTISGui::LED2C16 = OPTISGui::menu_LED2Choice + 15;
Fl_Menu_Item* OPTISGui::LED2C17 = OPTISGui::menu_LED2Choice + 16;
Fl_Menu_Item* OPTISGui::LED2C18 = OPTISGui::menu_LED2Choice + 17;
Fl_Menu_Item* OPTISGui::LED2C19 = OPTISGui::menu_LED2Choice + 18; 

void OPTISGui::setLEDControl2Values() {
int type, camnr, i;
char st[256], stn[256];
SbVec3d xyz[18];
double dist[18];
int iled1, iled2;

if (LEDCtrl2Manual->value() > 0)
{
   if (LEDNextValue2 == 0)
      return;
   else
      LEDNextValue2 = 0; // zuruecksetzen (reset? go back?putback?)
}

if (LEDControl2Browser->size() < 115)
{
   LEDControl2Browser->clear();
   for (i=0; i<115; i++)
   {
//      sprintf(st, "line %d", i+1);
      sprintf(st, "     ");
      LEDControl2Browser->add(&st[0]);
   }
}
//created a tmpdata pointer and pointing to objectlist
  ObjectData *tmpdata;
  tmpdata = objview->objlist;
  i = 0;

	iled1 = LED1Choice->value();
	iled2 = LED2Choice->value();

//show up how to obtain coordinate(I guess -sam)
   for (i=0; i<18; i++)
   {
		xyz[i][0] = mainAnimation->led[i][mainAnimation->animation_step][0];
		xyz[i][1] = mainAnimation->led[i][mainAnimation->animation_step][1];
		xyz[i][2] = mainAnimation->led[i][mainAnimation->animation_step][2];
	}

   for (i=0; i<3; i++)
   {
	vector[0][i] =  xyz[iled1][i]-xyz[iled2][i];
   }
   sprintf(LEDControl2Txt[0][0], "Target LED    = ( %.3f, %.3f, %.3f )", xyz[iled1][0],xyz[iled1][1],xyz[iled1][2]);
   sprintf(LEDControl2Txt[1][0], "Reference LED = ( %.3f, %.3f, %.3f )", xyz[iled2][0],xyz[iled2][1],xyz[iled2][2]);
   sprintf(LEDControl2Txt[2][0], "                     ");
   sprintf(LEDControl2Txt[3][0], "Vector        = ( %.3f, %.3f, %.3f )", vector[0][0],vector[0][1],vector[0][2]);

   for (i=0; i<4; i++)
   {
	LEDControl2Browser->text(i+1, &LEDControl2Txt[i][0][0]);
   }
   
   
   dist[0]= sqrt(pow((xyz[iled1][0]-xyz[iled2][0]),2)+pow((xyz[iled1][1]-xyz[iled2][1]),2)+pow((xyz[iled1][2]-xyz[iled2][2]),2));
   sprintf(LEDControl2Txt[0][1], "distance      = ( %.7f )", dist[0]);
         LEDControl2Browser->text(4+1, &LEDControl2Txt[0][1][0]);

/*	dist[0]= sqrt(pow((xyz[0][0]-xyz[2][0]),2)+pow((xyz[0][1]-xyz[2][1]),2)+pow((xyz[0][2]-xyz[2][2]),2));
	dist[1]= sqrt(pow((xyz[2][0]-xyz[4][0]),2)+pow((xyz[2][1]-xyz[4][1]),2)+pow((xyz[2][2]-xyz[4][2]),2));
	dist[2]= sqrt(pow((xyz[4][0]-xyz[0][0]),2)+pow((xyz[4][1]-xyz[0][1]),2)+pow((xyz[4][2]-xyz[0][2]),2));
	dist[3]= sqrt(pow((xyz[6][0]-xyz[8][0]),2)+pow((xyz[6][1]-xyz[8][1]),2)+pow((xyz[6][2]-xyz[8][2]),2));
	dist[4]= sqrt(pow((xyz[8][0]-xyz[10][0]),2)+pow((xyz[8][1]-xyz[10][1]),2)+pow((xyz[8][2]-xyz[10][2]),2));
	dist[5]= sqrt(pow((xyz[10][0]-xyz[8][0]),2)+pow((xyz[10][1]-xyz[8][1]),2)+pow((xyz[10][2]-xyz[8][2]),2));
	dist[6]= sqrt(pow((xyz[12][0]-xyz[14][0]),2)+pow((xyz[12][1]-xyz[14][1]),2)+pow((xyz[12][2]-xyz[14][2]),2));
	dist[7]= sqrt(pow((xyz[14][0]-xyz[16][0]),2)+pow((xyz[14][1]-xyz[16][1]),2)+pow((xyz[14][2]-xyz[16][2]),2));
	dist[8]= sqrt(pow((xyz[16][0]-xyz[12][0]),2)+pow((xyz[16][1]-xyz[12][1]),2)+pow((xyz[16][2]-xyz[12][2]),2));

   sprintf(RefLEDControlTxt[0][0], "Target Frame 1");
   sprintf(RefLEDControlTxt[1][0], "LED  1 &  3 distance = ( %.7f )", dist[0]);
   sprintf(RefLEDControlTxt[2][0], "LED  3 &  5 distance = ( %.7f )", dist[1]);
   sprintf(RefLEDControlTxt[3][0], "LED  5 &  1 distance = ( %.7f )", dist[2]);
   sprintf(RefLEDControlTxt[4][0], "Target Frame 2");
   sprintf(RefLEDControlTxt[5][0], "LED  7 &  9 distance = ( %.7f )", dist[3]);
   sprintf(RefLEDControlTxt[6][0], "LED  9 & 11 distance = ( %.7f )", dist[4]);
   sprintf(RefLEDControlTxt[7][0], "LED 11 &  9 distance = ( %.7f )", dist[5]);
   sprintf(RefLEDControlTxt[8][0], "Target Frame 3");
   sprintf(RefLEDControlTxt[9][0], "LED 13 & 15 distance = ( %.7f )", dist[6]);
   sprintf(RefLEDControlTxt[10][0], "LED 15 & 17 distance = ( %.7f )", dist[7]);
   sprintf(RefLEDControlTxt[11][0], "LED 17 & 15 distance = ( %.7f )", dist[8]);

   for (i=0; i<12; i++)
   {
      zahlenAnordnen(&RefLEDControlTxt[i][0][0]);
   }

   for (i=0; i<3; i++)
   {
	vector[0][i] =  xyz[0][i]-xyz[12][i];
	vector[1][i] =  xyz[2][i]-xyz[12][i];
	vector[2][i] =  xyz[4][i]-xyz[12][i];
	vector[3][i] =  xyz[6][i]-xyz[12][i];
	vector[4][i] =  xyz[8][i]-xyz[12][i];
	vector[5][i] = xyz[10][i]-xyz[12][i];
	vector[6][i] =  xyz[0][i]-xyz[14][i];
	vector[7][i] =  xyz[2][i]-xyz[14][i];
	vector[8][i] =  xyz[4][i]-xyz[14][i];
	vector[9][i] =  xyz[6][i]-xyz[14][i];
	vector[10][i]=  xyz[8][i]-xyz[14][i];
	vector[11][i]= xyz[10][i]-xyz[14][i];
	vector[12][i]=  xyz[0][i]-xyz[16][i];
	vector[13][i]=  xyz[2][i]-xyz[16][i];
	vector[14][i]=  xyz[4][i]-xyz[16][i];
	vector[15][i]=  xyz[6][i]-xyz[16][i];
	vector[16][i]=  xyz[8][i]-xyz[16][i];
	vector[17][i]= xyz[10][i]-xyz[16][i];
   }
   sprintf(RefLEDControlTxt[0][1], "Third Target Frame (LED13,15,17)");
   sprintf(RefLEDControlTxt[1][1], "Vector (Target Led is 13)");
   sprintf(RefLEDControlTxt[2][1], "LED  1 & 13 = ( %.3f, %.3f, %.3f )", vector[0][0],vector[0][1],vector[0][2]);
   sprintf(RefLEDControlTxt[3][1], "LED  3 & 13 = ( %.3f, %.3f, %.3f )", vector[1][0],vector[1][1],vector[1][2]);
   sprintf(RefLEDControlTxt[4][1], "LED  5 & 13 = ( %.3f, %.3f, %.3f )", vector[2][0],vector[2][1],vector[2][2]);
   sprintf(RefLEDControlTxt[5][1], "LED  7 & 13 = ( %.3f, %.3f, %.3f )", vector[3][0],vector[3][1],vector[3][2]);
   sprintf(RefLEDControlTxt[6][1], "LED  9 & 13 = ( %.3f, %.3f, %.3f )", vector[4][0],vector[4][1],vector[4][2]);
   sprintf(RefLEDControlTxt[7][1], "LED 11 & 13 = ( %.3f, %.3f, %.3f )", vector[5][0],vector[5][1],vector[5][2]);
   sprintf(RefLEDControlTxt[8][1], "Vector (Target Led is 15)");
   sprintf(RefLEDControlTxt[9][1], "LED  1 & 15 = ( %.3f, %.3f, %.3f )", vector[6][0],vector[6][1],vector[6][2]);
   sprintf(RefLEDControlTxt[10][1], "LED  3 & 15 = ( %.3f, %.3f, %.3f )", vector[7][0],vector[7][1],vector[7][2]);
   sprintf(RefLEDControlTxt[11][1], "LED  5 & 15 = ( %.3f, %.3f, %.3f )", vector[8][0],vector[8][1],vector[8][2]);
   sprintf(RefLEDControlTxt[12][1], "LED  7 & 15 = ( %.3f, %.3f, %.3f )", vector[9][0],vector[9][1],vector[9][2]);
   sprintf(RefLEDControlTxt[13][1], "LED  9 & 15 = ( %.3f, %.3f, %.3f )", vector[10][0],vector[10][1],vector[10][2]);
   sprintf(RefLEDControlTxt[14][1], "LED 11 & 15 = ( %.3f, %.3f, %.3f )", vector[11][0],vector[11][1],vector[11][2]);
   sprintf(RefLEDControlTxt[15][1], "Vector (Target Led is 17)");
   sprintf(RefLEDControlTxt[16][1], "LED  1 & 17 = ( %.3f, %.3f, %.3f )", vector[12][0],vector[12][1],vector[12][2]);
   sprintf(RefLEDControlTxt[17][1], "LED  3 & 17 = ( %.3f, %.3f, %.3f )", vector[13][0],vector[13][1],vector[13][2]);
   sprintf(RefLEDControlTxt[18][1], "LED  5 & 17 = ( %.3f, %.3f, %.3f )", vector[14][0],vector[14][1],vector[14][2]);
   sprintf(RefLEDControlTxt[19][1], "LED  7 & 17 = ( %.3f, %.3f, %.3f )", vector[15][0],vector[15][1],vector[15][2]);
   sprintf(RefLEDControlTxt[20][1], "LED  9 & 17 = ( %.3f, %.3f, %.3f )", vector[16][0],vector[16][1],vector[16][2]);
   sprintf(RefLEDControlTxt[21][1], "LED 11 & 17 = ( %.3f, %.3f, %.3f )", vector[17][0],vector[17][1],vector[17][2]);

   for (i=0; i<22; i++)
   {
      zahlenAnordnen(&RefLEDControlTxt[i][1][0]);
   }*/

while (tmpdata != NULL)
{
   type = tmpdata->type%1000;
   camnr = tmpdata->type/1000;
   if ((type > 99) && (type < 118) && (camnr == 0))
   {
      objview->getLabel(tmpdata, &stn[0]);
	  
	  sprintf(st, "%s actual = ( %.3f, %.3f, %.3f ),    I = ( %d, %d, %d )", &stn[0], 
         mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][0],
         mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][1],
         mainAnimation->led[(camnr*18)+(type-100)][mainAnimation->animation_step][2],
         int(mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][0]),
         int(mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][1]),
         int(mainAnimation->intensity[(camnr*18)+(type-100)][mainAnimation->animation_step][2]));
      zahlenAnordnen(&st[0]);
         LEDControl2Browser->text((type-100)+1+10, &st[0]);
      i++;
   }
   tmpdata = tmpdata->next;
}

/*   for (i=0; i<12; i++)
   {
         RefLEDControlBrowser->text(18+i+1, &RefLEDControlTxt[i][0][0]);
   }
   for (i=0; i<22; i++)
   {
         RefLEDControlBrowser->text(30+i+1, &RefLEDControlTxt[i][1][0]);
   }*/

}

void OPTISGui::checkLEDValues() //correct errors
{
  if (LEDOkay->value() > 255)
   LEDOkay->value(255);
if (LEDOkay->value() < 3)
   LEDOkay->value(3);
if (LEDVisible->value() >= LEDOkay->value())
   LEDVisible->value(LEDOkay->value()-1);
if (LEDWeakly->value() >= LEDVisible->value())
   LEDWeakly->value(LEDVisible->value()-1);
}
//number arrangement
void OPTISGui::zahlenAnordnen(char *st) //number arrangement
{
int i, j, k, m;
char tst[256];

i = 0;
j = 0;

while((i < 256) && (st[i] != '\0') && (st[i] != '=')) //copy st[] to tst[]
{
   tst[j] = st[i];
   j++;
   i++;
}

while(j<15)//use space to enlarge the tst[] to 15 characters
{
   tst[j] = ' ';
   j++;
}

while((i < 256) && (st[i] != '\0') && (st[i] != '('))
{
   tst[j] = st[i];
   j++;
   i++;
}

tst[j] = st[i];
j++;
i++;
tst[j] = st[i];
j++;
i++;

m = i;//m = 256 or sth else
while((i < 256) && (st[i] != '\0') && (st[i] != '.'))
   i++;

k = i-m;//k=0 or sth else
i = m;

while (k < 4)
{
   tst[j] = ' ';
   j++;
   k++;
}
while((i < 256) && (st[i] != '\0') && (st[i] != ','))
{
   tst[j] = st[i];
   j++;
   i++;
}

tst[j] = st[i];
j++;
i++;
tst[j] = st[i];
j++;
i++;

m = i;

while((i < 256) && (st[i] != '\0') && (st[i] != '.'))
   i++;

k = i-m;
i = m;
while (k < 4)
{
   tst[j] = ' ';
   j++;
   k++;
}
while((i < 256) && (st[i] != '\0') && (st[i] != ','))
{
   tst[j] = st[i];
   j++;
   i++;
}
tst[j] = st[i];
j++;
i++;
tst[j] = st[i];
j++;
i++;

m = i;
while((i < 256) && (st[i] != '\0') && (st[i] != '.'))
   i++;
k = i-m;
i = m;
while (k < 4)
{
   tst[j] = ' ';
   j++;
   k++;
}
while((i < 256) && (st[i] != '\0') && (st[i] != '('))
{
   tst[j] = st[i];
   j++;
   i++;
}
tst[j] = st[i];
j++;
i++;
tst[j] = st[i];
j++;
i++;

m = i;
while((i < 256) && (st[i] != '\0') && (st[i] != ','))
   i++;
k = i-m;
i = m;
while (k < 3)
{
   tst[j] = ' ';
   j++;
   k++;
}
while((i < 256) && (st[i] != '\0') && (st[i] != ','))
{
   tst[j] = st[i];
   j++;
   i++;
}
tst[j] = st[i];
j++;
i++;
tst[j] = st[i];
j++;
i++;

m = i;
while((i < 256) && (st[i] != '\0') && (st[i] != ','))
   i++;
k = i-m;
i = m;
while (k < 3)
{
   tst[j] = ' ';
   j++;
   k++;
}
while((i < 256) && (st[i] != '\0') && (st[i] != ','))
{
   tst[j] = st[i];
   j++;
   i++;
}
tst[j] = st[i];
j++;
i++;
tst[j] = st[i];
j++;
i++;

m = i;
while((i < 256) && (st[i] != '\0') && (st[i] != ')'))
   i++;
k = i-m;
i = m;
while (k < 4)
{
   tst[j] = ' ';
   j++;
   k++;
}

while((i < 256) && (st[i] != '\0'))
{
   tst[j] = st[i];
   j++;
   i++;
}
tst[j] = '\0';

sprintf(st, tst);
}

void OPTISGui::getNewRecordingText() {
  MvmNameWinInput->value(&mvmHeaderText[0]);
MvmNameWindow->position(
   LEDViewer->x()+((LEDViewer->w()-MvmNameWindow->w())/2),
   LEDViewer->y()+((LEDViewer->h()-MvmNameWindow->h())/2));
MvmNameWindow->show();
}

void OPTISGui::initLEDCharWindow() {
  int i, j;

if (LEDGroups == NULL)
{
   LEDGroups = new Fl_Group*[18];
   LEDGroupsTxt = new Fl_Box*[18];
   LEDGroupsBtn = new Fl_Round_Button**[18];
   for (i=0; i<18; i++)
   {
      LEDGroupsBtn[i] = new Fl_Round_Button*[7];
      sprintf(&LEDGroupsStr[i][0], "%d", i+1);
      LEDGroups[i] = new Fl_Group(80+(30*i), 125, 30, 310);
      LEDGroupsTxt[i] = new Fl_Box(75+(30*i), 95, 30, 25, &LEDGroupsStr[i][0]);
      for (j=0; j<7; j++)
      {
         LEDGroupsBtn[i][j] = new Fl_Round_Button(80+(30*i), 125+(25*j), 30, 25);
         LEDGroupsBtn[i][j]->type(102);
         LEDGroupsBtn[i][j]->down_box(FL_ROUND_DOWN_BOX);
         if ((i/3) == j)
            LEDGroupsBtn[i][j]->value(1);
         else
            LEDGroupsBtn[i][j]->value(0);
      }
      LEDGroups[i]->end();
      LedCharWinLEDObj->add(LEDGroups[i]);
   }
}

if (ObjGroups == NULL)
{
   ObjGroups = new Fl_Group*[6];
   ObjGroupsBtn = new Fl_Round_Button**[6];
   for (i=0; i<6; i++)
   {
      ObjGroupsBtn[i] = new Fl_Round_Button*[8];
      ObjGroups[i] = new Fl_Group(125+(80*i), 395, 80, 200);
      for (j=0; j<8; j++)
      {
         ObjGroupsBtn[i][j] = new Fl_Round_Button(155+(80*i), 395+(25*j), 30, 25);
         ObjGroupsBtn[i][j]->type(102);
         ObjGroupsBtn[i][j]->down_box(FL_ROUND_DOWN_BOX);
         if ((i+1) == j)
            ObjGroupsBtn[i][j]->deactivate();
      }
      ObjGroups[i]->end();
      LedCharWinObjObj->add(ObjGroups[i]);
      if ((i%2) == 0)
         ObjGroupsBtn[i][0]->setonly();
      else
         ObjGroupsBtn[i][i]->setonly();
   }
}
}

void OPTISGui::receiveOnceSocketData() {
  int i, j, firstValues, buflen;
SbVec3d xyz[18];
SbVec3f intens[18];
unsigned char s1, s2;
char c, message[260];
unsigned long camstep;
char *buffer;

for (i=0; i<260; i++)//each byte of message[]
   message[i] = '\0';
message[0] = 'c';
message[1] = (unsigned char) numCams;
buflen = numCams*62;
buffer = new char[buflen];

firstValues = 0;
if ((socketStopped == 0)&&(csoc.connected>0))
{
   do
   {
      c = csoc.SendMsg(&message[0], 260);
      if (c < 0)
         socketStopped = 1;
      Fl::check();
   } while ((c < 1)&&(socketStopped == 0)&&(csoc.connected>0));
   if(socketStopped > 0)
   {
      csoc.CloseSocket();
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }
   if (csoc.connected == 0)
   {
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }

   do
   {
      c = csoc.ReceiveMsg((char*)buffer, buflen);
      if (c < 0)
         socketStopped = 1;
      Fl::check();
   } while ((c < 1)&&(socketStopped == 0)&&(csoc.connected>0));
   if(socketStopped > 0)
   {
      csoc.CloseSocket();
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }
   if (csoc.connected == 0)
   {
      CameraOkBox->color(1);
      CameraOkBox->redraw();
      return;
   }

   LEDclock = clock();

   memcpy(&s1, &buffer[2], 1);
   camstep =  256*256*256*s1;
   memcpy(&s1, &buffer[3], 1);
   camstep += 256*256*s1;
   memcpy(&s1, &buffer[4], 1);
   camstep += 256*s1;
   memcpy(&s1, &buffer[5], 1);
   camstep += s1;
   StepNrOutput->value(camstep+1);
   if (RecMotionBtn->value() > 0)
      TimeOutput->value(double(0.004*camstep));
   else
      TimeOutput->value(0.000);
   if ((mainAnimation->num_steps == 0)||(trajOk > 0))
   {
      for (i=0; i<(numCams/3); i++)
      {
         mainAnimation->click[i].insertSpace(mainAnimation->num_steps, 1);
         mainAnimation->click[i].set1Value(mainAnimation->num_steps, 0);
      }
      mainAnimation->num_steps++;
      mainAnimation->animation_step = mainAnimation->num_steps-1;
      StepSlider->maximum(mainAnimation->num_steps);
   }
   for (j=0; j<numCams; j++)
   {
       for (i=0; i<18; i++)
       {
          if ((j%3)==0)
          {
             xyz[i].setValue(-120.0, -120.0, -120.0);
             intens[i].setValue(0.0, 0.0, 0.0);
          }
          memcpy(&s1, &buffer[(j*62)+(i*2)+8], 1);
          memcpy(&s2, &buffer[(j*62)+(i*2)+9], 1);
          if ((s1>0)||(s2>0))
          {
             xyz[i][j%3] = 256.0*s1;	//new mapping
             xyz[i][j%3] += s2;
             xyz[i][j%3] /= 200.0;
			 xyz[i][j%3] -= 163.840;
//             xyz[i][j%3] /= 320.0;	//old mapping
//             xyz[i][j%3] -= 102.4;

          }
          if ((firstValues == 0)||(trajOk > 0))
             if ((j%3)==0)
             {
                mainAnimation->led[((j/3)*18)+i].insertSpace(mainAnimation->num_steps-1, 1);
                mainAnimation->intensity[((j/3)*18)+i].insertSpace(mainAnimation->num_steps-1, 1);
             }
          memcpy(&s1, &buffer[(j*62)+i+44], 1);
          intens[i][j%3] = float(s1);
       }
       if (firstValues == 0)
          firstValues++;
       if ((j%3)==2)
       {
          for (i=0; i<18; i++)
          {
             mainAnimation->led[((j/3)*18)+i].set1Value(mainAnimation->num_steps-1, xyz[i]);
             mainAnimation->intensity[((j/3)*18)+i].set1Value(mainAnimation->num_steps-1, intens[i]);
          }
       }
   }
   if ((trajOk > 0)&&(mainAnimation->animation_step>0))
   {
      mainAnimation->calc_animationTrafo(mainAnimation->animation_step-1);
      calcTrajValues();
   }
   if (mainAnimation != NULL)
      applyMotion(0);
   else
      objview->redraw();
}

//RecMotionBtn->value(0);
delete[] buffer;
}

void OPTISGui::getLEDCharValues(int camsysnr) {
  int i;

LedCharSpeedFrequency->value(mainAnimation->Speed[camsysnr]-1);//set value as speed[camsysnr]-1
switch (mainAnimation->Speed[camsysnr])
{
   case 1: F200Hz->do_callback(LedCharSpeedFrequency); break;
   case 2: F400Hz->do_callback(LedCharSpeedFrequency); break;
   case 3: F600Hz->do_callback(LedCharSpeedFrequency); break;
}
for (i=0; i<18; i++)//each LEDs
{
   LEDGroupsBtn[i][mainAnimation->LEDofObject[camsysnr][i]]->setonly();//Run Setonly()?
}
for (i=0; i<6; i++)//Each Object
{
   ObjGroupsBtn[i][mainAnimation->ObjectsAndReferences[camsysnr][i]+1]->setonly();//Run Setonly()
}
}

void OPTISGui::setLEDCharValues(int camsysnr) {
  int i, j;

mainAnimation->Speed[camsysnr] = LedCharSpeedFrequency->value()+1;//set mainAnimation->Speed[camsysnr] value
for (i=0; i<18; i++)//each leds
{
   j = 0;
   while ((j<7) && (LEDGroupsBtn[i][j]->value()==0))
      j++;
   mainAnimation->LEDofObject[camsysnr][i] = j;
}
for (i=0; i<6; i++)//each Object groups
{
   j = 0;
   while ((j<8) && (ObjGroupsBtn[i][j]->value()==0))
      j++;
   mainAnimation->ObjectsAndReferences[camsysnr][i] = j-1;
}
}

//select the comment from comment list
void OPTISGui::setCommentList() {
   int val, i,nlist;
   char st[50][256];
   char st2[256];
   Commentlist::cdata *d;

   val = MvmNameList->value();
//   printf("select %d\n",val );

   d = comList->clist;
i=0;
while(d != NULL)
{
   sprintf(st[d->ctype],d->cname);
   d = d->next;
}
nlist=i;
//   for (i=0; i<nlist; i++)printf("select st[%d] %s\n",i,st[i] );
   sprintf(st2,"%s  %s",st[val],scnfile->anatomy);
   MvmNameWinInput->value(st2);
}

//edit 6/12/2013
inline void OPTISGui::cb_MIPT_i(Fl_Menu_*, void*) 
{
	
 SbVec3d  mipt_xyz[20];
 SbVec3f  cal_mipt;
 ObjectData *tmpdata;
 char     st[256];
 int      mipt_x,mipt_y,mipt_z;
 int      i;
 
 tmpdata = objview->objlist;
 
  for (i=0; i<18; i++)
   {
		mipt_xyz[i][0] = mainAnimation->led[i][mainAnimation->animation_step][0];
		mipt_xyz[i][1] = mainAnimation->led[i][mainAnimation->animation_step][1];
		mipt_xyz[i][2] = mainAnimation->led[i][mainAnimation->animation_step][2];
	}


 //9/12/2013 insert calculation

	mipt_x = mipt_xyz[11][0]+50;
	mipt_y = mipt_xyz[11][1]+50;
	mipt_z = mipt_xyz[11][2]+50;

cal_mipt.setValue(mipt_x, mipt_y, mipt_z);
sprintf(st, "point of MIPT");
objview->addSphereObject(&st[0], &cal_mipt, 1, ledRadius, 0);

}
void OPTISGui::cb_MIPT(Fl_Menu_*o,void*v)
{
((OPTISGui*)(o->parent()->user_data()))->cb_MIPT_i(o,v);

}

inline void OPTISGui::cb_MIPTcancel_i(Fl_Menu_*, void*) 
{

//MIPT->clear();
	  
}
void OPTISGui::cb_MIPTcancel(Fl_Menu_*o,void*v)
{
((OPTISGui*)(o->parent()->user_data()))->cb_MIPTcancel_i(o,v);

}